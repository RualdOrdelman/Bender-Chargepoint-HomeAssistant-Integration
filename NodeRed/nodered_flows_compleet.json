[
    {
        "id": "55ef285a.65b2e8",
        "type": "tab",
        "label": "Diversen",
        "disabled": false,
        "info": ""
    },
    {
        "id": "84508fc8bf21c887",
        "type": "tab",
        "label": "Tijdsturingen",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "7bcc6d4e.82fd54",
        "type": "tab",
        "label": "Verlichting",
        "disabled": false,
        "info": ""
    },
    {
        "id": "ed1a56d03b99dd33",
        "type": "tab",
        "label": "Fijnstofmeter",
        "disabled": false,
        "info": ""
    },
    {
        "id": "479a460dbe395935",
        "type": "tab",
        "label": "Laadpaal",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "bdc3be9b91e2310d",
        "type": "tab",
        "label": "Laadpaal nieuw",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "cde6a70ee5ce073d",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "900dac71a5028dca",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a099d47fc07b3cee",
        "type": "tab",
        "label": "Home Battery Start",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "0199f18df097aa8f",
        "type": "tab",
        "label": "Strategy Timed",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c1a9925591b564a7",
        "type": "tab",
        "label": "Strategy Self-consumption",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "676ceac4c521834d",
        "type": "tab",
        "label": "Strategy Charge PV",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "95489b12daee74f5",
        "type": "tab",
        "label": "Strategy Dynamic",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "517b5f5313a242c5",
        "type": "tab",
        "label": "Strategy Charge",
        "disabled": false,
        "info": "Charges batteries to desired energy level\r\nregardless of available PV/Grid power mix.",
        "env": []
    },
    {
        "id": "98fc68ae4f398f5a",
        "type": "tab",
        "label": "Strategy Full stop ",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3e8b06dc3730a647",
        "type": "tab",
        "label": "Solcast Forecast Combine",
        "disabled": true,
        "info": ""
    },
    {
        "id": "c1eebc49aa0331b9",
        "type": "tab",
        "label": "Stroomprijzen naar DB",
        "disabled": true,
        "info": ""
    },
    {
        "id": "a28e37027e3020f1",
        "type": "tab",
        "label": "Battery RTE calc",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "fe8fcf9c18073d0e",
        "type": "tab",
        "label": "Batterijen",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "1c8e7eb7.95b3d1",
        "type": "subflow",
        "name": "Verlichting met bewegingdetectie en IsDonker check",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 100,
                "wires": [
                    {
                        "id": "696e7b6b.7e0ce4"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 580,
                "y": 40,
                "wires": [
                    {
                        "id": "7afac23d.86bf5c",
                        "port": 0
                    }
                ]
            },
            {
                "x": 580,
                "y": 80,
                "wires": [
                    {
                        "id": "7afac23d.86bf5c",
                        "port": 1
                    }
                ]
            },
            {
                "x": 580,
                "y": 140,
                "wires": [
                    {
                        "id": "8703397c.5c45d8",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "7350c3162edcd56a",
        "type": "subflow",
        "name": "Subflow 1",
        "info": "",
        "in": [],
        "out": []
    },
    {
        "id": "subflow_chargingLimiter",
        "type": "subflow",
        "name": "Charging Limiter",
        "info": "Limits charging power based on SoC, max_power and limiter flag.\nInputs:\n- msg.soc (number)\n- msg.max_power (number)\n- msg.hasChargingLimiter (boolean)\n\nOutput:\n- msg.payload (limited charging power)",
        "category": "",
        "in": [
            {
                "x": 220,
                "y": 220,
                "wires": [
                    {
                        "id": "fn_chargingLimiter"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 640,
                "y": 220,
                "wires": [
                    {
                        "id": "fn_chargingLimiter",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "68eef99d638abad4",
        "type": "subflow",
        "name": "Charging Limiter (1)",
        "info": "Limits charging power based on SoC, max_power and limiter flag.\nInputs:\n- msg.soc (number)\n- msg.max_power (number)\n- msg.hasChargingLimiter (boolean)\n\nOutput:\n- msg.payload (limited charging power)",
        "in": [
            {
                "x": 80,
                "y": 100,
                "wires": [
                    {
                        "id": "dff5933fc85a12a5"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 580,
                "y": 100,
                "wires": [
                    {
                        "id": "dff5933fc85a12a5",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "95ba375d876930b7",
        "type": "subflow",
        "name": "Charging Limiter (2)",
        "info": "Limits charging power based on SoC, max_power and limiter flag.\nInputs:\n- msg.soc (number)\n- msg.max_power (number)\n- msg.hasChargingLimiter (boolean)\n\nOutput:\n- msg.payload (limited charging power)",
        "in": [
            {
                "x": 80,
                "y": 100,
                "wires": [
                    {
                        "id": "3c30f3a41b7608c5"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 580,
                "y": 100,
                "wires": [
                    {
                        "id": "3c30f3a41b7608c5",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "af80d4df5496b0f7",
        "type": "group",
        "z": "fe8fcf9c18073d0e",
        "name": "Volstanden logica",
        "style": {
            "label": true
        },
        "nodes": [
            "7c94d0e18cca4669",
            "0ddff1329702ece1",
            "3d59163f019584e3",
            "bf356045a9208b67",
            "99c2efc98f33e8db",
            "01bb68a49e2ec749",
            "af103877d19a6639",
            "4737ee25acea25a8",
            "6adf021365c04dd0",
            "5b00966a1554593d",
            "f48f6a2dd2f9c8e0"
        ],
        "x": 794,
        "y": 679,
        "w": 812,
        "h": 349.5
    },
    {
        "id": "257a562828a46071",
        "type": "group",
        "z": "fe8fcf9c18073d0e",
        "name": "Oude werkwijze met oude meter",
        "style": {
            "label": true
        },
        "nodes": [
            "384d1cc527257f47",
            "890a96920af85269",
            "7a205b598d342a51"
        ],
        "x": 734,
        "y": 139,
        "w": 832,
        "h": 82
    },
    {
        "id": "d8201df108b3cdbd",
        "type": "group",
        "z": "fe8fcf9c18073d0e",
        "name": "Nieuwe meter incl vertraging, met ESPlink. Niet meer nodig, want DSMR sensor met HA is ook snel genoeg",
        "style": {
            "label": true
        },
        "nodes": [
            "a1",
            "a2",
            "0d5416494aa26bd2",
            "497c690c39721f88",
            "6a0832297f4cbc08"
        ],
        "x": 734,
        "y": 19,
        "w": 1052,
        "h": 142
    },
    {
        "id": "854980688e5a33a2",
        "type": "group",
        "z": "98fc68ae4f398f5a",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "1c8192c80293e27a",
            "1d8b882bd517ebe4"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "a5b4b50f7d24dc91",
        "type": "group",
        "z": "98fc68ae4f398f5a",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "50211caba9c825b8",
            "330c46043b601d46"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "e44a5d4c33f3cab1",
        "type": "group",
        "z": "900dac71a5028dca",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "4ea9a477ecf0c446",
            "25b5a08a5bf89ac0",
            "8feaf80456317a3e",
            "570ba6efb8eb8dc7",
            "f91f14aa5a48bda6",
            "6ef258c42572df05",
            "54fa9aa06d0d9224"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "6e9aacb3a9cdce9f",
        "type": "group",
        "z": "cde6a70ee5ce073d",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "a2cd2ee1cd619a47",
            "e81253b4c472274f",
            "973fc897a307f758",
            "ee76947a58cc2a1b",
            "aba81b5451d5f715"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "9889d591bcc38e89",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "87be4b85f89829b6",
            "d62d870eb44d3582"
        ],
        "x": 624,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "72059e541379a869",
        "type": "group",
        "z": "676ceac4c521834d",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "a5e9e484430e1720",
            "bf548077ba6ca350"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "e2c385d3b03e57bc",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "7a0cd93e9df76c48",
            "a56daa760b9feeb1"
        ],
        "x": 74,
        "y": 79,
        "w": 192,
        "h": 122
    },
    {
        "id": "419f0c8ca2d0601a",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "67116260f2e09362",
            "999fa888c5e5e56b",
            "fb0eeeb7ddf70b28"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "3be8354628cecb12",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "2b06415ad41aae3a",
            "957baac6682de3d3",
            "40290752a7c02655",
            "6273b550e193d38b"
        ],
        "x": 1614,
        "y": 159,
        "w": 252,
        "h": 242
    },
    {
        "id": "94b7ae0409093e17",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "787d4a4302cc3783",
            "58b3c35be6a1ea9c",
            "5a05ae43285d5398",
            "eca69e12794c1c0b",
            "f5e5091687ccc093",
            "cfc64f84a4532120",
            "8a50bc3d63d7a248",
            "a414c1013e9b72aa",
            "9f357837ab8c534f",
            "fae5e93e1a95d5ed",
            "0d36f7d78102ff6d",
            "8439426a432c3f9c"
        ],
        "x": 1614,
        "y": 419,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "7ab490ceca7cff35",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Load distribution debug option",
        "style": {
            "label": true
        },
        "nodes": [
            "7ca8801a84b11ae8",
            "95f5050249137fbc",
            "6a1707cb3cef46f2"
        ],
        "x": 1614,
        "y": 19,
        "w": 452,
        "h": 122
    },
    {
        "id": "81135409fdd98a36",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "d3eeef5879f195b1",
            "54cf41d4c27eeebe"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "83d2c9113c9411c2",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#7f7f7f"
        },
        "nodes": [
            "086689c5c8bba4b6",
            "991409971787deec",
            "1fadb46f18a01ebe"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "2884d4b5e34912da",
        "type": "group",
        "z": "c1a9925591b564a7",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "21c8ea25ac313948",
            "7242528b056e3c47"
        ],
        "x": 278,
        "y": 593,
        "w": 934,
        "h": 654
    },
    {
        "id": "1df1a3a3dcbc7925",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "62fe191e903de8b2",
            "3c519efd38a22bf5"
        ],
        "x": 34,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "843e88284fbc94bf",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "b5bd859bd4a37c5a",
            "9e4f8a5401e67f74"
        ],
        "x": 34,
        "y": 399,
        "w": 192,
        "h": 142
    },
    {
        "id": "9e0b88ccf18279a0",
        "type": "group",
        "z": "517b5f5313a242c5",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "975b518a9af0ba5e",
            "17407e109402eedb",
            "8f45bbf25d832781"
        ],
        "x": 264,
        "y": 119,
        "w": 742,
        "h": 82
    },
    {
        "id": "38d625c4fd161b7b",
        "type": "group",
        "z": "517b5f5313a242c5",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "6f08540f9f5fe765",
            "59946b67fc40e542",
            "ded0c5838fefe02a",
            "55e38b7af412c9b6",
            "9e65fbe7fb9407f5",
            "91b6cdbd01cd0f32",
            "5e0b433df0b89085",
            "e0daa87d53914f89",
            "8f3f500f37b1f30a",
            "11a3c17551b6872e",
            "558a963fa8d37e13"
        ],
        "x": 254,
        "y": 219,
        "w": 1152,
        "h": 162
    },
    {
        "id": "69b5b1e8def42772",
        "type": "group",
        "z": "517b5f5313a242c5",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true
        },
        "nodes": [
            "51c020c73fa6193c",
            "5145f9dafdea029b",
            "a46cfe2ab1e217ad"
        ],
        "x": 254,
        "y": 19,
        "w": 672,
        "h": 82
    },
    {
        "id": "7d5d20208cad641e",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "9ce9ba35eda99c46",
            "f0ecfb0d25bf1e0f"
        ],
        "x": 24,
        "y": 739,
        "w": 192,
        "h": 142
    },
    {
        "id": "130c2473c32bd786",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "e2fbefe0a92c8b87",
            "df3ea4464fdd6253"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "bf29fe0ee25b592b",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "942bbcc0b79ffec6",
            "84cab4abb90d1f7a",
            "dfa151f727d68ad2"
        ],
        "x": 444,
        "y": 79,
        "w": 542,
        "h": 82
    },
    {
        "id": "f9db7587adf69bfa",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "97a70bb440ca8984",
            "d82f98b7e93d3eac",
            "78f0fd728bec341e",
            "cb3cb1afa5ceda3d"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "115c88f19a6e3add",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "c669dabc5fa09ae2"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "263441dd7d34de1c",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "8eaa8fd948be1fad",
            "8de067121fbfd939",
            "3108d0a11fcf542f",
            "7bc56c05b65b8a56",
            "9353d27b9ba49389",
            "3c647acc433c766d",
            "3919eb10fa97d04d",
            "98697d12039611bf",
            "c7b14890ae2578d1",
            "83a1051adc959e8c",
            "30c98e7546f78b88",
            "0cde47a17becc07d",
            "5518e5a61cfe69c6",
            "7775e04676756c1e",
            "cd148224059fdaae",
            "319d772dc1a3f413",
            "7d3b97b9302eaf46",
            "8a7f41b1448ba249",
            "1ac5564bbb7c6d7f",
            "273d6cb45a191bcc",
            "90f20fce6d8576ce"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "635af4e3e7a252ce",
        "type": "group",
        "z": "0199f18df097aa8f",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "31b352bcf0b5fa22",
            "1ff8dd8a7bb8c098",
            "f89183be5ef546c8",
            "4a78e8501fe52d32"
        ],
        "x": 994,
        "y": 599,
        "w": 452,
        "h": 202
    },
    {
        "id": "e0ed6822bd47bca9",
        "type": "group",
        "z": "0199f18df097aa8f",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "568d79926c754129",
            "c5ad0abaf680c75b",
            "7d02914f2aaf8cda",
            "83e9ba4b673403f7"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "fc3b0636793881be",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "1d0932b9cdfe2cc0",
            "057b9222c17d4046",
            "b5940f2c8939de70",
            "981ff4f5a93db632",
            "bcecc2d9b0fe6cad",
            "390fa8a10c0e531f",
            "344e5a3dc0efb2f4"
        ],
        "x": 34,
        "y": 19,
        "w": 992,
        "h": 122
    },
    {
        "id": "a5b8a03b1e2f2371",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "e63433bdfbdd57e9",
            "06dd855a34065b5d",
            "d1bd5fbe28bdd070",
            "b658a34d31bcd8f3",
            "712cd7b2343eead6",
            "7f303dfb944dfc04",
            "b0cd2895e3545c27"
        ],
        "x": 34,
        "y": 619,
        "w": 812,
        "h": 162
    },
    {
        "id": "6fad59f7a8530963",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "dbe474c91266b428",
            "7d6705c1829e0683",
            "1933f2623fa0fffb",
            "ceb31920f185d64b",
            "b63f2e905b829e5b",
            "64a533741de02153",
            "bbe037f4bc3425fc",
            "023bfc9b8ac21db1"
        ],
        "x": 28,
        "y": 159,
        "w": 1664,
        "h": 242
    },
    {
        "id": "ea78c084bba20424",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "On start",
        "style": {
            "label": true
        },
        "nodes": [
            "ad80dc99baec6552",
            "42d70237afb8b3a7"
        ],
        "x": 1074,
        "y": 19,
        "w": 412,
        "h": 82
    },
    {
        "id": "5778369e644d84d7",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "95295516124d818d",
            "4d6fd96944872ba1",
            "15830b9747f8132e",
            "d77f3b233b9d9a45",
            "8b0aa863bb6493fd",
            "77163ca9f43e8fb7"
        ],
        "x": 24,
        "y": 799,
        "w": 848,
        "h": 342
    },
    {
        "id": "0a3ea32230e8832c",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "db8e14c359673211",
            "b98d8b6d56dc5e39",
            "9f9dd1b6c8a68339",
            "1cc51c4bd0523e93",
            "1c419030271bee64",
            "c9b6b8b729161188",
            "64c9954af597093d",
            "1dac3194a67aeec2",
            "641cc1cf21ace75a"
        ],
        "x": 34,
        "y": 519,
        "w": 1852,
        "h": 82
    },
    {
        "id": "c1e44a160c59f1a9",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "0be9d3b9ef3576fd"
        ],
        "x": 34,
        "y": 419,
        "w": 212,
        "h": 82
    },
    {
        "id": "ff30c86c22bf31c8",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "45ca4e9b170ae0e4",
            "c855da432b5a589a"
        ],
        "x": 14,
        "y": 239,
        "w": 192,
        "h": 142
    },
    {
        "id": "ee5f9b06bf7efa46",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "2c4ec860ab1a8f79",
            "471fda4979e7fc76"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "9c68fafd28d3b4fc",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Set dynamic strategy on",
        "style": {
            "label": true
        },
        "nodes": [
            "adbbd358b213f08e",
            "2e5b6b44c86f80e3",
            "0799b280bf62758e",
            "5cb60087e09c8852",
            "34a30e529baf678b",
            "1908addf7c5bfb93",
            "89368e429aa3d7d0",
            "e83d728f6cf5d437",
            "dc266592c79676c7",
            "ea704e53eb20315f",
            "c0fe420fa716d4ca",
            "1990213302cf1876",
            "98d7f59f0b7eab92",
            "de24e0e941d08b62",
            "5534a44cf66a84bd",
            "1d49e10959ab22bc",
            "3d76aa4d40d9ede2",
            "127bc4a04263b3c0",
            "7f75e4fa1c2d86a0",
            "f5f223200fbada06",
            "fedfd15cd6cddaed",
            "f65eeae181ccbc8a",
            "af541182589224a7",
            "da4428dd14db9967",
            "cba4fb540a66e4e6",
            "03f47a2f3212cb6b",
            "b97bd9a51080da68",
            "1247084c53315208",
            "4b8c5bc2b8cf6c4d",
            "6e287097dc4e0236",
            "403a9dfa33392328",
            "67e38494d0337403",
            "f1168e015522bbfc",
            "141ebe1a0441a814"
        ],
        "x": 234,
        "y": 279,
        "w": 1492,
        "h": 702
    },
    {
        "id": "70d1049fc896f1cd",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "ec06caa7c9e6a95d",
            "31e4a5e372bcb73f",
            "8cddc8961385f28e",
            "81b460c063969182",
            "e5f74756a260df5b",
            "c38ec0f354fd0ff8",
            "16efd2b03d6dece5"
        ],
        "x": 234,
        "y": 59,
        "w": 832,
        "h": 182
    },
    {
        "id": "c6507e8b14c27c81",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "92e35d100ca61070",
            "6e2f9d4be7e18c3a",
            "30af788462a325c7",
            "d05798a95b8cf195",
            "04d57a78a2fc3095",
            "320df01bc7436680",
            "d8004c43e9b3d8d0",
            "99545071b9bdfd66"
        ],
        "x": 234,
        "y": 1019,
        "w": 912,
        "h": 162
    },
    {
        "id": "1237795be79af24c",
        "type": "group",
        "z": "95489b12daee74f5",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "1f3454b85f32ab4c",
            "338407c8c442244c",
            "3f94e4f380add2e8",
            "079e2531ed154c01"
        ],
        "x": 234,
        "y": 1219,
        "w": 572,
        "h": 82
    },
    {
        "id": "d128f845d0543734",
        "type": "group",
        "z": "bdc3be9b91e2310d",
        "name": "ChargePV. Opladen met alleen zonnestroom.",
        "style": {
            "label": true
        },
        "nodes": [],
        "x": 250,
        "y": 570,
        "w": 288,
        "h": 40
    },
    {
        "id": "802b8b7a786b4690",
        "type": "group",
        "z": "bdc3be9b91e2310d",
        "name": "Dynamic. Opladen met laagste prijzen van dynamische stroom.",
        "style": {
            "label": true
        },
        "nodes": [],
        "x": 250,
        "y": 630,
        "w": 403,
        "h": 40
    },
    {
        "id": "97faf6073d1a061b",
        "type": "group",
        "z": "bdc3be9b91e2310d",
        "name": "Direct: nergens naar kijken, zo snel mogelijk en direct starten met laden",
        "style": {
            "label": true
        },
        "nodes": [],
        "x": 250,
        "y": 690,
        "w": 453,
        "h": 40
    },
    {
        "id": "aba81b5451d5f715",
        "type": "group",
        "z": "cde6a70ee5ce073d",
        "g": "6e9aacb3a9cdce9f",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "e30788a43ff718bf",
            "1b38ce1a57e2395c",
            "839e399dfbe88ab5",
            "944c212dcefed868",
            "1763cd8f763c0049",
            "71672cedcfdfca64"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "d3eeef5879f195b1",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "81135409fdd98a36",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "8baa774c2b027a30",
            "5aa64580ae12f4b2",
            "409b51e049035eb9",
            "526cad5fede1f966",
            "de5eedecc97994b4",
            "8591421549956ee1",
            "f6b196faaa1eff2f",
            "6286320aa2c67f78",
            "2244ab645dede1ed"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "54cf41d4c27eeebe",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "81135409fdd98a36",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "7e1e11d0eb34edae",
            "dde5b40cb7fe1ff8",
            "597ae0e8b54ce90b"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "086689c5c8bba4b6",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "8b9359ba6370a958",
            "affa3d29d06490e4",
            "d87e5fb7584a366b",
            "d8cf3fee789fa491"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "991409971787deec",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "de3671b9c7503ce3",
            "d2868e3da06e78d5",
            "6f0b3716cc693cd6",
            "e8409a2a051286bf",
            "5b44917d48154dea"
        ],
        "x": 604,
        "y": 399,
        "w": 762,
        "h": 142
    },
    {
        "id": "1fadb46f18a01ebe",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "83d2c9113c9411c2",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "9b70f054ec8bbbb1",
            "735046e00914a975",
            "7636353795317949"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "21c8ea25ac313948",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "2884d4b5e34912da",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "028f43a44d1bec69",
            "53039b668ab0a97e",
            "235494cc1d2a6b97",
            "5c62450063520ee9",
            "d6e0a13720d2ceb3",
            "9f823db632bbd13f",
            "ea8b44a09b499968",
            "d739d29aebbdb0e0",
            "bc8a24344b2ae2ca",
            "a79b2b6c56ce7751",
            "4854534dc7c83892",
            "7cdef29145623758",
            "4cafd473afb89158",
            "cbc863ac4c6ce1b8",
            "cfa0372c07314b8d",
            "e52abd366fd81c67",
            "0c60f5ca1f25e34b",
            "59bee8c6b6be159f",
            "526d83d6881fd8ce",
            "129ec2777a861d77"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "7242528b056e3c47",
        "type": "group",
        "z": "c1a9925591b564a7",
        "g": "2884d4b5e34912da",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "2ef3fc5bd6a33686",
            "3640364ae79b69ec"
        ],
        "x": 304,
        "y": 1119,
        "w": 472,
        "h": 102
    },
    {
        "id": "b63f2e905b829e5b",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "a91127871ba39241",
            "325f396f7e8ad2a8",
            "d01fc0ee854e249a",
            "f384e6c0da2834c8",
            "08d4efea54467ac1",
            "7831dd84510fdfaa",
            "4e53830356f33b07",
            "208060fed37273fc",
            "f3e427d4451be530",
            "a882514e64e6f538"
        ],
        "x": 54,
        "y": 239,
        "w": 1612,
        "h": 82
    },
    {
        "id": "d77f3b233b9d9a45",
        "type": "group",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "e1927196c4198cbf",
            "047542bb597a3048",
            "df4b99688f85df0a",
            "e25994f6e85e901c",
            "4decf8d91d6ccacb",
            "084ac27446297f16",
            "1e4f762143a12bba"
        ],
        "x": 294,
        "y": 839,
        "w": 552,
        "h": 222
    },
    {
        "id": "8591421549956ee1",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "6286320aa2c67f78"
            ]
        ]
    },
    {
        "id": "6286320aa2c67f78",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "f6b196faaa1eff2f",
                "2244ab645dede1ed"
            ]
        ]
    },
    {
        "id": "2244ab645dede1ed",
        "type": "junction",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "5aa64580ae12f4b2"
            ]
        ]
    },
    {
        "id": "25349ae9d88ba324",
        "type": "junction",
        "z": "517b5f5313a242c5",
        "x": 1240,
        "y": 460,
        "wires": [
            [
                "b5bd859bd4a37c5a"
            ]
        ]
    },
    {
        "id": "91b6cdbd01cd0f32",
        "type": "junction",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "x": 1100,
        "y": 260,
        "wires": [
            [
                "25349ae9d88ba324",
                "8f3f500f37b1f30a"
            ]
        ]
    },
    {
        "id": "b97bd9a51080da68",
        "type": "junction",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "x": 600,
        "y": 320,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "b9d10367867e38e6",
        "type": "server",
        "name": "Home Assistant",
        "version": 6,
        "addon": false,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": [
            "y",
            "yes",
            "true",
            "on",
            "home",
            "open"
        ],
        "connectionDelay": true,
        "cacheJson": true,
        "heartbeat": true,
        "heartbeatInterval": 30,
        "areaSelector": "friendlyName",
        "deviceSelector": "friendlyName",
        "entitySelector": "friendlyName",
        "statusSeparator": ": ",
        "statusYear": "hidden",
        "statusMonth": "short",
        "statusDay": "numeric",
        "statusHourCycle": "default",
        "statusTimeFormat": "h:m",
        "enableGlobalContextStore": false
    },
    {
        "id": "9e019c97.bc8ce",
        "type": "dutch-weather-conf",
        "lat": "52.204140",
        "lng": "6.011410"
    },
    {
        "id": "3ce70e1e.0c4192",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "0b9b65e4cc90bdc7",
        "type": "modbus-client",
        "name": "Alfen Laadpaal",
        "clienttype": "tcp",
        "bufferCommands": true,
        "stateLogEnabled": false,
        "queueLogEnabled": false,
        "failureLogEnabled": true,
        "tcpHost": "192.168.0.157",
        "tcpPort": 502,
        "tcpType": "DEFAULT",
        "serialPort": "/dev/ttyUSB",
        "serialType": "RTU-BUFFERD",
        "serialBaudrate": 9600,
        "serialDatabits": 8,
        "serialStopbits": 1,
        "serialParity": "none",
        "serialConnectionDelay": 100,
        "serialAsciiResponseStartDelimiter": "0x3A",
        "unit_id": 1,
        "commandDelay": 1,
        "clientTimeout": 1000,
        "reconnectOnTimeout": true,
        "reconnectTimeout": 2000,
        "parallelUnitIdsAllowed": true,
        "showErrors": false,
        "showWarnings": true,
        "showLogs": true
    },
    {
        "id": "7866ece42093366f",
        "type": "MySQLdatabase",
        "name": "wezel38_energie",
        "host": "192.168.1.60",
        "port": "3306",
        "db": "wezel38_energie",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "861bc7e17cb1390c",
        "type": "telegram bot",
        "botname": "Wezel38_bot",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "pollinterval": 300,
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": 6667,
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "0.0.0.0",
        "localbotport": 8443,
        "publicbotport": 8443,
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "696e7b6b.7e0ce4",
        "type": "switch",
        "z": "1c8e7eb7.95b3d1",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 200,
        "y": 100,
        "wires": [
            [
                "8703397c.5c45d8",
                "7afac23d.86bf5c"
            ],
            [
                "8703397c.5c45d8"
            ]
        ]
    },
    {
        "id": "8703397c.5c45d8",
        "type": "trigger",
        "z": "1c8e7eb7.95b3d1",
        "name": "Timeout",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "1",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "on",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 440,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "7afac23d.86bf5c",
        "type": "time-range-switch",
        "z": "1c8e7eb7.95b3d1",
        "name": "IsDonker",
        "lat": "52.19845",
        "lon": "5.99872",
        "startTime": "sunsetStart",
        "endTime": "sunrise",
        "startOffset": "-20",
        "endOffset": 0,
        "x": 440,
        "y": 80,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "fn_chargingLimiter",
        "type": "function",
        "z": "subflow_chargingLimiter",
        "name": "Apply chargingLimiter",
        "func": "// expects msg.soc, msg.max_power, msg.hasChargingLimiter\nlet soc = Number(msg.soc || 0);\nlet max_power = Number(msg.max_power || 0);\nlet hasChargingLimiter = (msg.hasChargingLimiter === true || msg.hasChargingLimiter === 1 || msg.hasChargingLimiter === \"true\");\n\nfunction chargingLimiter(soc, max_power, hasChargingLimiter) {\n    if (max_power < 0) max_power = 0;\n    if (!hasChargingLimiter) return max_power;\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\n\nmsg.payload = chargingLimiter(soc, max_power, hasChargingLimiter);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "dff5933fc85a12a5",
        "type": "function",
        "z": "68eef99d638abad4",
        "name": "Apply chargingLimiter",
        "func": "// expects msg.soc, msg.max_power, msg.hasChargingLimiter\nlet soc = Number(msg.soc || 0);\nlet max_power = Number(msg.max_power || 0);\nlet hasChargingLimiter = (msg.hasChargingLimiter === true || msg.hasChargingLimiter === 1 || msg.hasChargingLimiter === \"true\");\n\nfunction chargingLimiter(soc, max_power, hasChargingLimiter) {\n    if (max_power < 0) max_power = 0;\n    if (!hasChargingLimiter) return max_power;\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\n\nmsg.payload = chargingLimiter(soc, max_power, hasChargingLimiter);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 0,
        "y": 0,
        "wires": [
            []
        ]
    },
    {
        "id": "3c30f3a41b7608c5",
        "type": "function",
        "z": "95ba375d876930b7",
        "name": "Apply chargingLimiter",
        "func": "// expects msg.soc, msg.max_power, msg.hasChargingLimiter\nlet soc = Number(msg.soc || 0);\nlet max_power = Number(msg.max_power || 0);\nlet hasChargingLimiter = (msg.hasChargingLimiter === true || msg.hasChargingLimiter === 1 || msg.hasChargingLimiter === \"true\");\n\nfunction chargingLimiter(soc, max_power, hasChargingLimiter) {\n    if (max_power < 0) max_power = 0;\n    if (!hasChargingLimiter) return max_power;\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\n\nmsg.payload = chargingLimiter(soc, max_power, hasChargingLimiter);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 0,
        "y": 0,
        "wires": [
            []
        ]
    },
    {
        "id": "7b07f2ee.b905ac",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Fan Speed changed",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.wtw_fan_speed"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 170,
        "y": 360,
        "wires": [
            [
                "6909eda.7787714"
            ]
        ]
    },
    {
        "id": "6909eda.7787714",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Min",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Med",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Max",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 570,
        "y": 360,
        "wires": [
            [
                "4156d39b.3bfc0c"
            ],
            [
                "1dd0a171.88496f"
            ],
            [
                "af37724c.f41ef"
            ]
        ]
    },
    {
        "id": "4156d39b.3bfc0c",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand min",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.qubino_0_10v_dimmer_wtw"
        ],
        "labelId": [],
        "data": "{\"brightness\": 1 }",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 900,
        "y": 300,
        "wires": [
            [
                "d4ae9a07.94a7b8"
            ]
        ]
    },
    {
        "id": "1dd0a171.88496f",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand med",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.qubino_0_10v_dimmer_wtw"
        ],
        "labelId": [],
        "data": "{\"brightness\": 128 }",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 900,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "af37724c.f41ef",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand max",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.qubino_0_10v_dimmer_wtw"
        ],
        "labelId": [],
        "data": "{\"brightness\": 255 }",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 900,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "1e6e6d1a.450573",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.sonoff_temperature_sensor_badkamer_humidity"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 440,
        "y": 660,
        "wires": [
            [
                "317fb872.e19658"
            ]
        ]
    },
    {
        "id": "38458aa5.5c9186",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Current state Manuel mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.wtw_manual_modus",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 440,
        "y": 800,
        "wires": [
            [
                "317fb872.e19658"
            ]
        ]
    },
    {
        "id": "4c842bda.21ff04",
        "type": "inject",
        "z": "55ef285a.65b2e8",
        "name": "",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "",
        "payloadType": "str",
        "x": 230,
        "y": 800,
        "wires": [
            [
                "38458aa5.5c9186"
            ]
        ]
    },
    {
        "id": "317fb872.e19658",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "Vochtigheid >75",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "75",
                "vt": "num"
            },
            {
                "t": "gte",
                "v": "75",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 720,
        "y": 660,
        "wires": [
            [
                "4eb8f4ad.9d614c"
            ],
            [
                "8eac593f.b43e48"
            ]
        ]
    },
    {
        "id": "8eac593f.b43e48",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.wtw_manual_modus",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 980,
        "y": 700,
        "wires": [
            [
                "67d8b7ab.93c308"
            ]
        ]
    },
    {
        "id": "67d8b7ab.93c308",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1200,
        "y": 700,
        "wires": [
            [],
            [
                "c13ede13.9c6e3"
            ]
        ]
    },
    {
        "id": "c13ede13.9c6e3",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand max",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.wtw_fan_speed"
        ],
        "labelId": [],
        "data": "{\"option\":\"Max\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 1460,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "4eb8f4ad.9d614c",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.wtw_manual_modus",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 980,
        "y": 620,
        "wires": [
            [
                "58f25a3d.62cc74"
            ]
        ]
    },
    {
        "id": "58f25a3d.62cc74",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1200,
        "y": 620,
        "wires": [
            [],
            [
                "324f867d.85732a"
            ]
        ]
    },
    {
        "id": "eae8cc76.d703c",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Play MP3 op zolder",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "media_player.play_media",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "media_player.zolder"
        ],
        "labelId": [],
        "data": "{\"media_content_id\":\"http://ordelman.org/file_example_MP3_700KB.mp3\",\"media_content_type\":\"music\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "media_player",
        "service": "play_media",
        "x": 370,
        "y": 60,
        "wires": [
            [
                "27f74656.8dd19a"
            ]
        ]
    },
    {
        "id": "98978d70.09803",
        "type": "inject",
        "z": "55ef285a.65b2e8",
        "name": "",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "",
        "payloadType": "str",
        "x": 150,
        "y": 60,
        "wires": [
            [
                "eae8cc76.d703c"
            ]
        ]
    },
    {
        "id": "27f74656.8dd19a",
        "type": "debug",
        "z": "55ef285a.65b2e8",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 60,
        "wires": []
    },
    {
        "id": "d4ae9a07.94a7b8",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Notify WTW snelheid",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"WTW snelheid naar MIN. :\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1180,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "c8b39ce3.e9ca3",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Warmtepomp heating AUTO",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "luxtronik.write",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"parameter\":\"ID_Ba_Hz_akt\",\"value\":\"Automatic\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "luxtronik",
        "service": "write",
        "x": 1320,
        "y": 1420,
        "wires": [
            []
        ]
    },
    {
        "id": "d8ae3abd.8e0928",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Warmtepomp heating OFF",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "luxtronik.write",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"parameter\":\"ID_Ba_Hz_akt\",\"value\":\"Off\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "luxtronik",
        "service": "write",
        "x": 1320,
        "y": 1480,
        "wires": [
            []
        ]
    },
    {
        "id": "3dec44b5.dd00fc",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Heatpump Heat mode Toogle",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.toggle_heatpump_heating_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 300,
        "y": 1280,
        "wires": [
            [
                "9a854f34.6bd3"
            ]
        ]
    },
    {
        "id": "c9a8bda5.66eba",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Turn toggle mode Off",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.toggle",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.toggle_heatpump_heating_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "toggle",
        "x": 820,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "9a854f34.6bd3",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "Cooldown check to prevent deadloop",
        "func": "var lastChange = new Date(msg.data.old_state.last_changed).getTime();\nvar newChange = new Date(msg.data.new_state.last_changed).getTime();\nvar secs = Math.floor((newChange-lastChange) / 1000);\n\nmsg.sensor = {};\nmsg.sensor.secsbetweenlast = secs;\nmsg.sensor.cooldown = 1;\nif (secs > 3) { msg.sensor.cooldown = 0; }\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 450,
        "y": 1360,
        "wires": [
            [
                "63bb75c7.e994cc"
            ]
        ]
    },
    {
        "id": "63bb75c7.e994cc",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "In cooldown van vorige toggle?",
        "property": "sensor.cooldown",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 530,
        "y": 1260,
        "wires": [
            [
                "c9a8bda5.66eba",
                "9050c0b2.952d1"
            ],
            []
        ]
    },
    {
        "id": "9050c0b2.952d1",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Get actual WP heat mode value",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.id_ba_hz_akt",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 850,
        "y": 1460,
        "wires": [
            [
                "9c8b053d.fb4048"
            ]
        ]
    },
    {
        "id": "9c8b053d.fb4048",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "CurrentState",
        "property": "data.state",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Automatic",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1090,
        "y": 1460,
        "wires": [
            [
                "c8b39ce3.e9ca3"
            ],
            [
                "d8ae3abd.8e0928"
            ]
        ]
    },
    {
        "id": "736cde10.7983c",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Warmtepomp cooling AUTO",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "luxtronik.write",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"parameter\":\"ID_Einst_BA_Kuehl_akt\",\"value\":\"Automatic\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "luxtronik",
        "service": "write",
        "x": 1320,
        "y": 1800,
        "wires": [
            []
        ]
    },
    {
        "id": "89c4ac77.20946",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Warmtepomp cooling OFF",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "luxtronik.write",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"parameter\":\"ID_Einst_BA_Kuehl_akt\",\"value\":\"Off\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "luxtronik",
        "service": "write",
        "x": 1320,
        "y": 1860,
        "wires": [
            []
        ]
    },
    {
        "id": "336d0d94.569822",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Heatpump Cool mode Toogle",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.toggle_heatpump_cooling_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 300,
        "y": 1660,
        "wires": [
            [
                "49e777da.5b01d8"
            ]
        ]
    },
    {
        "id": "96585c5a.4ce96",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Turn toggle mode Off",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.toggle",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.toggle_heatpump_cooling_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "toggle",
        "x": 820,
        "y": 1780,
        "wires": [
            []
        ]
    },
    {
        "id": "49e777da.5b01d8",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "Cooldown check to prevent deadloop",
        "func": "var lastChange = new Date(msg.data.old_state.last_changed).getTime();\nvar newChange = new Date(msg.data.new_state.last_changed).getTime();\nvar secs = Math.floor((newChange-lastChange) / 1000);\n\nmsg.sensor = {};\nmsg.sensor.secsbetweenlast = secs;\nmsg.sensor.cooldown = 1;\nif (secs > 3) { msg.sensor.cooldown = 0; }\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 1740,
        "wires": [
            [
                "137f6d9a.6cd432"
            ]
        ]
    },
    {
        "id": "137f6d9a.6cd432",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "In cooldown van vorige toggle?",
        "property": "sensor.cooldown",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 530,
        "y": 1920,
        "wires": [
            [
                "96585c5a.4ce96",
                "a70fc5fb.88d618"
            ],
            []
        ]
    },
    {
        "id": "a70fc5fb.88d618",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Get actual WP cool mode value",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.id_einst_ba_kuehl_akt",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 850,
        "y": 1840,
        "wires": [
            [
                "230ecd2f.d96fe2"
            ]
        ]
    },
    {
        "id": "230ecd2f.d96fe2",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "CurrentState",
        "property": "data.state",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Automatic",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1090,
        "y": 1840,
        "wires": [
            [
                "736cde10.7983c"
            ],
            [
                "89c4ac77.20946"
            ]
        ]
    },
    {
        "id": "dc9b6624.d304f8",
        "type": "inject",
        "z": "55ef285a.65b2e8",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "on",
        "payloadType": "str",
        "x": 290,
        "y": 2080,
        "wires": [
            [
                "load_cam"
            ]
        ]
    },
    {
        "id": "b7758159.0539c",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Deurbel actie",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.doorbell_button_2"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 270,
        "y": 2180,
        "wires": [
            [
                "b5b48d55.644b3"
            ]
        ]
    },
    {
        "id": "b5b48d55.644b3",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 470,
        "y": 2180,
        "wires": [
            [
                "428510236c5707fd",
                "call_tts"
            ],
            []
        ]
    },
    {
        "id": "83945a7e.2c1ec8",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Play MP3 op zolder",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "media_player.play_media",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "media_player.zolder"
        ],
        "labelId": [],
        "data": "{\"media_content_id\":\"http://ordelman.org/Doorbell-sound-star-spangled-banner.mp3\",\"media_content_type\":\"music\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "media_player",
        "service": "play_media",
        "x": 690,
        "y": 2180,
        "wires": [
            [
                "5dc529ac.903c88"
            ]
        ]
    },
    {
        "id": "5dc529ac.903c88",
        "type": "debug",
        "z": "55ef285a.65b2e8",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 910,
        "y": 2180,
        "wires": []
    },
    {
        "id": "80366273fe3aba56",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Take snapshot",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "camera.snapshot",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "camera.camera_voordeur"
        ],
        "labelId": [],
        "data": "{\"filename\":\"/media/snapshot_camera_voordeur\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "camera",
        "service": "snapshot",
        "x": 680,
        "y": 2260,
        "wires": [
            [
                "8c308ce2d9f58722"
            ]
        ]
    },
    {
        "id": "9d16b7b1d8a8f9f6",
        "type": "delay",
        "z": "55ef285a.65b2e8",
        "name": "",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1110,
        "y": 2260,
        "wires": [
            [
                "a1190e4ba3b3da80"
            ]
        ]
    },
    {
        "id": "8c308ce2d9f58722",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "Clear MSG object",
        "func": "msg = {};\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 2260,
        "wires": [
            [
                "9d16b7b1d8a8f9f6"
            ]
        ]
    },
    {
        "id": "bbe82b21188ba893",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "sensor.shelly_temp_overloop_1e_verdie_temperature",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.shelly_temp_overloop_1e_verdie_temperature"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 580,
        "y": 2740,
        "wires": [
            [
                "1ef8e440dfa62706"
            ]
        ]
    },
    {
        "id": "4f66fd1eed659375",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "shelly_temp_zolderkamer_temperature",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.shelly_temp_zolderkamer_temperature"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 630,
        "y": 2900,
        "wires": [
            [
                "f6f9d35cdb26c760"
            ]
        ]
    },
    {
        "id": "5eef5301e28440d7",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.shelly_temp_overloop_1e_verdie_temperature",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 2700,
        "wires": [
            [
                "1ef8e440dfa62706"
            ]
        ]
    },
    {
        "id": "457fb1f891218a6f",
        "type": "inject",
        "z": "55ef285a.65b2e8",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "on",
        "payloadType": "str",
        "x": 210,
        "y": 2700,
        "wires": [
            [
                "5eef5301e28440d7"
            ]
        ]
    },
    {
        "id": "1ef8e440dfa62706",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "opened/closed",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "unavailable",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "unavailable",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 920,
        "y": 2740,
        "wires": [
            [],
            [
                "7005f868410ae340"
            ]
        ]
    },
    {
        "id": "3c3945fb9a32676f",
        "type": "debug",
        "z": "55ef285a.65b2e8",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1370,
        "y": 2740,
        "wires": []
    },
    {
        "id": "7005f868410ae340",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet value input number",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.temperatuur_overloop_1e_verdieping"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_number",
        "service": "set_value",
        "x": 1170,
        "y": 2740,
        "wires": [
            [
                "3c3945fb9a32676f"
            ]
        ]
    },
    {
        "id": "f69748fa54e8bdde",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.shelly_temp_zolderkamer_temperature",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 520,
        "y": 2860,
        "wires": [
            [
                "f6f9d35cdb26c760"
            ]
        ]
    },
    {
        "id": "f6f9d35cdb26c760",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "opened/closed",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "unavailable",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "unavailable",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 920,
        "y": 2900,
        "wires": [
            [],
            [
                "4297b2691e62f1f5"
            ]
        ]
    },
    {
        "id": "d5e0cf7df605729b",
        "type": "debug",
        "z": "55ef285a.65b2e8",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1370,
        "y": 2900,
        "wires": []
    },
    {
        "id": "4297b2691e62f1f5",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet value input number",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.temperatuur_zolderkamer_temperature"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_number",
        "service": "set_value",
        "x": 1170,
        "y": 2900,
        "wires": [
            [
                "d5e0cf7df605729b"
            ]
        ]
    },
    {
        "id": "a1190e4ba3b3da80",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Notify all IOS",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"Wezel38, Apeldoorn\",\"message\":\"Deurbel ingedrukt\",\"data\":{\"url\":\"/lovelace/9\",\"attachment\":\"content-type: jpeg\",\"push\":{\"category\":\"camera\"},\"entity_id\":\"camera.camera_voordeur\"}}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1310,
        "y": 2260,
        "wires": [
            []
        ]
    },
    {
        "id": "324f867d.85732a",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand med",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.wtw_fan_speed"
        ],
        "labelId": [],
        "data": "{\"option\":\"Med\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 1460,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "0e97d0fc595a9b2d",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Notify WTW snelheid",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"WTW snelheid naar MED. :\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1180,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "98d9dcf6a210caad",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Notify WTW snelheid",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"WTW snelheid naar MAX. :\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1180,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "35b792f4fe043746",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "CO2 woonkamer",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.awair_element_41519_carbon_dioxide"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "dataco2.co2woonkamer",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "x": 240,
        "y": 1020,
        "wires": [
            [
                "155f19b6e5907712"
            ]
        ]
    },
    {
        "id": "1940fb7f7cf50788",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.sonoff_temperature_sensor_badkamer_humidity"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "datavochtigheid.vochtigheid_badkamer",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "x": 280,
        "y": 1080,
        "wires": [
            [
                "e3a52c3ac8f871d9"
            ]
        ]
    },
    {
        "id": "e3a52c3ac8f871d9",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "CO2 woonkamer",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.awair_element_41519_carbon_dioxide",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "dataco2.co2woonkamer",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 550,
        "y": 1080,
        "wires": [
            [
                "0022d154f2fa29e0"
            ]
        ]
    },
    {
        "id": "155f19b6e5907712",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.sonoff_temperature_sensor_badkamer_humidity",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "datavochtigheid.vochtigheid_badkamer",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 580,
        "y": 1020,
        "wires": [
            [
                "0022d154f2fa29e0"
            ]
        ]
    },
    {
        "id": "0022d154f2fa29e0",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "WTW logica",
        "func": "\nif (msg.dataco2.co2woonkamer > 950)  \n{\n    msg.wtwaction = \"Max\"\n    node.status({ text: \"Max vanwege Co2 woonkamer\" });  \n    msg.wtw_statustext = \"Max vanwege Co2 woonkamer\"\n    //global.set(\"homeassistant.homeAssistant.states['input_test.wtw_statustext'].state\", \"AAA\");  \n}\nelse if (msg.datavochtigheid.vochtigheid_badkamer > 75) \n{\n    msg.wtwaction = \"Max\"\n    node.status({ text: \"Max vanwege badkamer vochtigheid\" });  \n    msg.wtw_statustext = \"Max vanwege badkamer vochtigheid\"\n    //global.set(\"homeassistant.homeAssistant.states['input_test.wtw_statustext'].state\", \"BBBB\");  \n}\nelse\n{\n    msg.wtwaction = \"Med\"\n    node.status({ text: \"Med want CO2 en vochtigheid laag\" });  \n    msg.wtw_statustext = \"Med want CO2 en vochtigheid laag\"\n    //global.set(\"homeassistant.homeAssistant.states['input_test.wtw_statustext'].state\", \"CCC\");  \n}\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1060,
        "wires": [
            [
                "ef36fb87299f2b81"
            ]
        ]
    },
    {
        "id": "ef36fb87299f2b81",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.wtw_manual_modus",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 1080,
        "y": 1060,
        "wires": [
            [
                "325ba87d3d9c41dc"
            ]
        ]
    },
    {
        "id": "325ba87d3d9c41dc",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "Manual mode?",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1300,
        "y": 1060,
        "wires": [
            [],
            [
                "c7e1a45215d85210"
            ]
        ]
    },
    {
        "id": "c7e1a45215d85210",
        "type": "switch",
        "z": "55ef285a.65b2e8",
        "name": "WTW to Min/Med/Max",
        "property": "wtwaction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Min",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Med",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Max",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1560,
        "y": 1080,
        "wires": [
            [
                "4bb48feb92937ba9"
            ],
            [
                "8347c2fd7c50c29c"
            ],
            [
                "aaefb68d11cde1db"
            ]
        ]
    },
    {
        "id": "aaefb68d11cde1db",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand max",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.wtw_fan_speed"
        ],
        "labelId": [],
        "data": "{\"option\":\"Max\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 1820,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "8347c2fd7c50c29c",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand med",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.wtw_fan_speed"
        ],
        "labelId": [],
        "data": "{\"option\":\"Med\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 1820,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "4bb48feb92937ba9",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Zet WTW stand min",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.wtw_fan_speed"
        ],
        "labelId": [],
        "data": "{\"option\":\"Min\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 1820,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "ee897186aeae7554",
        "type": "telegram sender",
        "z": "55ef285a.65b2e8",
        "name": "Wezel38_bot",
        "bot": "861bc7e17cb1390c",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1550,
        "y": 2120,
        "wires": [
            []
        ]
    },
    {
        "id": "8e0d80352bf4b5c2",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "MakeTelegramMessage",
        "func": "msg.payload = {\n    chatId: -547124130,           // Je chat of groeps-ID\n    type: \"photo\",\n    content: \"/data/testdata/snapshot_camera_voordeur\",  // Absoluut pad naar de foto\n    caption: \"Deurbel ingedrukt\"\n};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 2180,
        "wires": [
            [
                "ee897186aeae7554"
            ]
        ]
    },
    {
        "id": "428510236c5707fd",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "HA snapshot ophalen",
        "func": "msg.method = \"GET\";\nmsg.url = \"http://192.168.1.60:8123/api/camera_proxy/camera.camera_voordeur\";\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjYTNlZGQ5YTk2OGM0YjEyYjVjYWZmZmFiZjc1MTk3NyIsImlhdCI6MTc1MDk3NTYwMCwiZXhwIjoyMDY2MzM1NjAwfQ.uIEtvoLdf-WnXL_peVenQAYU-F6VKDkXs3BhtSuEM8s\"\n};\n\n\n// Laat de payload leeg; de HTTP node vult die later met het binaire bestand\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 2380,
        "wires": [
            [
                "2064409a7d627c73"
            ]
        ]
    },
    {
        "id": "f83a7d3c38870d2b",
        "type": "telegram sender",
        "z": "55ef285a.65b2e8",
        "name": "Stuur foto naar Telegram",
        "bot": "861bc7e17cb1390c",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1470,
        "y": 2380,
        "wires": [
            []
        ]
    },
    {
        "id": "373465c5f1c7d1c8",
        "type": "function",
        "z": "55ef285a.65b2e8",
        "name": "MakeTelegramMessage",
        "func": "msg.payload = {\n    chatId: -547124130,\n    type: \"photo\",\n    content: msg.payload,  // de binary buffer van de afbeelding\n    caption: \"Deurbel ingedrukt\"\n};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 2380,
        "wires": [
            [
                "f83a7d3c38870d2b"
            ]
        ]
    },
    {
        "id": "2064409a7d627c73",
        "type": "http request",
        "z": "55ef285a.65b2e8",
        "name": "HA snapshot ophalen",
        "method": "use",
        "ret": "bin",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 900,
        "y": 2380,
        "wires": [
            [
                "3c3945fb9a32676f",
                "373465c5f1c7d1c8"
            ]
        ]
    },
    {
        "id": "call_tts",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Notify Lenovo TTS",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.send_message",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "notify.lenovokeuken_text_to_speech"
        ],
        "labelId": [],
        "data": "{\t    \"title\": \"Wezel38, Apeldoorn\",\t    \"message\": \"Voordeur            deurbel ingedrukt\"\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": true,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "send_message",
        "x": 630,
        "y": 2440,
        "wires": [
            []
        ]
    },
    {
        "id": "load_cam",
        "type": "api-call-service",
        "z": "55ef285a.65b2e8",
        "name": "Fully  load_url",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "button.press",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "button.lenovokeuken_load_start_url"
        ],
        "labelId": [],
        "data": "{\"entity_id\":\"button.lenovokeuken_load_url\",\"url\":\"http://192.168.1.60:8123/lovelace/camera.camera_voordeur\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "button",
        "service": "press",
        "x": 620,
        "y": 2100,
        "wires": [
            []
        ]
    },
    {
        "id": "f7b5c92ed42fdfaf",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.sonoff_temperature_sensor_badkamer_humidity"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 440,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "0b588f3992f9409e",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "CO2 woonkamer",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.awair_element_41519_carbon_dioxide"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "dataco2.co2woonkamer",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 240,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "a5d275ec71e64647",
        "type": "server-state-changed",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.sonoff_temperature_sensor_badkamer_humidity"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "datavochtigheid.vochtigheid_badkamer",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 280,
        "y": 1120,
        "wires": [
            []
        ]
    },
    {
        "id": "2bb9174795dceeea",
        "type": "api-current-state",
        "z": "55ef285a.65b2e8",
        "name": "Badkamer luchtvochtigheid",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.sonoff_temperature_sensor_badkamer_humidity",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "datavochtigheid.vochtigheid_badkamer",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 580,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "09cf6bed440fed2b",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 280,
        "wires": [
            [
                "1ac514612bf47c5d",
                "0b9ea1474f15cfb6"
            ],
            [
                "97d69054ea7384c7"
            ]
        ]
    },
    {
        "id": "063c4c6a5c42b76f",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify koffiemachine aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"koffiemachine aan\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "mobile_app_iphone_12_ruald_new",
        "x": 710,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "4b26d2c256954bbe",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify koffiemachine uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"koffiemachine uit\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "mobile_app_iphone_12_ruald_new",
        "x": 710,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "0b9ea1474f15cfb6",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Koffiemachine voor aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.sylvia_koffiemachine"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 710,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "97d69054ea7384c7",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Koffiemachine voor uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.sylvia_koffiemachine"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 700,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "1ac514612bf47c5d",
        "type": "debug",
        "z": "84508fc8bf21c887",
        "name": "headercheck",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 630,
        "y": 120,
        "wires": []
    },
    {
        "id": "5d7175fd21ba7f93",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 470,
        "y": 660,
        "wires": [
            [
                "8348b02fffb8f878",
                "3bbe6bdb22e70d38"
            ],
            [
                "cb8f93aff3cd33d3",
                "fb02fbd8f1a3d2e1"
            ]
        ]
    },
    {
        "id": "8348b02fffb8f878",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify zwembadpomp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"zwembadpomp aan\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "mobile_app_iphone_12_ruald_new",
        "x": 740,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "fb02fbd8f1a3d2e1",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify zwembadpomp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"zwembadpomp uit\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "mobile_app_iphone_12_ruald_new",
        "x": 730,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "3bbe6bdb22e70d38",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Zwembadpomp voor aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tuin_zijkant_wcd"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 730,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "cb8f93aff3cd33d3",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Zwembadpomp voor uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tuin_zijkant_wcd"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 730,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "26e640505f300da1",
        "type": "debug",
        "z": "84508fc8bf21c887",
        "name": "headercheck",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 690,
        "y": 540,
        "wires": []
    },
    {
        "id": "9a0d888131060c59",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify TV Rik slaapkamer aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"TV Rik slaapkamer aan\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1290,
        "y": 1840,
        "wires": [
            []
        ]
    },
    {
        "id": "9cd71ba305e4b851",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "TV Rik slaapkamer aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tv_rikslaapkamer_2"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 1260,
        "y": 1900,
        "wires": [
            []
        ]
    },
    {
        "id": "dcc1bb609b58b02d",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify TV Rik slaapkamer uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"TV Rik slaapkamer uit\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1280,
        "y": 2040,
        "wires": [
            []
        ]
    },
    {
        "id": "261e4038a45168d1",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "TV Rik slaapkamer uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tv_rikslaapkamer_2"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 1260,
        "y": 2000,
        "wires": [
            []
        ]
    },
    {
        "id": "9a4cbd749118a9fc",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "on",
        "payloadType": "str",
        "x": 150,
        "y": 2040,
        "wires": [
            [
                "4dc929b04701336f"
            ]
        ]
    },
    {
        "id": "2dc2b31a65804caa",
        "type": "function",
        "z": "84508fc8bf21c887",
        "name": "Set up data",
        "func": "msg.eventtype = msg.payload;\nmsg.timersource = msg.tag;\n\nif (msg.eventtype == \"on\")\n{\n    msg.outputaction = \"on\"\n}\nelse if (msg.eventtype == \"off\")\n{\n    if (msg.timersource == \"vakantietimer\")\n    {\n        if (msg.vakantietijd == \"on\")\n        {\n            msg.outputaction = \"off\"\n        }\n        else if (msg.vakantietijd == \"off\")\n        {\n            //Do nothing when vakantietimer OFF goes outside \n            //holiday periods\n        }\n    }\n    else //maa-vrij-timer of zat-zon-timer\n    {\n        if (msg.vakantietijd == \"on\")\n        {\n            //Do nothing when vakantietimer ON\n        }\n        else if (msg.vakantietijd == \"off\")\n        {\n            msg.outputaction = \"off\"\n        }\n    }\n}\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 1960,
        "wires": [
            [
                "3ee00c3a46c38b3e",
                "237662ae88e150d9"
            ]
        ]
    },
    {
        "id": "2b820d45302551ae",
        "type": "api-current-state",
        "z": "84508fc8bf21c887",
        "name": "Vakantie?",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.toggle_vacantion_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "vakantietijd",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 640,
        "y": 1960,
        "wires": [
            [
                "2dc2b31a65804caa"
            ]
        ]
    },
    {
        "id": "237662ae88e150d9",
        "type": "debug",
        "z": "84508fc8bf21c887",
        "name": "headercheck",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 2080,
        "wires": []
    },
    {
        "id": "fdf7f47c97599503",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "off",
        "payload": "off",
        "payloadType": "str",
        "x": 150,
        "y": 2080,
        "wires": [
            [
                "4dc929b04701336f"
            ]
        ]
    },
    {
        "id": "c181f1bd34bad57b",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "off",
        "payload": "off",
        "payloadType": "str",
        "x": 150,
        "y": 1980,
        "wires": [
            [
                "0bfe0aa2537b0451"
            ]
        ]
    },
    {
        "id": "f779d9c7e962f5a1",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "on",
        "payloadType": "str",
        "x": 150,
        "y": 1940,
        "wires": [
            [
                "0bfe0aa2537b0451"
            ]
        ]
    },
    {
        "id": "a575b2a6b154b50e",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "on",
        "payloadType": "str",
        "x": 150,
        "y": 1840,
        "wires": [
            [
                "c2647ef056a4d0ef"
            ]
        ]
    },
    {
        "id": "44d1fb027f3b7f93",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "off",
        "payload": "off",
        "payloadType": "str",
        "x": 150,
        "y": 1880,
        "wires": [
            [
                "c2647ef056a4d0ef"
            ]
        ]
    },
    {
        "id": "3ee00c3a46c38b3e",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": "on/off",
        "property": "outputaction",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 990,
        "y": 1960,
        "wires": [
            [
                "9cd71ba305e4b851"
            ],
            [
                "261e4038a45168d1"
            ]
        ]
    },
    {
        "id": "906c1b3c48f21750",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "on",
        "payloadType": "str",
        "x": 170,
        "y": 2340,
        "wires": [
            [
                "5ab43e99bab09438"
            ]
        ]
    },
    {
        "id": "596ffc20e2d4726d",
        "type": "function",
        "z": "84508fc8bf21c887",
        "name": "Days ago",
        "func": "const apiDt = new Date(msg.payload)\nconst nowDt = new Date()\nconst diff  = nowDt - apiDt\n\n\n//msg.payload = {\n  ///  \"millisec\": diff,\n    //\"sec\": diff / 1000,\n    //\"minutes\": diff / (1000*60),\n    //\"hours\": diff / (1000*60*60),\n    //\"days\": diff / (1000*60*60*24),\n   // \"weeks\": diff / (1000*60*60*24*7)\n//}\n\nmsg.payload = diff / (1000*60*60*24)\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 2280,
        "wires": [
            [
                "b67231c3073d2b52"
            ]
        ]
    },
    {
        "id": "97c55928c081fd45",
        "type": "api-current-state",
        "z": "84508fc8bf21c887",
        "name": "WTW filters last cleaned",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.wtw_filters_cleaned",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 2280,
        "wires": [
            [
                "596ffc20e2d4726d"
            ]
        ]
    },
    {
        "id": "4c7da2a8d9c49efa",
        "type": "api-current-state",
        "z": "84508fc8bf21c887",
        "name": "WTW filters last replaced",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.wtw_filters_replaced",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 2420,
        "wires": [
            [
                "1c7e792d241362a6"
            ]
        ]
    },
    {
        "id": "b67231c3073d2b52",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": ">30 days",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "30",
                "vt": "num"
            },
            {
                "t": "lte",
                "v": "30",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 960,
        "y": 2280,
        "wires": [
            [
                "e3556e842871f668"
            ],
            []
        ]
    },
    {
        "id": "e3556e842871f668",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify WTW need to be cleaned",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"WTW filters moeten schoongemaakt worden\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1310,
        "y": 2280,
        "wires": [
            []
        ]
    },
    {
        "id": "1c7e792d241362a6",
        "type": "function",
        "z": "84508fc8bf21c887",
        "name": "Days ago",
        "func": "const apiDt = new Date(msg.payload)\nconst nowDt = new Date()\nconst diff  = nowDt - apiDt\n\n\n//msg.payload = {\n  ///  \"millisec\": diff,\n    //\"sec\": diff / 1000,\n    //\"minutes\": diff / (1000*60),\n    //\"hours\": diff / (1000*60*60),\n    //\"days\": diff / (1000*60*60*24),\n   // \"weeks\": diff / (1000*60*60*24*7)\n//}\n\nmsg.payload = diff / (1000*60*60*24)\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 2380,
        "wires": [
            [
                "cf1147276923d3de"
            ]
        ]
    },
    {
        "id": "cf1147276923d3de",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": ">182 days (half jaar)",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "182",
                "vt": "num"
            },
            {
                "t": "lte",
                "v": "182",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1000,
        "y": 2380,
        "wires": [
            [
                "640fcad336d6415b"
            ],
            []
        ]
    },
    {
        "id": "640fcad336d6415b",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify WTW need to be replaced",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"WTW filters moeten schoongemaakt worden\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 1320,
        "y": 2380,
        "wires": [
            []
        ]
    },
    {
        "id": "b090cbb5dfe084dd",
        "type": "inject",
        "z": "84508fc8bf21c887",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "off",
        "payloadType": "str",
        "x": 210,
        "y": 260,
        "wires": [
            [
                "09cf6bed440fed2b"
            ]
        ]
    },
    {
        "id": "86e55490.756638",
        "type": "switch",
        "z": "84508fc8bf21c887",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 1060,
        "wires": [
            [
                "d9fbdc25.a9103",
                "b4daaa2e.415a28",
                "d0b0878c.2028f8",
                "62a1961a.3b42a8",
                "2bae70f8.57761"
            ],
            [
                "ecf507d6.1e0418",
                "da21aa90.8c2ce8",
                "4680ff5d.97445",
                "e19bd3fc.d4216",
                "2f5e3c69.f11484"
            ]
        ]
    },
    {
        "id": "ecf507d6.1e0418",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Buitenlamp voor uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_buitenlampen_voor"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 690,
        "y": 1360,
        "wires": [
            []
        ]
    },
    {
        "id": "da21aa90.8c2ce8",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Buitenlamp rondom uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_buitenlampen_rondom"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 700,
        "y": 1420,
        "wires": [
            []
        ]
    },
    {
        "id": "d9fbdc25.a9103",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Buitenlamp rondom aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_buitenlampen_rondom"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 710,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "b4daaa2e.415a28",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Buitenlamp voor aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_buitenlampen_voor"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 700,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "d0b0878c.2028f8",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Tuinverlichting aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_buitenverlichting"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 690,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "4680ff5d.97445",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Tuinverlichting uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_buitenverlichting"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 690,
        "y": 1480,
        "wires": [
            []
        ]
    },
    {
        "id": "2bae70f8.57761",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Kerstboom buiten aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tuin_zijkant_wcd"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 700,
        "y": 1120,
        "wires": [
            []
        ]
    },
    {
        "id": "2f5e3c69.f11484",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Kerstboom buiten uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.shelly_plug_tuin_zijkant_wcd"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 700,
        "y": 1540,
        "wires": [
            []
        ]
    },
    {
        "id": "62a1961a.3b42a8",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify Buitenverlichting aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"Buitenverlichting aan\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 720,
        "y": 1180,
        "wires": [
            []
        ]
    },
    {
        "id": "e19bd3fc.d4216",
        "type": "api-call-service",
        "z": "84508fc8bf21c887",
        "name": "Notify Buitenverlichting uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "notify.notify",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"title\":\"Buitenverlichting uit\",\"message\":\"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "notify",
        "service": "notify",
        "x": 720,
        "y": 1600,
        "wires": [
            []
        ]
    },
    {
        "id": "635862dce77290e8",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Maa-vrij (07:10 - 8:30)",
        "debug": false,
        "autoname": "07:10 - 08:30",
        "tag": "eztimer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "07:10",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "08:30",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": true,
        "sat": false,
        "sun": false,
        "x": 200,
        "y": 200,
        "wires": [
            [
                "09cf6bed440fed2b"
            ]
        ]
    },
    {
        "id": "a1b54d80260ee0d9",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Zat-zon (07:30 - 09:00)",
        "debug": false,
        "autoname": "07:30 - 09:00",
        "tag": "eztimer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "07:30",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "09:00",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": false,
        "tue": false,
        "wed": false,
        "thu": false,
        "fri": false,
        "sat": true,
        "sun": true,
        "x": 240,
        "y": 320,
        "wires": [
            [
                "09cf6bed440fed2b"
            ]
        ]
    },
    {
        "id": "9ef071c9706c3be0",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Maa-Zon (09:30 - 13:30)",
        "debug": false,
        "autoname": "09:30 - 13:30",
        "tag": "eztimer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "09:30",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "13:30",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": true,
        "sat": true,
        "sun": true,
        "x": 250,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "c2647ef056a4d0ef",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Zon-Don (09:00 - 23:00)",
        "debug": false,
        "autoname": "09:00 - 23:00",
        "tag": "maa-vrij-timer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "09:00",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "23:00",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": false,
        "sat": false,
        "sun": true,
        "x": 370,
        "y": 1860,
        "wires": [
            [
                "2b820d45302551ae"
            ]
        ]
    },
    {
        "id": "0bfe0aa2537b0451",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Vrij-zat (09:00 - 23:45)",
        "debug": false,
        "autoname": "09:00 - 23:45",
        "tag": "zat-zon-timer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "09:00",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "23:45",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": false,
        "tue": false,
        "wed": false,
        "thu": false,
        "fri": true,
        "sat": true,
        "sun": false,
        "x": 360,
        "y": 1960,
        "wires": [
            [
                "2b820d45302551ae"
            ]
        ]
    },
    {
        "id": "4dc929b04701336f",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Vakantie (09:00 - 23:45)",
        "debug": false,
        "autoname": "09:00 - 23:45",
        "tag": "vakantietimer",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "1",
        "startupMessage": true,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "09:00",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "23:45",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": true,
        "sat": true,
        "sun": true,
        "x": 390,
        "y": 2060,
        "wires": [
            [
                "2b820d45302551ae"
            ]
        ]
    },
    {
        "id": "5ab43e99bab09438",
        "type": "eztimer",
        "z": "84508fc8bf21c887",
        "name": "Every workday (10:00)",
        "debug": false,
        "autoname": "10:00",
        "tag": "",
        "topic": "",
        "suspended": false,
        "sendEventsOnSuspend": false,
        "latLongSource": "manual",
        "latLongHaZone": "zone.home",
        "lat": "52.19845",
        "lon": "5.99872",
        "timerType": "2",
        "startupMessage": false,
        "ontype": "2",
        "ontimesun": "dawn",
        "ontimetod": "10:00",
        "onpropertytype": "msg",
        "onproperty": "payload",
        "onvaluetype": "str",
        "onvalue": "on",
        "onoffset": 0,
        "onrandomoffset": 0,
        "onsuppressrepeats": false,
        "offtype": "2",
        "offtimesun": "dusk",
        "offtimetod": "21:30",
        "offduration": "00:01:00",
        "offpropertytype": "msg",
        "offproperty": "payload",
        "offvaluetype": "str",
        "offvalue": "off",
        "offoffset": 0,
        "offrandomoffset": 0,
        "offsuppressrepeats": false,
        "resend": false,
        "resendInterval": "0s",
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": true,
        "sat": true,
        "sun": true,
        "x": 360,
        "y": 2460,
        "wires": [
            [
                "97c55928c081fd45",
                "4c7da2a8d9c49efa"
            ]
        ]
    },
    {
        "id": "f9d77d8d.d7e47",
        "type": "bigtimer",
        "z": "84508fc8bf21c887",
        "outtopic": "timer",
        "outpayload1": "on",
        "outpayload2": "off",
        "name": "Big Timer",
        "comment": "",
        "lat": "52.19845",
        "lon": "5.99872",
        "starttime": "5004",
        "endtime": "5003",
        "starttime2": 0,
        "endtime2": 0,
        "startoff": "-20",
        "endoff": 0,
        "startoff2": 0,
        "endoff2": 0,
        "offs": 0,
        "outtext1": "Start baxckup",
        "outtext2": "Stop backup",
        "timeout": 1440,
        "sun": true,
        "mon": true,
        "tue": true,
        "wed": true,
        "thu": true,
        "fri": true,
        "sat": true,
        "jan": true,
        "feb": true,
        "mar": true,
        "apr": true,
        "may": true,
        "jun": true,
        "jul": true,
        "aug": true,
        "sep": true,
        "oct": true,
        "nov": true,
        "dec": true,
        "day1": 0,
        "month1": 0,
        "day2": 0,
        "month2": 0,
        "day3": 0,
        "month3": 0,
        "day4": 0,
        "month4": 0,
        "day5": 0,
        "month5": 0,
        "day6": 0,
        "month6": 0,
        "day7": "",
        "month7": "",
        "day8": "",
        "month8": "",
        "day9": "",
        "month9": "",
        "day10": "",
        "month10": "",
        "day11": "",
        "month11": "",
        "day12": "",
        "month12": "",
        "d1": 0,
        "w1": 0,
        "d2": 0,
        "w2": 0,
        "d3": 0,
        "w3": 0,
        "d4": 0,
        "w4": 0,
        "d5": 0,
        "w5": 0,
        "d6": 0,
        "w6": 0,
        "xday1": 0,
        "xmonth1": 0,
        "xday2": 0,
        "xmonth2": 0,
        "xday3": 0,
        "xmonth3": 0,
        "xday4": 0,
        "xmonth4": 0,
        "xday5": 0,
        "xmonth5": 0,
        "xday6": 0,
        "xmonth6": 0,
        "xd1": 0,
        "xw1": 0,
        "xd2": 0,
        "xw2": 0,
        "xd3": 0,
        "xw3": 0,
        "xd4": 0,
        "xw4": 0,
        "xd5": 0,
        "xw5": 0,
        "xd6": 0,
        "xw6": 0,
        "suspend": false,
        "random": false,
        "randon1": false,
        "randoff1": false,
        "randon2": false,
        "randoff2": false,
        "repeat": false,
        "atstart": true,
        "odd": false,
        "even": false,
        "x": 240,
        "y": 1080,
        "wires": [
            [
                "86e55490.756638"
            ],
            [],
            []
        ]
    },
    {
        "id": "413a142b.227ecc",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Hal beneden",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_hal_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 110,
        "y": 180,
        "wires": [
            [
                "7d3e1ce.88100e4"
            ]
        ]
    },
    {
        "id": "4b3e364c.423618",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Hal lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_hal"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 840,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "23ee2429.d26c1c",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Hal lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_hal"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 840,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "e59e1f73.da161",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "WC beneden",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_wc_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 320,
        "wires": [
            [
                "85d441dd.5e5ae"
            ]
        ]
    },
    {
        "id": "d15105cf.30f688",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Wc lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_wc"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 850,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "1af932fd.ceb08d",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Wc lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_wc"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 850,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "f9004cc6.e5025",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_badkamer"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 1260,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "8442feb.a9ed2",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_badkamer"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 1250,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "66bdee78.b761c",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Berging",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_berging_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 130,
        "y": 460,
        "wires": [
            [
                "e47d3979.cac268"
            ]
        ]
    },
    {
        "id": "a47e83a.947758",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Berging lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_berging"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 860,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "a1f2d7b7.5ead38",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Berging lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_berging"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 850,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "5bf247d4.e0cbb8",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Bijkeuken",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_bijkeuken_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 140,
        "y": 640,
        "wires": [
            [
                "6edb4085cacda47e"
            ]
        ]
    },
    {
        "id": "622ac0b9.7ab7f",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Bijkeuken lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_bijkeuken"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 870,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "5a79005.71cd3",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Bijkeuken lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_bijkeuken"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 870,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "cf4de4ac.97e1c8",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Inloopkast",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_ouderslaapkamer_inloopkast_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 140,
        "y": 800,
        "wires": [
            [
                "cd44abb117fd924d"
            ]
        ]
    },
    {
        "id": "7eda5fbc.2ef39",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Inloopkast lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.fibaro_switch2_inloopkast"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_on",
        "x": 880,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "59a88182.11af5",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop sensor 1",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_overloop_1e_verdieping_1_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 170,
        "y": 1280,
        "wires": [
            [
                "6b7cfc55.36b804"
            ]
        ]
    },
    {
        "id": "6b7cfc55.36b804",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 370,
        "y": 1280,
        "wires": [
            [
                "a8332d99.a73eb",
                "2528dcbb.c96994"
            ],
            [
                "a8332d99.a73eb"
            ]
        ]
    },
    {
        "id": "b4f8230c.a3973",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_overloop_1e_verdieping"
        ],
        "labelId": [],
        "data": "{\"brightness_pct\": 50 }",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 1250,
        "y": 1280,
        "wires": [
            []
        ]
    },
    {
        "id": "d06c841f.fffcc8",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_overloop_1e_verdieping"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 1250,
        "y": 1340,
        "wires": [
            []
        ]
    },
    {
        "id": "a8332d99.a73eb",
        "type": "trigger",
        "z": "7bcc6d4e.82fd54",
        "name": "Timeout",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": true,
        "units": "s",
        "reset": "on",
        "bytopic": "all",
        "outputs": 1,
        "x": 590,
        "y": 1300,
        "wires": [
            [
                "22f5f27c.2f6f7e"
            ]
        ]
    },
    {
        "id": "1cd64122.6d377f",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop sensor 2",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_overloop_1e_verdieping_2_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 170,
        "y": 1400,
        "wires": [
            [
                "8ec791a6.fd5d5"
            ]
        ]
    },
    {
        "id": "8ec791a6.fd5d5",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 370,
        "y": 1400,
        "wires": [
            [
                "134753.754ae8ae",
                "555f23b7.c2052c"
            ],
            [
                "134753.754ae8ae"
            ]
        ]
    },
    {
        "id": "134753.754ae8ae",
        "type": "trigger",
        "z": "7bcc6d4e.82fd54",
        "name": "Timeout",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "10",
        "extend": true,
        "units": "s",
        "reset": "on",
        "bytopic": "all",
        "outputs": 1,
        "x": 590,
        "y": 1420,
        "wires": [
            [
                "24c910c2.21d25"
            ]
        ]
    },
    {
        "id": "22f5f27c.2f6f7e",
        "type": "api-current-state",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop sensor 2",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "binary_sensor.xiaomi_motion_sensor_overloop_1e_verdieping_2_occupancy",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 770,
        "y": 1300,
        "wires": [
            [
                "d6bd4dc4.7998e"
            ]
        ]
    },
    {
        "id": "d6bd4dc4.7998e",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1070,
        "y": 1340,
        "wires": [
            [],
            [
                "d06c841f.fffcc8"
            ]
        ]
    },
    {
        "id": "24c910c2.21d25",
        "type": "api-current-state",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop sensor 1",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "binary_sensor.xiaomi_motion_sensor_overloop_1e_verdieping_1_occupancy",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 770,
        "y": 1420,
        "wires": [
            [
                "d6bd4dc4.7998e"
            ]
        ]
    },
    {
        "id": "85d441dd.5e5ae",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 320,
        "wires": [
            [
                "d15105cf.30f688"
            ],
            [],
            [
                "1af932fd.ceb08d"
            ]
        ]
    },
    {
        "id": "e47d3979.cac268",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 460,
        "wires": [
            [
                "a47e83a.947758"
            ],
            [],
            [
                "a1f2d7b7.5ead38"
            ]
        ]
    },
    {
        "id": "7a5b8e30f7d54c99",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Inloopkast lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "switch.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "switch.fibaro_switch2_inloopkast"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "switch",
        "service": "turn_off",
        "x": 860,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "6edb4085cacda47e",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 640,
        "wires": [
            [
                "622ac0b9.7ab7f"
            ],
            [],
            [
                "5a79005.71cd3"
            ]
        ]
    },
    {
        "id": "cd44abb117fd924d",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 800,
        "wires": [
            [
                "7eda5fbc.2ef39"
            ],
            [],
            [
                "7a5b8e30f7d54c99"
            ]
        ]
    },
    {
        "id": "7d3e1ce.88100e4",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 180,
        "wires": [
            [
                "4b3e364c.423618"
            ],
            [],
            [
                "23ee2429.d26c1c"
            ]
        ]
    },
    {
        "id": "5228a964b8b6873c",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer sensor 1",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_badkamer_1_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 170,
        "y": 960,
        "wires": [
            [
                "c0be9f0a16ddfa91"
            ]
        ]
    },
    {
        "id": "c0be9f0a16ddfa91",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 370,
        "y": 960,
        "wires": [
            [
                "f7a031091afd673b"
            ],
            [
                "f7a031091afd673b"
            ]
        ]
    },
    {
        "id": "f7a031091afd673b",
        "type": "trigger",
        "z": "7bcc6d4e.82fd54",
        "name": "Timeout",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "1",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "on",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 590,
        "y": 980,
        "wires": [
            [
                "9dd8db4cdc5253df"
            ]
        ]
    },
    {
        "id": "f104ebe779d9cee3",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer sensor 2",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.xiaomi_motion_sensor_badkamer_2_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 170,
        "y": 1080,
        "wires": [
            [
                "e4ef0f8c686fbf6b"
            ]
        ]
    },
    {
        "id": "e4ef0f8c686fbf6b",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 450,
        "y": 1080,
        "wires": [
            [
                "05d2309ab5603b02",
                "f1a62bfe41130649"
            ],
            [
                "05d2309ab5603b02"
            ]
        ]
    },
    {
        "id": "05d2309ab5603b02",
        "type": "trigger",
        "z": "7bcc6d4e.82fd54",
        "name": "Timeout",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "1",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "on",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 590,
        "y": 1100,
        "wires": [
            [
                "efa750eea9be4e73"
            ]
        ]
    },
    {
        "id": "9dd8db4cdc5253df",
        "type": "api-current-state",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer sensor 2",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "binary_sensor.xiaomi_motion_sensor_badkamer_2_occupancy",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 770,
        "y": 980,
        "wires": [
            [
                "91b39ae7e9caf922"
            ]
        ]
    },
    {
        "id": "91b39ae7e9caf922",
        "type": "switch",
        "z": "7bcc6d4e.82fd54",
        "name": "on/off",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1070,
        "y": 1020,
        "wires": [
            [],
            [
                "8442feb.a9ed2"
            ]
        ]
    },
    {
        "id": "efa750eea9be4e73",
        "type": "api-current-state",
        "z": "7bcc6d4e.82fd54",
        "name": "Badkamer sensor 1",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "binary_sensor.xiaomi_motion_sensor_badkamer_1_occupancy",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 770,
        "y": 1100,
        "wires": [
            [
                "91b39ae7e9caf922"
            ]
        ]
    },
    {
        "id": "8cf6d29df84e92ba",
        "type": "server-state-changed",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop zolder",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "binary_sensor.sonoff_snzb03_motion_sensor_zolder_overloop_occupancy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 180,
        "y": 1640,
        "wires": [
            [
                "d1b96dab742bc28b",
                "f644b5843392fb65"
            ]
        ]
    },
    {
        "id": "d1b96dab742bc28b",
        "type": "subflow:1c8e7eb7.95b3d1",
        "z": "7bcc6d4e.82fd54",
        "name": "Subflow Verlichting logica",
        "env": [],
        "x": 450,
        "y": 1640,
        "wires": [
            [
                "a90d993f40ea5c7e"
            ],
            [],
            [
                "187336dc6b23c96b"
            ]
        ]
    },
    {
        "id": "a90d993f40ea5c7e",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop zolder lamp aan",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_overloop_zolder"
        ],
        "labelId": [],
        "data": "{\"brightness_pct\": 100 }",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_on",
        "x": 1150,
        "y": 1600,
        "wires": [
            []
        ]
    },
    {
        "id": "187336dc6b23c96b",
        "type": "api-call-service",
        "z": "7bcc6d4e.82fd54",
        "name": "Overloop  zolder lamp uit",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "light.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "light.fibaro_dimmer2_overloop_zolder"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "light",
        "service": "turn_off",
        "x": 1150,
        "y": 1680,
        "wires": [
            []
        ]
    },
    {
        "id": "f644b5843392fb65",
        "type": "debug",
        "z": "7bcc6d4e.82fd54",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 350,
        "y": 1740,
        "wires": []
    },
    {
        "id": "2528dcbb.c96994",
        "type": "time-range-switch",
        "z": "7bcc6d4e.82fd54",
        "name": "IsDonker",
        "lat": "52.19845",
        "lon": "5.99872",
        "startTime": "sunsetStart",
        "endTime": "sunrise",
        "startOffset": "-20",
        "endOffset": 0,
        "x": 600,
        "y": 1240,
        "wires": [
            [
                "b4f8230c.a3973"
            ],
            []
        ]
    },
    {
        "id": "555f23b7.c2052c",
        "type": "time-range-switch",
        "z": "7bcc6d4e.82fd54",
        "name": "IsDonker",
        "lat": "52.19845",
        "lon": "5.99872",
        "startTime": "sunsetStart",
        "endTime": "sunrise",
        "startOffset": "-20",
        "endOffset": 0,
        "x": 580,
        "y": 1360,
        "wires": [
            [
                "b4f8230c.a3973"
            ],
            []
        ]
    },
    {
        "id": "46a1d6b1869a0d83",
        "type": "time-range-switch",
        "z": "7bcc6d4e.82fd54",
        "name": "IsDonker",
        "lat": "52.19845",
        "lon": "5.99872",
        "startTime": "sunsetStart",
        "endTime": "sunrise",
        "startOffset": "-20",
        "endOffset": 0,
        "x": 590,
        "y": 940,
        "wires": [
            [
                "f9004cc6.e5025"
            ],
            []
        ]
    },
    {
        "id": "f1a62bfe41130649",
        "type": "time-range-switch",
        "z": "7bcc6d4e.82fd54",
        "name": "IsDonker",
        "lat": "52.19845",
        "lon": "5.99872",
        "startTime": "sunsetStart",
        "endTime": "sunrise",
        "startOffset": "-20",
        "endOffset": 0,
        "x": 590,
        "y": 1060,
        "wires": [
            [
                "f9004cc6.e5025"
            ],
            []
        ]
    },
    {
        "id": "f7df6fdf430ca808",
        "type": "join",
        "z": "ed1a56d03b99dd33",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": true,
        "timeout": "",
        "count": "5",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 950,
        "y": 180,
        "wires": [
            [
                "85193a29bf853cbe"
            ]
        ]
    },
    {
        "id": "9d3258d8bafc23cb",
        "type": "change",
        "z": "ed1a56d03b99dd33",
        "name": "PM2.5",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "PM25",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 80,
        "wires": [
            [
                "f7df6fdf430ca808"
            ]
        ]
    },
    {
        "id": "cdcd1fee74d9623b",
        "type": "change",
        "z": "ed1a56d03b99dd33",
        "name": "PM10",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "PM10",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 140,
        "wires": [
            [
                "f7df6fdf430ca808"
            ]
        ]
    },
    {
        "id": "62799d9eda6197d4",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "FIjnstof PM2.5",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_pm_2_5_concentration",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 500,
        "y": 80,
        "wires": [
            [
                "9d3258d8bafc23cb"
            ]
        ]
    },
    {
        "id": "2f08a8f1c55f631a",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "Fijnstof PM10",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_pm_10_concentration",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 500,
        "y": 140,
        "wires": [
            [
                "cdcd1fee74d9623b"
            ]
        ]
    },
    {
        "id": "85193a29bf853cbe",
        "type": "function",
        "z": "ed1a56d03b99dd33",
        "name": "Set up data",
        "func": "msg.url = \"http://www.apeldoornindata.nl/data/senddata.php?\";\nmsg.url += \"id=236&code=513819&location=52.204140,6.011410\";\nmsg.url += \"&pm10=\" + msg.payload.PM10;\nmsg.url += \"&pm25=\" + msg.payload.PM25;\nmsg.url += \"&temp=\" + msg.payload.temperature;\nmsg.url += \"&rh=\" + msg.payload.humidity;\nmsg.url += \"&luchtdruk=\" + msg.payload.pressure;\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 180,
        "wires": [
            [
                "e751d7aa4c4d9771"
            ]
        ]
    },
    {
        "id": "098b87862981c1a9",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "Fijnstof temperature",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_bme280_temperature",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 520,
        "y": 200,
        "wires": [
            [
                "77fe5fa83ef19715"
            ]
        ]
    },
    {
        "id": "77fe5fa83ef19715",
        "type": "change",
        "z": "ed1a56d03b99dd33",
        "name": "Temp",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "temperature",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 200,
        "wires": [
            [
                "f7df6fdf430ca808"
            ]
        ]
    },
    {
        "id": "392d4a0c9f348ae6",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "Fijnstof humidity",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_bme280_humidity",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 500,
        "y": 260,
        "wires": [
            [
                "48953b48f58fb209"
            ]
        ]
    },
    {
        "id": "48953b48f58fb209",
        "type": "change",
        "z": "ed1a56d03b99dd33",
        "name": "Humidity",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "humidity",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 260,
        "wires": [
            [
                "f7df6fdf430ca808"
            ]
        ]
    },
    {
        "id": "2cd28a77c0e1a482",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "Fijnstof airpressure",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_bme280_pressure",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 510,
        "y": 320,
        "wires": [
            [
                "21547bcea5560d4f"
            ]
        ]
    },
    {
        "id": "21547bcea5560d4f",
        "type": "change",
        "z": "ed1a56d03b99dd33",
        "name": "Airpressure",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "pressure",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 320,
        "wires": [
            [
                "f7df6fdf430ca808"
            ]
        ]
    },
    {
        "id": "e751d7aa4c4d9771",
        "type": "http request",
        "z": "ed1a56d03b99dd33",
        "name": "Post",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "",
        "x": 1350,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "ab474ea7938c33c4",
        "type": "inject",
        "z": "ed1a56d03b99dd33",
        "d": true,
        "name": "Every 5 Minutes",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 210,
        "y": 140,
        "wires": [
            [
                "62799d9eda6197d4",
                "2f08a8f1c55f631a",
                "098b87862981c1a9",
                "392d4a0c9f348ae6",
                "2cd28a77c0e1a482"
            ]
        ]
    },
    {
        "id": "0f246853b86fb45e",
        "type": "api-current-state",
        "z": "ed1a56d03b99dd33",
        "name": "FIjnstof PM2.5",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zwembad_thermometer_fijnstof_wezel38_pm_2_5_concentration",
        "state_type": "num",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "x": 500,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "656b91814b5ff83d",
        "type": "server-state-changed",
        "z": "479a460dbe395935",
        "name": "Laadpaal status changed",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.laadpaal_bezig_met_laden"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 210,
        "y": 440,
        "wires": [
            [
                "c3cd24b9aec0765a"
            ]
        ]
    },
    {
        "id": "c3ff755a2c8f9b0f",
        "type": "api-call-service",
        "z": "479a460dbe395935",
        "name": "Zet laadpaal status ON",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.laadpaal_bezig_met_laden"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1010,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "9d9367cf40cfe465",
        "type": "inject",
        "z": "479a460dbe395935",
        "name": "",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "",
        "payloadType": "str",
        "x": 750,
        "y": 100,
        "wires": [
            [
                "c3ff755a2c8f9b0f"
            ]
        ]
    },
    {
        "id": "d2c37d2169f8695a",
        "type": "inject",
        "z": "479a460dbe395935",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "off",
        "payload": "",
        "payloadType": "str",
        "x": 750,
        "y": 220,
        "wires": [
            [
                "d41fa6da1ce6e3e3"
            ]
        ]
    },
    {
        "id": "d41fa6da1ce6e3e3",
        "type": "api-call-service",
        "z": "479a460dbe395935",
        "name": "Zet laadpaal status OFF",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.laadpaal_bezig_met_laden"
        ],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 1010,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "c3cd24b9aec0765a",
        "type": "switch",
        "z": "479a460dbe395935",
        "name": "status",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 430,
        "y": 440,
        "wires": [
            [
                "557650e1ec7eb176"
            ],
            [
                "f1b0f3ab9df831b1"
            ]
        ]
    },
    {
        "id": "557650e1ec7eb176",
        "type": "api-current-state",
        "z": "479a460dbe395935",
        "name": "Shelly_verbruikmeter_start",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.pro3em_laadpaal_total_active_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "shelly_verbruikmeter_start",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 660,
        "y": 380,
        "wires": [
            [
                "11bb2c3514e0496e"
            ]
        ]
    },
    {
        "id": "11bb2c3514e0496e",
        "type": "api-current-state",
        "z": "479a460dbe395935",
        "name": "Stroomprijs_start",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zonneplan_current_electricity_tariff",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "stroomprijs_start",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 910,
        "y": 380,
        "wires": [
            [
                "8b9ad741addac695"
            ]
        ]
    },
    {
        "id": "089645a56b55bfa8",
        "type": "mysql",
        "z": "479a460dbe395935",
        "mydb": "7866ece42093366f",
        "name": "Insert database",
        "x": 1340,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "8b9ad741addac695",
        "type": "function",
        "z": "479a460dbe395935",
        "name": "Maak start query",
        "func": "var shelly_verbruikmeter_start = flow.get(\"shelly_verbruikmeter_start\");\nnode.warn(\"shelly_verbruikmeter_start: \" + shelly_verbruikmeter_start);\n\nvar stroomprijs_start = flow.get(\"stroomprijs_start\");\nnode.warn(\"stroomprijs_start: \" + stroomprijs_start);\n\nlet query = `INSERT INTO laadpaal_sessies\n  (Id, Datum_start, Datum_stop, Shelly_verbruikmeter_start, Shelly_verbruikmeter_stop, Verbruik_sessie, Stroomprijs_sessie, Stroomprijs_start, Stroomprijs_stop)\n  VALUES (NULL, NOW(), NULL, ${shelly_verbruikmeter_start}, NULL, NULL, NULL, ${stroomprijs_start}, NULL)`;\n\nnode.warn(query)\nmsg.topic = query;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 380,
        "wires": [
            [
                "089645a56b55bfa8"
            ]
        ]
    },
    {
        "id": "f1b0f3ab9df831b1",
        "type": "api-current-state",
        "z": "479a460dbe395935",
        "name": "Shelly_verbruikmeter_stop",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.pro3em_laadpaal_total_active_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "shelly_verbruikmeter_stop",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 660,
        "y": 460,
        "wires": [
            [
                "d583534e1165c952"
            ]
        ]
    },
    {
        "id": "d583534e1165c952",
        "type": "api-current-state",
        "z": "479a460dbe395935",
        "name": "Stroomprijs_stop",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.zonneplan_current_electricity_tariff",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "stroomprijs_stop",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 910,
        "y": 460,
        "wires": [
            [
                "b257f82a9a7de444"
            ]
        ]
    },
    {
        "id": "b257f82a9a7de444",
        "type": "function",
        "z": "479a460dbe395935",
        "name": "Maak start query",
        "func": "var shelly_verbruikmeter_stop = Number(flow.get(\"shelly_verbruikmeter_stop\")) || 0;\nnode.warn(\"shelly_verbruikmeter_stop: \" + shelly_verbruikmeter_stop);\n\nvar stroomprijs_stop = Number(flow.get(\"stroomprijs_stop\")) || 0;\nnode.warn(\"stroomprijs_stop: \" + stroomprijs_stop);\n\n// Update alln de sessie waarvan Datum_stop nog leeg is (NULL/empty).\n// LIMIT 1 omdat je aangeeft dat er maar 1 open sessie hoort te zijn.\nlet query = `\n  UPDATE laadpaal_sessies\n  SET\n    Datum_stop = NOW(),\n    Shelly_verbruikmeter_stop = ${shelly_verbruikmeter_stop},\n    Verbruik_sessie = GREATEST(0, ${shelly_verbruikmeter_stop} - Shelly_verbruikmeter_start),\n    Stroomprijs_stop = ${stroomprijs_stop},\n    Stroomprijs_sessie = GREATEST(Stroomprijs_start, ${stroomprijs_stop})\n  WHERE Datum_stop IS NULL\n  LIMIT 1\n`;\n\nnode.warn(query);\nmsg.topic = query;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 460,
        "wires": [
            [
                "089645a56b55bfa8"
            ]
        ]
    },
    {
        "id": "f986e89b724b2f36",
        "type": "server-state-changed",
        "z": "479a460dbe395935",
        "name": "Shelly Pro Power",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.pro3em_laadpaal_total_active_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "p1_power",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 180,
        "y": 160,
        "wires": [
            [
                "7e51f6c43c50a22f"
            ]
        ]
    },
    {
        "id": "7e51f6c43c50a22f",
        "type": "rbe",
        "z": "479a460dbe395935",
        "name": "on 40W change",
        "func": "deadbandEq",
        "gap": "100",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 520,
        "y": 160,
        "wires": [
            [
                "51f11c552529aa09"
            ]
        ]
    },
    {
        "id": "51f11c552529aa09",
        "type": "switch",
        "z": "479a460dbe395935",
        "name": ">250watt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "250",
                "vt": "num"
            },
            {
                "t": "lt",
                "v": "250",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 160,
        "wires": [
            [
                "c3ff755a2c8f9b0f"
            ],
            [
                "d41fa6da1ce6e3e3"
            ]
        ]
    },
    {
        "id": "76601b42557d8dd4",
        "type": "api-call-service",
        "z": "479a460dbe395935",
        "name": "Marstek battery mode - manual control",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.marstek_master_battery_mode"
        ],
        "labelId": [],
        "data": "{\"option\":\"Manual control\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 700,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "2a6d8a9607695e9a",
        "type": "api-call-service",
        "z": "479a460dbe395935",
        "name": "Marstek battery mode - full control",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_select.marstek_master_battery_mode"
        ],
        "labelId": [],
        "data": "{\"option\":\"Full control\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_select",
        "service": "select_option",
        "x": 680,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "a48e6da32f80ed91",
        "type": "function",
        "z": "479a460dbe395935",
        "name": "Maak start query",
        "func": "var shelly_verbruikmeter_stop = flow.get(\"shelly_verbruikmeter_stop\");\nnode.warn(\"shelly_verbruikmeter_stop: \" + shelly_verbruikmeter_stop);\n\nvar stroomprijs_stop = flow.get(\"stroomprijs_stop\");\nnode.warn(\"stroomprijs_stop: \" + stroomprijs_stop);\n\nlet query = `UPDATE laadpaal_sessies SET\n  Datum_stop = NOW(),\n  Shelly_verbruikmeter_stop = ${shelly_verbruikmeter_stop},\n  Verbruik_sessie = GREATEST(0, ${shelly_verbruikmeter_stop} - Shelly_verbruikmeter_start),  \n  Stroomprijs_stop = ${stroomprijs_stop},\n  Stroomprijs_sessie = GREATEST(Stroomprijs_start, ${stroomprijs_stop})`;\n  \nnode.warn(query)\nmsg.topic = query;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 500,
        "wires": [
            []
        ]
    },
    {
        "id": "eeed5e53ca7222ab",
        "type": "api-call-service",
        "z": "bdc3be9b91e2310d",
        "name": "Set DLM limits",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "script.set_bender_dlm_limits",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "{\"l1\":\"{{payload.l1}}\",\"l2\":\"{{payload.l2}}\",\"l3\":\"{{payload.l3}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "script",
        "service": "set_bender_dlm_limits",
        "x": 760,
        "y": 400,
        "wires": [
            [
                "c5598637ba717ee5"
            ]
        ]
    },
    {
        "id": "06fa7d4576cdd841",
        "type": "function",
        "z": "bdc3be9b91e2310d",
        "name": "Make Test call",
        "func": "msg.payload = {\n    l1: 16,\n    l2: 12,\n    l3: 10\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 400,
        "wires": [
            [
                "eeed5e53ca7222ab"
            ]
        ]
    },
    {
        "id": "f12ea6fdd3d8eee6",
        "type": "inject",
        "z": "bdc3be9b91e2310d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "on",
        "payloadType": "str",
        "x": 370,
        "y": 400,
        "wires": [
            [
                "06fa7d4576cdd841"
            ]
        ]
    },
    {
        "id": "c5598637ba717ee5",
        "type": "debug",
        "z": "bdc3be9b91e2310d",
        "name": "Output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 260,
        "wires": []
    },
    {
        "id": "c5dc70f51749cbc5",
        "type": "server-state-changed",
        "z": "bdc3be9b91e2310d",
        "name": "DLM limit 1",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.bender_dlm_limit_l1"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 350,
        "y": 200,
        "wires": [
            [
                "c5598637ba717ee5"
            ]
        ]
    },
    {
        "id": "26921bd912df34f5",
        "type": "server-state-changed",
        "z": "bdc3be9b91e2310d",
        "name": "DLM limit 2",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.bender_dlm_limit_l2"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 350,
        "y": 260,
        "wires": [
            [
                "c5598637ba717ee5"
            ]
        ]
    },
    {
        "id": "45b69ed3d3f74fa4",
        "type": "server-state-changed",
        "z": "bdc3be9b91e2310d",
        "name": "DLM limit 3",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.bender_dlm_limit_l3"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 350,
        "y": 320,
        "wires": [
            [
                "c5598637ba717ee5"
            ]
        ]
    },
    {
        "id": "a2cd2ee1cd619a47",
        "type": "api-current-state",
        "z": "cde6a70ee5ce073d",
        "g": "6e9aacb3a9cdce9f",
        "name": "Your battery count",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "e81253b4c472274f"
            ]
        ]
    },
    {
        "id": "e30788a43ff718bf",
        "type": "function",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "1b38ce1a57e2395c"
            ],
            [
                "839e399dfbe88ab5"
            ],
            [
                "1763cd8f763c0049"
            ]
        ]
    },
    {
        "id": "e81253b4c472274f",
        "type": "function",
        "z": "cde6a70ee5ce073d",
        "g": "6e9aacb3a9cdce9f",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "e30788a43ff718bf"
            ]
        ]
    },
    {
        "id": "1763cd8f763c0049",
        "type": "function",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "944c212dcefed868",
                "71672cedcfdfca64"
            ]
        ]
    },
    {
        "id": "944c212dcefed868",
        "type": "switch",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "e30788a43ff718bf"
            ],
            [
                "973fc897a307f758"
            ]
        ]
    },
    {
        "id": "1b38ce1a57e2395c",
        "type": "api-call-service",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Set work mode",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "839e399dfbe88ab5",
        "type": "api-call-service",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Set RS485",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "71672cedcfdfca64",
        "type": "debug",
        "z": "cde6a70ee5ce073d",
        "g": "aba81b5451d5f715",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "973fc897a307f758",
        "type": "debug",
        "z": "cde6a70ee5ce073d",
        "g": "6e9aacb3a9cdce9f",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "ee76947a58cc2a1b",
        "type": "server-state-changed",
        "z": "cde6a70ee5ce073d",
        "g": "6e9aacb3a9cdce9f",
        "name": "Master control mode",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "a2cd2ee1cd619a47"
            ]
        ]
    },
    {
        "id": "4ea9a477ecf0c446",
        "type": "server-state-changed",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "PID preset selected",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "f91f14aa5a48bda6"
            ]
        ]
    },
    {
        "id": "25b5a08a5bf89ac0",
        "type": "api-call-service",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Kp",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "8feaf80456317a3e",
        "type": "api-call-service",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Ki",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "570ba6efb8eb8dc7",
        "type": "api-call-service",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Kd",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "f91f14aa5a48bda6",
        "type": "function",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "25b5a08a5bf89ac0"
            ],
            [
                "8feaf80456317a3e"
            ],
            [
                "570ba6efb8eb8dc7"
            ],
            [
                "6ef258c42572df05"
            ],
            [
                "54fa9aa06d0d9224"
            ]
        ]
    },
    {
        "id": "6ef258c42572df05",
        "type": "api-call-service",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Input Smooth",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "54fa9aa06d0d9224",
        "type": "api-call-service",
        "z": "900dac71a5028dca",
        "g": "e44a5d4c33f3cab1",
        "name": "Output Smoothing",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "1d0932b9cdfe2cc0",
        "type": "server-state-changed",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "P1 meter",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "bcecc2d9b0fe6cad"
            ]
        ]
    },
    {
        "id": "057b9222c17d4046",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "Master Control Mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 640,
        "y": 60,
        "wires": [
            [
                "b5940f2c8939de70"
            ]
        ]
    },
    {
        "id": "b5940f2c8939de70",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 880,
        "y": 60,
        "wires": [
            [
                "ceb31920f185d64b"
            ]
        ]
    },
    {
        "id": "e63433bdfbdd57e9",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Battery Strategy",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 660,
        "wires": [
            [
                "b0cd2895e3545c27"
            ]
        ]
    },
    {
        "id": "06dd855a34065b5d",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Strategy selection",
        "func": "// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// stop on error\nif(msg.batteries === undefined) {\n    node.error(\"Battery configuration undefined\", msg);\n    return null;\n}\nif(strategy === undefined) {\n    node.error(\"Battery strategy undefined\", msg);\n    return null;\n}\n\n// select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true) {\n    msg.target = 'Full stop';\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 660,
        "wires": [
            [
                "b658a34d31bcd8f3",
                "d1bd5fbe28bdd070"
            ]
        ]
    },
    {
        "id": "d1bd5fbe28bdd070",
        "type": "link call",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 410,
        "y": 700,
        "wires": [
            [
                "712cd7b2343eead6",
                "7f303dfb944dfc04"
            ]
        ]
    },
    {
        "id": "b658a34d31bcd8f3",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Input parameters",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 660,
        "wires": []
    },
    {
        "id": "712cd7b2343eead6",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Returned solutions",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 700,
        "wires": []
    },
    {
        "id": "7f303dfb944dfc04",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 740,
        "wires": [
            [
                "15830b9747f8132e"
            ]
        ]
    },
    {
        "id": "981ff4f5a93db632",
        "type": "delay",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "",
        "pauseType": "rate",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "0.8",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": false,
        "outputs": 1,
        "x": 450,
        "y": 60,
        "wires": [
            [
                "057b9222c17d4046"
            ]
        ],
        "info": "Due to reports of 3 phase connections sending at \r\nintermittend message intervals.\r\n\r\nThis does not improve quality much and mostly\r\nincreases load. \r\n\r\nWe therefor employ a rate limiter."
    },
    {
        "id": "dbe474c91266b428",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 200,
        "wires": [
            [
                "a91127871ba39241"
            ]
        ]
    },
    {
        "id": "64a533741de02153",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 360,
        "wires": [
            [
                "bbe037f4bc3425fc"
            ]
        ]
    },
    {
        "id": "7d6705c1829e0683",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 360,
        "wires": [
            [
                "a91127871ba39241"
            ],
            [
                "023bfc9b8ac21db1"
            ]
        ]
    },
    {
        "id": "1933f2623fa0fffb",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 360,
        "wires": []
    },
    {
        "id": "ceb31920f185d64b",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Your battery count",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 200,
        "wires": [
            [
                "dbe474c91266b428"
            ]
        ]
    },
    {
        "id": "a91127871ba39241",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Control mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 160,
        "y": 280,
        "wires": [
            [
                "4e53830356f33b07"
            ]
        ]
    },
    {
        "id": "325f396f7e8ad2a8",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 850,
        "y": 280,
        "wires": [
            [
                "f3e427d4451be530"
            ]
        ]
    },
    {
        "id": "d01fc0ee854e249a",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Inverter state",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1270,
        "y": 280,
        "wires": [
            [
                "08d4efea54467ac1"
            ]
        ]
    },
    {
        "id": "f384e6c0da2834c8",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Max discharge power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 680,
        "y": 280,
        "wires": [
            [
                "325f396f7e8ad2a8"
            ]
        ]
    },
    {
        "id": "08d4efea54467ac1",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Energy",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1420,
        "y": 280,
        "wires": [
            [
                "208060fed37273fc"
            ]
        ]
    },
    {
        "id": "7831dd84510fdfaa",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Max charge power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 470,
        "y": 280,
        "wires": [
            [
                "f384e6c0da2834c8"
            ]
        ]
    },
    {
        "id": "4e53830356f33b07",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 310,
        "y": 280,
        "wires": [
            [
                "7831dd84510fdfaa"
            ]
        ]
    },
    {
        "id": "ad80dc99baec6552",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "ea78c084bba20424",
        "name": "Node-RED status: ON",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1360,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "42d70237afb8b3a7",
        "type": "inject",
        "z": "a099d47fc07b3cee",
        "g": "ea78c084bba20424",
        "name": "On start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1180,
        "y": 60,
        "wires": [
            [
                "ad80dc99baec6552"
            ]
        ]
    },
    {
        "id": "e1927196c4198cbf",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set mode (charge/discharge/stop)",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 640,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "047542bb597a3048",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set Batteries",
        "func": "// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif(solution === undefined) {\n    node.error(`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`);\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    node.error(`Can't set battery ${solution.id}, aborting...`);\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 920,
        "wires": [
            [
                "e1927196c4198cbf"
            ],
            [
                "1e4f762143a12bba"
            ],
            [
                "e25994f6e85e901c"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "95295516124d818d",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 920,
        "wires": [
            [
                "047542bb597a3048"
            ]
        ]
    },
    {
        "id": "df4b99688f85df0a",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 720,
        "y": 980,
        "wires": [
            [
                "047542bb597a3048"
            ],
            [
                "8b0aa863bb6493fd"
            ]
        ]
    },
    {
        "id": "e25994f6e85e901c",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 980,
        "wires": [
            [
                "df4b99688f85df0a",
                "084ac27446297f16"
            ]
        ]
    },
    {
        "id": "4decf8d91d6ccacb",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Set power (W)",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 740,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "4d6fd96944872ba1",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 880,
        "wires": [
            [
                "95295516124d818d"
            ]
        ]
    },
    {
        "id": "15830b9747f8132e",
        "type": "switch",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 150,
        "y": 840,
        "wires": [
            [
                "4d6fd96944872ba1"
            ]
        ]
    },
    {
        "id": "8b0aa863bb6493fd",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1040,
        "wires": [
            [
                "77163ca9f43e8fb7"
            ]
        ]
    },
    {
        "id": "084ac27446297f16",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 730,
        "y": 1020,
        "wires": []
    },
    {
        "id": "1e4f762143a12bba",
        "type": "rbe",
        "z": "a099d47fc07b3cee",
        "g": "d77f3b233b9d9a45",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 570,
        "y": 920,
        "wires": [
            [
                "4decf8d91d6ccacb"
            ]
        ]
    },
    {
        "id": "77163ca9f43e8fb7",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "5778369e644d84d7",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 110,
        "y": 1100,
        "wires": []
    },
    {
        "id": "bbe037f4bc3425fc",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 360,
        "wires": [
            [
                "7d6705c1829e0683"
            ]
        ]
    },
    {
        "id": "bcecc2d9b0fe6cad",
        "type": "rbe",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "On change (2%)",
        "func": "deadband",
        "gap": "2%",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 280,
        "y": 60,
        "wires": [
            [
                "981ff4f5a93db632",
                "390fa8a10c0e531f"
            ]
        ]
    },
    {
        "id": "db8e14c359673211",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 560,
        "wires": [
            [
                "e63433bdfbdd57e9"
            ]
        ]
    },
    {
        "id": "b98d8b6d56dc5e39",
        "type": "inject",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 560,
        "wires": [
            [
                "64c9954af597093d"
            ]
        ]
    },
    {
        "id": "9f9dd1b6c8a68339",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 560,
        "wires": [
            [
                "c9b6b8b729161188"
            ]
        ]
    },
    {
        "id": "1cc51c4bd0523e93",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Your battery count",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 560,
        "wires": [
            [
                "9f9dd1b6c8a68339"
            ]
        ]
    },
    {
        "id": "1c419030271bee64",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Prioritize battery M",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 560,
        "wires": [
            [
                "db8e14c359673211"
            ]
        ]
    },
    {
        "id": "c9b6b8b729161188",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Update prioritized battery",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "64c9954af597093d",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Desired interval",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 560,
        "wires": [
            [
                "1dac3194a67aeec2"
            ]
        ]
    },
    {
        "id": "1dac3194a67aeec2",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 560,
        "wires": [
            [
                "641cc1cf21ace75a"
            ]
        ]
    },
    {
        "id": "641cc1cf21ace75a",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "0a3ea32230e8832c",
        "name": "Current priority",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 560,
        "wires": [
            [
                "1cc51c4bd0523e93"
            ]
        ]
    },
    {
        "id": "0be9d3b9ef3576fd",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "c1e44a160c59f1a9",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh effective\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 460,
        "wires": [
            [
                "1c419030271bee64",
                "ce28e80550ab9b42"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "208060fed37273fc",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "Energy max",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1570,
        "y": 280,
        "wires": [
            [
                "64a533741de02153"
            ]
        ]
    },
    {
        "id": "023bfc9b8ac21db1",
        "type": "function",
        "z": "a099d47fc07b3cee",
        "g": "6fad59f7a8530963",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 360,
        "wires": [
            [
                "1933f2623fa0fffb",
                "0be9d3b9ef3576fd"
            ]
        ]
    },
    {
        "id": "f27b588385633b97",
        "type": "api-call-service",
        "z": "a099d47fc07b3cee",
        "name": "Set total usable energy",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 540,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "390fa8a10c0e531f",
        "type": "moment",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "Last processed",
        "topic": "",
        "input": "timestamp",
        "inputType": "msg",
        "inTz": "Europe/Amsterdam",
        "adjAmount": 0,
        "adjType": "days",
        "adjDir": "add",
        "format": "HH:mm:ss",
        "locale": "C",
        "output": "time",
        "outputType": "msg",
        "outTz": "Europe/Amsterdam",
        "x": 300,
        "y": 100,
        "wires": [
            [
                "344e5a3dc0efb2f4"
            ]
        ]
    },
    {
        "id": "344e5a3dc0efb2f4",
        "type": "debug",
        "z": "a099d47fc07b3cee",
        "g": "fc3b0636793881be",
        "name": "Time",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "time",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 470,
        "y": 100,
        "wires": []
    },
    {
        "id": "b0cd2895e3545c27",
        "type": "api-current-state",
        "z": "a099d47fc07b3cee",
        "g": "a5b8a03b1e2f2371",
        "name": "Full Stop Trigger",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 720,
        "wires": [
            [
                "06dd855a34065b5d"
            ]
        ]
    },
    {
        "id": "ce28e80550ab9b42",
        "type": "rbe",
        "z": "a099d47fc07b3cee",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 350,
        "y": 460,
        "wires": [
            [
                "f27b588385633b97"
            ]
        ]
    },
    {
        "id": "f3e427d4451be530",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC min",
        "rules": [
            {
                "t": "set",
                "p": "discharging_cutoff_capacity",
                "pt": "msg",
                "to": "12",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 980,
        "y": 280,
        "wires": [
            [
                "a882514e64e6f538"
            ]
        ]
    },
    {
        "id": "a882514e64e6f538",
        "type": "change",
        "z": "a099d47fc07b3cee",
        "g": "b63f2e905b829e5b",
        "name": "SoC max",
        "rules": [
            {
                "t": "set",
                "p": "charging_cutoff_capacity",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 280,
        "wires": [
            [
                "d01fc0ee854e249a"
            ]
        ]
    },
    {
        "id": "e2fbefe0a92c8b87",
        "type": "link in",
        "z": "0199f18df097aa8f",
        "g": "130c2473c32bd786",
        "name": "Timed",
        "links": [],
        "x": 175,
        "y": 180,
        "wires": [
            [
                "c669dabc5fa09ae2"
            ]
        ]
    },
    {
        "id": "7dce7367da5a0686",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "df3ea4464fdd6253",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "g": "130c2473c32bd786",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "9ce9ba35eda99c46",
        "type": "link out",
        "z": "0199f18df097aa8f",
        "g": "7d5d20208cad641e",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 65,
        "y": 840,
        "wires": []
    },
    {
        "id": "f0ecfb0d25bf1e0f",
        "type": "comment",
        "z": "0199f18df097aa8f",
        "g": "7d5d20208cad641e",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 120,
        "y": 780,
        "wires": []
    },
    {
        "id": "942bbcc0b79ffec6",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Period A start",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "84cab4abb90d1f7a"
            ]
        ]
    },
    {
        "id": "84cab4abb90d1f7a",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Period A end",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "dfa151f727d68ad2"
            ]
        ]
    },
    {
        "id": "97a70bb440ca8984",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Period B start",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "d82f98b7e93d3eac"
            ]
        ]
    },
    {
        "id": "d82f98b7e93d3eac",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Period B end",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "78f0fd728bec341e"
            ]
        ]
    },
    {
        "id": "dfa151f727d68ad2",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "bf29fe0ee25b592b",
        "name": "Strat during A",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "cb3cb1afa5ceda3d"
            ]
        ]
    },
    {
        "id": "78f0fd728bec341e",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Strat during B",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "83e9ba4b673403f7"
            ]
        ]
    },
    {
        "id": "cb3cb1afa5ceda3d",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "f9db7587adf69bfa",
        "name": "Has period B",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "97a70bb440ca8984"
            ]
        ]
    },
    {
        "id": "57eb83baaca02db6",
        "type": "inject",
        "z": "0199f18df097aa8f",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 260,
        "wires": [
            [
                "c669dabc5fa09ae2"
            ]
        ]
    },
    {
        "id": "8eaa8fd948be1fad",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "3108d0a11fcf542f"
            ]
        ]
    },
    {
        "id": "8de067121fbfd939",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "7775e04676756c1e",
                "83a1051adc959e8c"
            ]
        ]
    },
    {
        "id": "3108d0a11fcf542f",
        "type": "switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "7775e04676756c1e",
                "30c98e7546f78b88"
            ],
            [
                "3c647acc433c766d"
            ]
        ]
    },
    {
        "id": "7bc56c05b65b8a56",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "9353d27b9ba49389"
            ]
        ]
    },
    {
        "id": "9353d27b9ba49389",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "8de067121fbfd939"
            ],
            [
                "8eaa8fd948be1fad"
            ]
        ]
    },
    {
        "id": "3c647acc433c766d",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "3919eb10fa97d04d"
            ]
        ]
    },
    {
        "id": "3919eb10fa97d04d",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "98697d12039611bf"
            ],
            [
                "c7b14890ae2578d1"
            ]
        ]
    },
    {
        "id": "98697d12039611bf",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "7775e04676756c1e",
                "0cde47a17becc07d"
            ]
        ]
    },
    {
        "id": "c7b14890ae2578d1",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "cd148224059fdaae"
            ]
        ]
    },
    {
        "id": "c669dabc5fa09ae2",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "115c88f19a6e3add",
        "name": "Default Strat",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "942bbcc0b79ffec6"
            ]
        ]
    },
    {
        "id": "31b352bcf0b5fa22",
        "type": "api-call-service",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Active sub strategy text field",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.timed_strategy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1300,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "1ff8dd8a7bb8c098",
        "type": "link call",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1090,
        "y": 760,
        "wires": [
            [
                "9ce9ba35eda99c46"
            ]
        ]
    },
    {
        "id": "7775e04676756c1e",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "1ff8dd8a7bb8c098",
                "f89183be5ef546c8",
                "4a78e8501fe52d32"
            ]
        ]
    },
    {
        "id": "83a1051adc959e8c",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "30c98e7546f78b88",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "0cde47a17becc07d",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "5518e5a61cfe69c6",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "f89183be5ef546c8",
        "type": "rbe",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "timed_strategy",
        "topi": "topic",
        "x": 1090,
        "y": 640,
        "wires": [
            [
                "31b352bcf0b5fa22"
            ]
        ]
    },
    {
        "id": "4a78e8501fe52d32",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "635af4e3e7a252ce",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1070,
        "y": 700,
        "wires": []
    },
    {
        "id": "568d79926c754129",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Period C start",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "c5ad0abaf680c75b"
            ]
        ]
    },
    {
        "id": "c5ad0abaf680c75b",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Period C end",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "7d02914f2aaf8cda"
            ]
        ]
    },
    {
        "id": "7d02914f2aaf8cda",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Strat during C",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "7bc56c05b65b8a56"
            ]
        ]
    },
    {
        "id": "83e9ba4b673403f7",
        "type": "api-current-state",
        "z": "0199f18df097aa8f",
        "g": "e0ed6822bd47bca9",
        "name": "Has period C",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "568d79926c754129"
            ]
        ]
    },
    {
        "id": "cd148224059fdaae",
        "type": "switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "7775e04676756c1e",
                "5518e5a61cfe69c6"
            ],
            [
                "7d3b97b9302eaf46"
            ]
        ]
    },
    {
        "id": "319d772dc1a3f413",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "7d3b97b9302eaf46",
        "type": "function",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "8a7f41b1448ba249"
            ]
        ]
    },
    {
        "id": "8a7f41b1448ba249",
        "type": "time-range-switch",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "1ac5564bbb7c6d7f"
            ],
            [
                "273d6cb45a191bcc"
            ]
        ]
    },
    {
        "id": "1ac5564bbb7c6d7f",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "319d772dc1a3f413",
                "7775e04676756c1e"
            ]
        ]
    },
    {
        "id": "273d6cb45a191bcc",
        "type": "change",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "7775e04676756c1e",
                "90f20fce6d8576ce"
            ]
        ]
    },
    {
        "id": "90f20fce6d8576ce",
        "type": "debug",
        "z": "0199f18df097aa8f",
        "g": "263441dd7d34de1c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "7a0cd93e9df76c48",
        "type": "link in",
        "z": "c1a9925591b564a7",
        "g": "e2c385d3b03e57bc",
        "name": "Self-consumption",
        "links": [],
        "x": 225,
        "y": 160,
        "wires": [
            [
                "de5eedecc97994b4"
            ]
        ]
    },
    {
        "id": "a56daa760b9feeb1",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "e2c385d3b03e57bc",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 170,
        "y": 120,
        "wires": []
    },
    {
        "id": "5188a2bc82313c2e",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "2b06415ad41aae3a",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "User Ki change",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 240,
        "wires": [
            [
                "957baac6682de3d3"
            ]
        ]
    },
    {
        "id": "957baac6682de3d3",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 300,
        "wires": [
            [
                "6273b550e193d38b"
            ]
        ]
    },
    {
        "id": "40290752a7c02655",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 200,
        "wires": []
    },
    {
        "id": "6273b550e193d38b",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "3be8354628cecb12",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 360,
        "wires": []
    },
    {
        "id": "787d4a4302cc3783",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 660,
        "wires": [
            [
                "cfc64f84a4532120",
                "58b3c35be6a1ea9c"
            ],
            [
                "cfc64f84a4532120",
                "58b3c35be6a1ea9c"
            ],
            [
                "58b3c35be6a1ea9c"
            ]
        ],
        "l": false
    },
    {
        "id": "58b3c35be6a1ea9c",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 660,
        "wires": []
    },
    {
        "id": "5a05ae43285d5398",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Master control mode",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 660,
        "wires": [
            [
                "787d4a4302cc3783"
            ]
        ]
    },
    {
        "id": "eca69e12794c1c0b",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Integral PID to zero",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 500,
        "wires": [
            [
                "f5e5091687ccc093"
            ]
        ]
    },
    {
        "id": "f5e5091687ccc093",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Differential PID to zero",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 540,
        "wires": [
            [
                "8a50bc3d63d7a248"
            ]
        ]
    },
    {
        "id": "cfc64f84a4532120",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Proportinal PID to zero",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 460,
        "wires": [
            [
                "eca69e12794c1c0b"
            ]
        ]
    },
    {
        "id": "8a50bc3d63d7a248",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "PID Output to zero",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 580,
        "wires": [
            [
                "a414c1013e9b72aa"
            ]
        ]
    },
    {
        "id": "a414c1013e9b72aa",
        "type": "change",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "7ca8801a84b11ae8",
        "type": "inject",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Debug FALSE",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "false",
        "payloadType": "bool",
        "x": 1730,
        "y": 100,
        "wires": [
            [
                "95f5050249137fbc"
            ]
        ]
    },
    {
        "id": "95f5050249137fbc",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Set debug true/false",
        "func": "flow.set(\"LoadDistribution_debug_enabled\", msg.payload);\nnode.warn(\"Debug flag set to: \" + msg.payload);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1940,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6a1707cb3cef46f2",
        "type": "inject",
        "z": "c1a9925591b564a7",
        "g": "7ab490ceca7cff35",
        "name": "Debug TRUE",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 1730,
        "y": 60,
        "wires": [
            [
                "95f5050249137fbc"
            ]
        ]
    },
    {
        "id": "8baa774c2b027a30",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target grid consumption",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "6286320aa2c67f78"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "597ae0e8b54ce90b",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Hysteresis",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "7e1e11d0eb34edae"
            ]
        ]
    },
    {
        "id": "5aa64580ae12f4b2",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID P-value",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "409b51e049035eb9"
            ]
        ]
    },
    {
        "id": "409b51e049035eb9",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID I-value",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "526cad5fede1f966"
            ]
        ]
    },
    {
        "id": "526cad5fede1f966",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "PID D-value",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "dde5b40cb7fe1ff8"
            ]
        ]
    },
    {
        "id": "7e1e11d0eb34edae",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nRED.util.setMessageProperty(msg,\"advanced_settings.self_consumption_at\",Date.now(),true); // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.\n//\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined,\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "affa3d29d06490e4"
            ]
        ]
    },
    {
        "id": "dde5b40cb7fe1ff8",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "54cf41d4c27eeebe",
        "name": "Idle time before Stop",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "597ae0e8b54ce90b"
            ]
        ]
    },
    {
        "id": "8b9359ba6370a958",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "affa3d29d06490e4",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Error signal dampening",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "d87e5fb7584a366b"
            ]
        ]
    },
    {
        "id": "d87e5fb7584a366b",
        "type": "api-current-state",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Output signal dampening",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "d8cf3fee789fa491"
            ]
        ]
    },
    {
        "id": "d8cf3fee789fa491",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "086689c5c8bba4b6",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "9b70f054ec8bbbb1"
            ]
        ]
    },
    {
        "id": "de3671b9c7503ce3",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "d2868e3da06e78d5",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "5b44917d48154dea"
            ]
        ]
    },
    {
        "id": "6f0b3716cc693cd6",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "e8409a2a051286bf"
            ],
            [
                "d2868e3da06e78d5"
            ]
        ]
    },
    {
        "id": "e8409a2a051286bf",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "5b44917d48154dea"
            ]
        ]
    },
    {
        "id": "5b44917d48154dea",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "991409971787deec",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "028f43a44d1bec69"
            ]
        ]
    },
    {
        "id": "9b70f054ec8bbbb1",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    // node.log(`Stopped processing | P1_error is within deadband of ${P1_deadband}`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "735046e00914a975"
            ]
        ]
    },
    {
        "id": "028f43a44d1bec69",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Calculate corrections",
        "func": "var logdata = \"\";\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); \n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term | integrate\nI_integral_sum += P1_error; \n\n// Integral term | apply anti-windup \nlet integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\nI_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `;\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `;\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n} else if \n// Advanced setting | hysteresis\n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "4cafd473afb89158"
            ],
            [
                "235494cc1d2a6b97"
            ],
            [
                "59bee8c6b6be159f"
            ],
            [
                "cfa0372c07314b8d"
            ],
            [
                "526d83d6881fd8ce"
            ],
            [
                "129ec2777a861d77"
            ],
            [
                "53039b668ab0a97e"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "53039b668ab0a97e",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "235494cc1d2a6b97",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Error Signal",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "4854534dc7c83892"
            ]
        ]
    },
    {
        "id": "5c62450063520ee9",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "PID Output",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "bc8a24344b2ae2ca"
            ]
        ]
    },
    {
        "id": "d6e0a13720d2ceb3",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Proportinal term",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "9f823db632bbd13f",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Integral term",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "ea8b44a09b499968",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Differential term",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "d739d29aebbdb0e0",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "bc8a24344b2ae2ca",
        "type": "smooth",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "a79b2b6c56ce7751"
            ]
        ]
    },
    {
        "id": "a79b2b6c56ce7751",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "PID deviation",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "4854534dc7c83892",
        "type": "smooth",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "7cdef29145623758"
            ]
        ]
    },
    {
        "id": "7cdef29145623758",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Error deviation",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "4cafd473afb89158",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "cbc863ac4c6ce1b8"
            ]
        ]
    },
    {
        "id": "cbc863ac4c6ce1b8",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "2ef3fc5bd6a33686",
                "5c62450063520ee9"
            ]
        ]
    },
    {
        "id": "cfa0372c07314b8d",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "9f823db632bbd13f"
            ]
        ]
    },
    {
        "id": "2ef3fc5bd6a33686",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "7242528b056e3c47",
        "name": "Load distribution",
        "func": "//Debug toggle\nlet debugLog = flow.get(\"LoadDistribution_debug_enabled\") === true;\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nvar logdata = `Charging=${isCharging} | `; // logging for node-red debug node\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nvar unassigned_power = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nlogdata += `Unassigned power ${unassigned_power} W | `;\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// debug output function\nfunction debug(message) {\n    if (debugLog) {\n        node.warn(message);\n        node.status({fill:\"yellow\",shape:\"ring\",text:\"debugging\"});\n    } else {\n        node.status({fill:\"green\",shape:\"dot\",text:\"operating\"});\n    }\n}\ndebug(`=== Cycle #${Date.now()} ===`);\n\n// battery life improvement (slow charge near max SoC)\n/**\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    if(max_power < 0) max_power = 0;\n    if (!hasChargingLimiter) return max_power;\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\nif (isCharging) logdata += `Charge limiting based on SoC | `;\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        // battery is kept IDLE, while awaiting minimum inactive time\n        logdata += `Idle: ${batteryID} ${Math.round(time_idle/1000)}s | `;\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    logdata += `'Idle: ${batteryID}' unknown last active time | `;\n    debug(`[IDLE] Battery '${batteryID}' unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\nlogdata += \"Idle before stop | \";\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n  \n    debug(`[CHECK] Battery ${battery.id}: SoC=${battery.soc}%, Min=${battery.soc_min}%, Max=${battery.soc_max}%, RS485=${battery.rs485}, isCharging=${isCharging}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `[SKIP] Battery ${battery.id}: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        debug(skipReason);                          // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // log\n    debug(`[ASSIGN] Battery ${solution.id}: allowed to ${solution.mode} with ${solution.power}W`);\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n    //node.warn(`[BATTERY] UPDATE: ID=${battery.id}, new_unassigned=${unassigned_power}W, total_assignable=${batteries_total_assignable_power}W`);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\nlogdata += `batteries_total_assignable_power ${batteries_total_assignable_power} | `;\n\n// OUTPUT\nsolution_array.forEach(solution => { \n    logdata += `Solution: ${solution.id}, ${solution.mode} ${solution.power} W | `;\n});\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n\n// TWO OUTPUT NODES\nreturn [\n    { payload: logdata },    // debug output\n    msg , // to Home Battery flow\n    ]; ",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1180,
        "wires": [
            [
                "3640364ae79b69ec"
            ],
            [
                "67116260f2e09362"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "3640364ae79b69ec",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "7242528b056e3c47",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "735046e00914a975",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "7636353795317949"
            ],
            [
                "6f0b3716cc693cd6"
            ]
        ]
    },
    {
        "id": "67116260f2e09362",
        "type": "link out",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "999fa888c5e5e56b",
        "type": "comment",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "7636353795317949",
        "type": "link out",
        "z": "c1a9925591b564a7",
        "g": "1fadb46f18a01ebe",
        "name": "go to End",
        "mode": "link",
        "links": [
            "fb0eeeb7ddf70b28"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "fb0eeeb7ddf70b28",
        "type": "link in",
        "z": "c1a9925591b564a7",
        "g": "419f0c8ca2d0601a",
        "name": "link to End",
        "links": [
            "7636353795317949"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "67116260f2e09362"
            ]
        ]
    },
    {
        "id": "e52abd366fd81c67",
        "type": "api-call-service",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Is charging",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "0c60f5ca1f25e34b",
        "type": "function",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "e52abd366fd81c67"
            ]
        ]
    },
    {
        "id": "de5eedecc97994b4",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "8591421549956ee1"
            ],
            [
                "8baa774c2b027a30"
            ]
        ]
    },
    {
        "id": "f6b196faaa1eff2f",
        "type": "debug",
        "z": "c1a9925591b564a7",
        "g": "d3eeef5879f195b1",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "9f357837ab8c534f",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Strategy changes",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 480,
        "wires": [
            [
                "fae5e93e1a95d5ed"
            ]
        ]
    },
    {
        "id": "fae5e93e1a95d5ed",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 480,
        "wires": [
            [
                "cfc64f84a4532120"
            ]
        ],
        "l": false
    },
    {
        "id": "0d36f7d78102ff6d",
        "type": "server-state-changed",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "Full stop trigger",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 560,
        "wires": [
            [
                "8439426a432c3f9c"
            ]
        ]
    },
    {
        "id": "8439426a432c3f9c",
        "type": "switch",
        "z": "c1a9925591b564a7",
        "g": "94b7ae0409093e17",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 560,
        "wires": [
            [
                "cfc64f84a4532120"
            ]
        ],
        "l": false
    },
    {
        "id": "59bee8c6b6be159f",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "d6e0a13720d2ceb3"
            ]
        ]
    },
    {
        "id": "526d83d6881fd8ce",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "ea8b44a09b499968"
            ]
        ]
    },
    {
        "id": "129ec2777a861d77",
        "type": "rbe",
        "z": "c1a9925591b564a7",
        "g": "21c8ea25ac313948",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "0c60f5ca1f25e34b",
                "d739d29aebbdb0e0"
            ]
        ]
    },
    {
        "id": "a5e9e484430e1720",
        "type": "link in",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Charge PV",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "682972c51f2870ed"
            ]
        ]
    },
    {
        "id": "13aeb5c39ba83e0a",
        "type": "comment",
        "z": "676ceac4c521834d",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "bf548077ba6ca350",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "72059e541379a869",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "87be4b85f89829b6",
        "type": "link out",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 665,
        "y": 180,
        "wires": []
    },
    {
        "id": "d62d870eb44d3582",
        "type": "comment",
        "z": "676ceac4c521834d",
        "g": "9889d591bcc38e89",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 720,
        "y": 120,
        "wires": []
    },
    {
        "id": "682972c51f2870ed",
        "type": "function",
        "z": "676ceac4c521834d",
        "name": "Setup",
        "func": "// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disalow discharging\nconst DISABLE_DISCHARGE = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISABLE_DISCHARGE,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 180,
        "wires": [
            [
                "17645a134fe6d941"
            ]
        ]
    },
    {
        "id": "17645a134fe6d941",
        "type": "link call",
        "z": "676ceac4c521834d",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 470,
        "y": 180,
        "wires": [
            [
                "d612533a5317bb76",
                "87be4b85f89829b6"
            ]
        ]
    },
    {
        "id": "d612533a5317bb76",
        "type": "debug",
        "z": "676ceac4c521834d",
        "name": "Batteries charging?",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "batteries_charging",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 730,
        "y": 260,
        "wires": []
    },
    {
        "id": "2c4ec860ab1a8f79",
        "type": "link in",
        "z": "95489b12daee74f5",
        "g": "ee5f9b06bf7efa46",
        "name": "Dynamic",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "81b460c063969182"
            ]
        ]
    },
    {
        "id": "57a9ce1a5a7bb9ef",
        "type": "comment",
        "z": "95489b12daee74f5",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "471fda4979e7fc76",
        "type": "comment",
        "z": "95489b12daee74f5",
        "g": "ee5f9b06bf7efa46",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "45ca4e9b170ae0e4",
        "type": "link out",
        "z": "95489b12daee74f5",
        "g": "ff30c86c22bf31c8",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 55,
        "y": 340,
        "wires": []
    },
    {
        "id": "c855da432b5a589a",
        "type": "comment",
        "z": "95489b12daee74f5",
        "g": "ff30c86c22bf31c8",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 110,
        "y": 280,
        "wires": []
    },
    {
        "id": "2e5b6b44c86f80e3",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest",
        "server": "b9d10367867e38e6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 560,
        "wires": [
            [
                "34a30e529baf678b"
            ]
        ]
    },
    {
        "id": "0799b280bf62758e",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive",
        "server": "b9d10367867e38e6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 620,
        "wires": [
            [
                "1908addf7c5bfb93"
            ]
        ]
    },
    {
        "id": "5cb60087e09c8852",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Complete message",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 900,
        "wires": []
    },
    {
        "id": "34a30e529baf678b",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 560,
        "wires": [
            [
                "af541182589224a7"
            ]
        ],
        "l": false
    },
    {
        "id": "1908addf7c5bfb93",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 620,
        "wires": [
            [
                "da4428dd14db9967"
            ]
        ],
        "l": false
    },
    {
        "id": "adbbd358b213f08e",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Determine dynamic strategy",
        "func": "// Extract start date objects\nlet start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nlet start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nlet isCheapestNext = true;\nlet lastCheapestPrice = context.last_cheapest_price || 0;\nlet deltaThreshold = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.min_delta_cents\")/100) || 0; // 100 cents = 1 Cr\n\n// Enums\nconst STRATEGY = {\n    CHEAPEST: \"Charge\", \n    NEUTRAL: \"Charge PV\",\n    EXPENSIVE: \"Self-consumption\"\n}\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg,\"dynamic.value_conversion\")) || 1;\n\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    node.warn(`One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`);\n    msg.log ? msg.log.push(`One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`):null;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    msg.log ? msg.log.push(`Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`): null;\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\"); // /kWh rate\n    lastCheapestPrice = context.last_cheapest_price;\n    msg.log ? msg.log.push(`Cheapest price set to ${lastCheapestPrice}`):null;\n}\n\nif (lastCheapestPrice == 0) {\n    msg.log ? msg.log.push(`I can't recall the tariff used for charging. Cheapest price set to ${lastCheapestPrice}`):null;\n}\n\n// // Format the Date object to HH:MM based on locale options.\n// // We use 'nl-NL' locale, but any will work if it uses : as separator\n// const startCheapHHMM = start_cheapest.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });                         // Result: \"03:00\"\n// msg.cheapest.startHHMM = startCheapHHMM;\n\n\n// const endHHMM = end.toLocaleTimeString('nl-NL', {\n//     hour: '2-digit',        // Ensure the hour is two digits (e.g., 03)\n//     minute: '2-digit',      // Ensure the minute is two digits (e.g., 00)\n//     hour12: false           // Force 24-hour format (00-23)\n// });   \n\n// is_now\n/** @type {boolean} */\nconst cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// Determine if it is economical to start charging\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n// average price expensive\nconst lastExpensivePrice = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\"); // /kWh rate\n// delta >  0,06 = charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice) / CONVERSION_RATE; // \n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = parseFloat((lastCheapestPrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_expensive_tariff = parseFloat((lastExpensivePrice / CONVERSION_RATE).toFixed(2));\nmsg.dynamic.avg_delta = parseFloat(delta.toFixed(2));\n\n// Set strategy\nif (cheapestIsNow) msg.dynamic.strategy = STRATEGY.CHEAPEST;\nif (expensiveIsNow && delta >= deltaThreshold) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n} else if(expensiveIsNow) {\n    // log\n    msg.log ? msg.log.push(`Expensive period, but not using batteries. The tariff difference between cheap and expensive periods is too small: ${(lastExpensivePrice / CONVERSION_RATE).toFixed(4)}-${(lastCheapestPrice / CONVERSION_RATE).toFixed(4) }=${delta.toFixed(4)} < ${deltaThreshold}.`) : null;    \n}\n\n// Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta.toFixed(4)}` });\n\n// Log\nmsg.log ? msg.log.push(`Dynamic strat set to ${msg.dynamic.strategy}. \nCheapest period now? ${cheapestIsNow}. \nExpensive period now? ${expensiveIsNow}.`):null;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 740,
        "wires": [
            [
                "5cb60087e09c8852",
                "89368e429aa3d7d0",
                "e83d728f6cf5d437",
                "dc266592c79676c7",
                "ea704e53eb20315f",
                "cba4fb540a66e4e6",
                "6e287097dc4e0236",
                "403a9dfa33392328",
                "67e38494d0337403"
            ]
        ]
    },
    {
        "id": "ec06caa7c9e6a95d",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "31e4a5e372bcb73f",
                "c38ec0f354fd0ff8"
            ]
        ]
    },
    {
        "id": "31e4a5e372bcb73f",
        "type": "link call",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 690,
        "y": 200,
        "wires": [
            [
                "45ca4e9b170ae0e4"
            ]
        ]
    },
    {
        "id": "89368e429aa3d7d0",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest Start",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "e83d728f6cf5d437",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest End",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "dc266592c79676c7",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive Start",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "ea704e53eb20315f",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive End",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 820,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "8cddc8961385f28e",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Sub-strategy",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 870,
        "y": 100,
        "wires": []
    },
    {
        "id": "c0fe420fa716d4ca",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Every hour (cron)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "0 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 370,
        "y": 400,
        "wires": [
            [
                "1990213302cf1876"
            ]
        ]
    },
    {
        "id": "81b460c063969182",
        "type": "switch",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "e5f74756a260df5b"
            ],
            [
                "ec06caa7c9e6a95d"
            ]
        ]
    },
    {
        "id": "e5f74756a260df5b",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "31e4a5e372bcb73f",
                "c38ec0f354fd0ff8"
            ]
        ]
    },
    {
        "id": "c38ec0f354fd0ff8",
        "type": "rbe",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "target",
        "topi": "topic",
        "x": 690,
        "y": 160,
        "wires": [
            [
                "16efd2b03d6dece5",
                "8cddc8961385f28e"
            ]
        ]
    },
    {
        "id": "16efd2b03d6dece5",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "70d1049fc896f1cd",
        "name": "Active sub strategy text field",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.target}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 920,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "6e2f9d4be7e18c3a",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1060,
        "wires": [
            [
                "92e35d100ca61070"
            ]
        ]
    },
    {
        "id": "92e35d100ca61070",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Cheapest",
        "server": "b9d10367867e38e6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1060,
        "wires": [
            [
                "30af788462a325c7"
            ]
        ]
    },
    {
        "id": "30af788462a325c7",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1060,
        "wires": [
            [
                "d05798a95b8cf195"
            ]
        ],
        "l": false
    },
    {
        "id": "d05798a95b8cf195",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Expensive",
        "server": "b9d10367867e38e6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1060,
        "wires": [
            [
                "04d57a78a2fc3095"
            ]
        ]
    },
    {
        "id": "04d57a78a2fc3095",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1060,
        "wires": [
            [
                "320df01bc7436680",
                "d8004c43e9b3d8d0",
                "99545071b9bdfd66"
            ]
        ],
        "l": false
    },
    {
        "id": "320df01bc7436680",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1100,
        "wires": []
    },
    {
        "id": "d8004c43e9b3d8d0",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1140,
        "wires": []
    },
    {
        "id": "1f3454b85f32ab4c",
        "type": "api-render-template",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "All Zonneplan",
        "server": "b9d10367867e38e6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1260,
        "wires": [
            [
                "3f94e4f380add2e8"
            ]
        ]
    },
    {
        "id": "338407c8c442244c",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1260,
        "wires": [
            [
                "1f3454b85f32ab4c"
            ]
        ]
    },
    {
        "id": "3f94e4f380add2e8",
        "type": "json",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1260,
        "wires": [
            [
                "079e2531ed154c01"
            ]
        ],
        "l": false
    },
    {
        "id": "1990213302cf1876",
        "type": "delay",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 540,
        "y": 400,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "98d7f59f0b7eab92",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Source",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 360,
        "wires": [
            [
                "5534a44cf66a84bd"
            ]
        ]
    },
    {
        "id": "de24e0e941d08b62",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Data source settings",
        "func": "/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            msg.log.push(\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            msg.log.push(\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            msg.log.push(\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            msg.log.push(\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            msg.log.push(\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            msg.log.push(\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            msg.log.push(\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            msg.log.push(\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            msg.log.push(\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            msg.log.push(\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            msg.log.push(\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            msg.log.push(\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            msg.log.push(\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            msg.log.push(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 480,
        "wires": [
            [
                "7f75e4fa1c2d86a0"
            ]
        ]
    },
    {
        "id": "5534a44cf66a84bd",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cheapest N hrs",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 960,
        "y": 360,
        "wires": [
            [
                "1d49e10959ab22bc"
            ]
        ]
    },
    {
        "id": "1d49e10959ab22bc",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Expensive N hrs",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1140,
        "y": 360,
        "wires": [
            [
                "f1168e015522bbfc"
            ]
        ]
    },
    {
        "id": "3d76aa4d40d9ede2",
        "type": "inject",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "On start",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 340,
        "y": 360,
        "wires": [
            [
                "127bc4a04263b3c0"
            ]
        ]
    },
    {
        "id": "127bc4a04263b3c0",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 360,
        "wires": [
            [
                "98d7f59f0b7eab92"
            ]
        ]
    },
    {
        "id": "7f75e4fa1c2d86a0",
        "type": "function",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\ntemplate_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\ntemplate_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 480,
        "wires": [
            [
                "f5f223200fbada06",
                "fedfd15cd6cddaed",
                "f65eeae181ccbc8a"
            ]
        ]
    },
    {
        "id": "f5f223200fbada06",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 480,
        "wires": []
    },
    {
        "id": "fedfd15cd6cddaed",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 520,
        "wires": []
    },
    {
        "id": "f65eeae181ccbc8a",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 560,
        "wires": [
            [
                "2e5b6b44c86f80e3"
            ]
        ]
    },
    {
        "id": "af541182589224a7",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 620,
        "wires": [
            [
                "0799b280bf62758e"
            ]
        ]
    },
    {
        "id": "da4428dd14db9967",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 680,
        "wires": [
            [
                "adbbd358b213f08e"
            ]
        ]
    },
    {
        "id": "cba4fb540a66e4e6",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Log only",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 800,
        "y": 940,
        "wires": []
    },
    {
        "id": "03f47a2f3212cb6b",
        "type": "server-state-changed",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "User input",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 340,
        "y": 320,
        "wires": [
            [
                "b97bd9a51080da68"
            ]
        ]
    },
    {
        "id": "1247084c53315208",
        "type": "switch",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1395,
        "y": 360,
        "wires": [
            [
                "141ebe1a0441a814"
            ],
            [
                "de24e0e941d08b62"
            ]
        ],
        "l": false
    },
    {
        "id": "4b8c5bc2b8cf6c4d",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1620,
        "y": 340,
        "wires": []
    },
    {
        "id": "6e287097dc4e0236",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg cheap tariff",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 820,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "403a9dfa33392328",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg expensive tariff",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 830,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "67e38494d0337403",
        "type": "api-call-service",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Avg delta",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 800,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "f1168e015522bbfc",
        "type": "api-current-state",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "Threshold",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1300,
        "y": 360,
        "wires": [
            [
                "1247084c53315208"
            ]
        ]
    },
    {
        "id": "141ebe1a0441a814",
        "type": "change",
        "z": "95489b12daee74f5",
        "g": "9c68fafd28d3b4fc",
        "name": "null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1490,
        "y": 340,
        "wires": [
            [
                "4b8c5bc2b8cf6c4d"
            ]
        ]
    },
    {
        "id": "079e2531ed154c01",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "1237795be79af24c",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1260,
        "wires": []
    },
    {
        "id": "99545071b9bdfd66",
        "type": "debug",
        "z": "95489b12daee74f5",
        "g": "c6507e8b14c27c81",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1060,
        "wires": []
    },
    {
        "id": "6f08540f9f5fe765",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Max power solution",
        "func": "// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// battery life improvement (slow charge near max SoC)\n/**\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    if (soc == 100) return Math.min(0, max_power);\n    if (soc >= 98) return Math.min(300, max_power);\n    if (soc >= 95) return Math.min(500, max_power);\n    if (soc >= 85) return Math.min(1500, max_power);\n    return max_power;\n}\n\n// build solution\nmsg.batteries.forEach(battery => {\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: chargingLimiter(battery.soc, battery.charging_max)\n    });\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 260,
        "wires": [
            [
                "91b6cdbd01cd0f32"
            ]
        ]
    },
    {
        "id": "2b46959cdb3a5434",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 40,
        "wires": []
    },
    {
        "id": "62fe191e903de8b2",
        "type": "link in",
        "z": "517b5f5313a242c5",
        "g": "1df1a3a3dcbc7925",
        "name": "Charge",
        "links": [],
        "x": 185,
        "y": 180,
        "wires": [
            [
                "975b518a9af0ba5e"
            ]
        ]
    },
    {
        "id": "3c519efd38a22bf5",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "g": "1df1a3a3dcbc7925",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 120,
        "wires": []
    },
    {
        "id": "b5bd859bd4a37c5a",
        "type": "link out",
        "z": "517b5f5313a242c5",
        "g": "843e88284fbc94bf",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 75,
        "y": 500,
        "wires": []
    },
    {
        "id": "9e4f8a5401e67f74",
        "type": "comment",
        "z": "517b5f5313a242c5",
        "g": "843e88284fbc94bf",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 440,
        "wires": []
    },
    {
        "id": "975b518a9af0ba5e",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Desired energy reserve",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_timed_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_target_energy",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 390,
        "y": 160,
        "wires": [
            [
                "8f45bbf25d832781",
                "a46cfe2ab1e217ad"
            ]
        ]
    },
    {
        "id": "17407e109402eedb",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Or charge at max power?",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_max_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_max_power",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 870,
        "y": 160,
        "wires": [
            [
                "59946b67fc40e542"
            ]
        ]
    },
    {
        "id": "8f45bbf25d832781",
        "type": "api-current-state",
        "z": "517b5f5313a242c5",
        "g": "9e0b88ccf18279a0",
        "name": "Desired charging power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_timed_target_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_target_power",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 630,
        "y": 160,
        "wires": [
            [
                "17407e109402eedb"
            ]
        ]
    },
    {
        "id": "59946b67fc40e542",
        "type": "switch",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Check desired energy reserve",
        "property": "batteries_available_energy",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "house_battery_strategy_timed_target_energy",
                "vt": "msg"
            },
            {
                "t": "gte",
                "v": "house_battery_strategy_timed_target_energy",
                "vt": "msg"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 300,
        "wires": [
            [
                "9e65fbe7fb9407f5"
            ],
            [
                "558a963fa8d37e13"
            ]
        ],
        "info": "batteries_available_energy is calculated in the Start flow"
    },
    {
        "id": "ded0c5838fefe02a",
        "type": "link call",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1040,
        "y": 340,
        "wires": [
            [
                "5e0b433df0b89085",
                "25349ae9d88ba324"
            ]
        ]
    },
    {
        "id": "55e38b7af412c9b6",
        "type": "link call",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Call flow",
        "links": [
            "7a0cd93e9df76c48"
        ],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1040,
        "y": 300,
        "wires": [
            [
                "25349ae9d88ba324",
                "e0daa87d53914f89"
            ]
        ]
    },
    {
        "id": "9e65fbe7fb9407f5",
        "type": "switch",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Charge at max power",
        "property": "house_battery_strategy_timed_has_max_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "6f08540f9f5fe765"
            ],
            [
                "11a3c17551b6872e"
            ]
        ]
    },
    {
        "id": "5e0b433df0b89085",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Full stop",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1280,
        "y": 340,
        "wires": []
    },
    {
        "id": "e0daa87d53914f89",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1290,
        "y": 300,
        "wires": []
    },
    {
        "id": "8f3f500f37b1f30a",
        "type": "debug",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1280,
        "y": 260,
        "wires": []
    },
    {
        "id": "51c020c73fa6193c",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.payload | 0; // kWh\noutput = Math.max(msg.payload, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 60,
        "wires": [
            [
                "5145f9dafdea029b"
            ]
        ]
    },
    {
        "id": "5145f9dafdea029b",
        "type": "api-call-service",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Set desired energy reserve",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_timed_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 780,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "a46cfe2ab1e217ad",
        "type": "rbe",
        "z": "517b5f5313a242c5",
        "g": "69b5b1e8def42772",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 60,
        "wires": [
            [
                "51c020c73fa6193c"
            ]
        ]
    },
    {
        "id": "11a3c17551b6872e",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Regulated power",
        "func": "// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = msg.house_battery_strategy_timed_target_power;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 300,
        "wires": [
            [
                "55e38b7af412c9b6"
            ]
        ]
    },
    {
        "id": "558a963fa8d37e13",
        "type": "function",
        "z": "517b5f5313a242c5",
        "g": "38d625c4fd161b7b",
        "name": "Full stop ",
        "func": "msg.target = \"Full stop\";\nnode.status({fill:\"grey\",shape:\"dot\",text:`${Math.round(msg.batteries_available_energy*100)/100} of ${msg.house_battery_strategy_timed_target_energy} kWh in reserve`});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 340,
        "wires": [
            [
                "ded0c5838fefe02a"
            ]
        ]
    },
    {
        "id": "1c8192c80293e27a",
        "type": "link in",
        "z": "98fc68ae4f398f5a",
        "g": "854980688e5a33a2",
        "name": "Full stop",
        "links": [],
        "x": 165,
        "y": 180,
        "wires": [
            [
                "c2dafb1718d3fa5b"
            ]
        ]
    },
    {
        "id": "50211caba9c825b8",
        "type": "link out",
        "z": "98fc68ae4f398f5a",
        "g": "a5b4b50f7d24dc91",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "c2dafb1718d3fa5b",
        "type": "function",
        "z": "98fc68ae4f398f5a",
        "name": "Stop all batteries",
        "func": "// INPUT\n// Home Battery Start payload\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\nmsg.solutions = solution_array;\n\n//msg.payload = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "50211caba9c825b8",
                "8c372e745f92273f"
            ]
        ]
    },
    {
        "id": "2430b36fd85d2807",
        "type": "comment",
        "z": "98fc68ae4f398f5a",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "330c46043b601d46",
        "type": "comment",
        "z": "98fc68ae4f398f5a",
        "g": "a5b4b50f7d24dc91",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "1d8b882bd517ebe4",
        "type": "comment",
        "z": "98fc68ae4f398f5a",
        "g": "854980688e5a33a2",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "8c372e745f92273f",
        "type": "debug",
        "z": "98fc68ae4f398f5a",
        "name": "Batteries",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 480,
        "y": 300,
        "wires": []
    },
    {
        "id": "111ede9054c48ce8",
        "type": "http request",
        "z": "3e8b06dc3730a647",
        "name": "Haal DakOost op",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.solcast.com.au/rooftop_sites/9475-98a9-328a-5026/forecasts?format=json",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "other",
                "valueValue": "Bearer GOR6d3Wo45M10_tZvppgPrfo_IrdV7Nt"
            },
            {
                "keyType": "other",
                "keyValue": "Accept",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 490,
        "y": 120,
        "wires": [
            [
                "4f278b38206c6b93"
            ]
        ]
    },
    {
        "id": "26578c466a88f58e",
        "type": "http request",
        "z": "3e8b06dc3730a647",
        "name": "Haal DakZuid op",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.solcast.com.au/rooftop_sites/4d3f-4bf9-1b5a-3062/forecasts?format=json",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Authorization",
                "valueType": "other",
                "valueValue": "Bearer GOR6d3Wo45M10_tZvppgPrfo_IrdV7Nt"
            },
            {
                "keyType": "other",
                "keyValue": "Accept",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 490,
        "y": 220,
        "wires": [
            [
                "4f278b38206c6b93"
            ]
        ]
    },
    {
        "id": "6b23127d773d641c",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Elke dag 00:15",
        "props": [],
        "repeat": "",
        "crontab": "15 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 140,
        "wires": [
            [
                "111ede9054c48ce8",
                "7e42a01b0584940c"
            ]
        ]
    },
    {
        "id": "4f278b38206c6b93",
        "type": "join",
        "z": "3e8b06dc3730a647",
        "name": "Combineer beide sites",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "",
        "joiner": "",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 730,
        "y": 160,
        "wires": [
            [
                "0ccfd003903606c1"
            ]
        ]
    },
    {
        "id": "0ccfd003903606c1",
        "type": "function",
        "z": "3e8b06dc3730a647",
        "name": "Combineer, groupeer, maak Arrays en sla op in database",
        "func": "let raw_today = [];\nlet raw_tomorrow = [];\nlet inserts = [];\n\nconst combined = {};  // Key: tijdslot (ISO), Value: { sum, site1, site2 }\n\n// Formatter voor lokale tijd in Amsterdam met minuten\nconst formatter = new Intl.DateTimeFormat('sv-SE', {\n    timeZone: 'Europe/Amsterdam',\n    year: 'numeric',\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    hour12: false\n});\n\n// Vul de combined-tabel met per half uur data van beide sites\nmsg.payload.forEach((site, index) => {\n    site.forecasts.forEach(entry => {\n        const periodEnd = new Date(entry.period_end);\n        const periodStart = new Date(periodEnd.getTime() - 30 * 60 * 1000);  // 30 minuten terug\n\n        const isoKey = periodStart.toISOString(); // unieke sleutel op UTC\n        const kWh = entry.pv_estimate * 0.5;\n\n        if (!combined[isoKey]) {\n            combined[isoKey] = { sum: 0, dakoost: 0, dakzuid: 0 };\n        }\n\n        combined[isoKey].sum += kWh;\n        combined[isoKey][index === 0 ? 'dakoost' : 'dakzuid'] = kWh;\n    });\n});\n\n// Splits in raw_today en raw_tomorrow obv lokale datum\nconst keys = Object.keys(combined).sort();\nlet todayKey = null;\n\nkeys.forEach(isoKey => {\n    const periodStart = new Date(isoKey);\n    const parts = formatter.formatToParts(periodStart);\n    const datumStr = `${parts.find(p => p.type === 'year').value}-${parts.find(p => p.type === 'month').value}-${parts.find(p => p.type === 'day').value}`;\n\n    if (!todayKey) {\n        todayKey = datumStr;\n    }\n\n    const row = combined[isoKey];\n    const sumVal = parseFloat(row.sum.toFixed(2));\n    const valdakoost = parseFloat(row.dakoost.toFixed(2));\n    const valdakzuid = parseFloat(row.dakzuid.toFixed(2));\n\n    const record = {\n        start: periodStart.toISOString(),\n        value: sumVal,\n        dakoost: valdakoost,\n        dakzuid: valdakzuid\n    };\n\n    if (datumStr === todayKey) {\n        raw_today.push(record);\n    } else {\n        raw_tomorrow.push(record);\n    }\n\n    // Zet naar MySQL formaat\n    const mysqlDate = record.start.replace('T', ' ').replace('Z', '').split('.')[0];\n\n    const sql = `\n    INSERT INTO pv_forecast (period_start, pv_estimate_total, pv_estimate_oost, pv_estimate_zuid)\n    VALUES ('${mysqlDate}', ${sumVal}, ${valdakoost}, ${valdakzuid})\n    ON DUPLICATE KEY UPDATE\n      pv_estimate_total = VALUES(pv_estimate_total),\n      pv_estimate_oost = VALUES(pv_estimate_oost),\n      pv_estimate_zuid = VALUES(pv_estimate_zuid);`;\n\n    inserts.push({ topic: sql.trim() });\n});\n\nreturn [inserts];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 160,
        "wires": [
            [
                "9a1d0ea993717f86"
            ]
        ]
    },
    {
        "id": "98c6822ac925f40e",
        "type": "debug",
        "z": "3e8b06dc3730a647",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1230,
        "y": 760,
        "wires": []
    },
    {
        "id": "79d98c4a936221f5",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Elke dag 12:15",
        "props": [],
        "repeat": "",
        "crontab": "15 12 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 200,
        "wires": [
            [
                "111ede9054c48ce8",
                "7e42a01b0584940c"
            ]
        ]
    },
    {
        "id": "0ac1a9e6a037f709",
        "type": "debug",
        "z": "3e8b06dc3730a647",
        "name": "JSON Output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1400,
        "y": 380,
        "wires": []
    },
    {
        "id": "cb8c6c0eac9ff3d5",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Lees testbestand",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "date",
        "x": 140,
        "y": 380,
        "wires": [
            [
                "40b83f0115b1c6a1",
                "5ba925d395d0464e"
            ]
        ]
    },
    {
        "id": "40b83f0115b1c6a1",
        "type": "file in",
        "z": "3e8b06dc3730a647",
        "name": "Lees JSON Oost",
        "filename": "/data/testdata/oost_forecast.json",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": true,
        "encoding": "none",
        "allProps": false,
        "x": 530,
        "y": 360,
        "wires": [
            [
                "702f1473c9d6e812"
            ]
        ]
    },
    {
        "id": "702f1473c9d6e812",
        "type": "json",
        "z": "3e8b06dc3730a647",
        "name": "Parse JSON",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 710,
        "y": 360,
        "wires": [
            [
                "6cc3df8cf7dd8736"
            ]
        ]
    },
    {
        "id": "568551d12aaa1267",
        "type": "file in",
        "z": "3e8b06dc3730a647",
        "name": "Lees JSON Zuid",
        "filename": "/data/testdata/zuid_forecast.json",
        "filenameType": "str",
        "format": "utf8",
        "chunk": false,
        "sendError": true,
        "encoding": "none",
        "allProps": false,
        "x": 520,
        "y": 420,
        "wires": [
            [
                "5f097c4c0c14aba7"
            ]
        ]
    },
    {
        "id": "5f097c4c0c14aba7",
        "type": "json",
        "z": "3e8b06dc3730a647",
        "name": "Parse JSON",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 710,
        "y": 420,
        "wires": [
            [
                "6cc3df8cf7dd8736"
            ]
        ]
    },
    {
        "id": "6cc3df8cf7dd8736",
        "type": "join",
        "z": "3e8b06dc3730a647",
        "name": "Combineer beide sites",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "",
        "joiner": "",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 930,
        "y": 380,
        "wires": [
            [
                "0ccfd003903606c1"
            ]
        ]
    },
    {
        "id": "9a1d0ea993717f86",
        "type": "mysql",
        "z": "3e8b06dc3730a647",
        "mydb": "7866ece42093366f",
        "name": "Schrijf naar MariaDB",
        "x": 1500,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "ecd20bd21cfccdb8",
        "type": "function",
        "z": "3e8b06dc3730a647",
        "name": "Query vandaag",
        "func": "msg.topic = `\nSELECT \n  DATE_FORMAT(period_start, '%Y-%m-%dT%H:%i:%s.000Z') AS period_start, \n  pv_estimate_total,\n  pv_estimate_oost,\n  pv_estimate_zuid\nFROM pv_forecast\nWHERE period_start >= CONVERT_TZ(CURDATE(), '+02:00', '+00:00')\n  AND period_start < CONVERT_TZ(CURDATE() + INTERVAL 1 DAY, '+02:00', '+00:00')\nORDER BY period_start ASC;\n`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 640,
        "wires": [
            [
                "a8d2d2a2a8676134"
            ]
        ]
    },
    {
        "id": "8e9fca39b6cd1e9e",
        "type": "function",
        "z": "3e8b06dc3730a647",
        "name": "Query mogen",
        "func": "msg.topic = `\nSELECT \n  DATE_FORMAT(period_start, '%Y-%m-%dT%H:%i:%s.000Z') AS period_start, \n  pv_estimate_total,\n  pv_estimate_oost,\n  pv_estimate_zuid\nFROM pv_forecast\nWHERE period_start >= CONVERT_TZ(CURDATE() + INTERVAL 1 DAY, '+02:00', '+00:00')\n  AND period_start <  CONVERT_TZ(CURDATE() + INTERVAL 2 DAY, '+02:00', '+00:00')\nORDER BY period_start ASC;\n`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 700,
        "wires": [
            [
                "6085e2343b728f72"
            ]
        ]
    },
    {
        "id": "a8d2d2a2a8676134",
        "type": "mysql",
        "z": "3e8b06dc3730a647",
        "mydb": "7866ece42093366f",
        "name": "Query stroomprijzen vandaag",
        "x": 750,
        "y": 640,
        "wires": [
            [
                "b69c0f0f369ae83f"
            ]
        ]
    },
    {
        "id": "6085e2343b728f72",
        "type": "mysql",
        "z": "3e8b06dc3730a647",
        "mydb": "7866ece42093366f",
        "name": "Query stroomprijzen vandaag",
        "x": 750,
        "y": 700,
        "wires": [
            [
                "b69c0f0f369ae83f"
            ]
        ]
    },
    {
        "id": "b69c0f0f369ae83f",
        "type": "join",
        "z": "3e8b06dc3730a647",
        "name": "Combineer beide sites",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "",
        "joiner": "",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1030,
        "y": 660,
        "wires": [
            [
                "a30232f64ea837dc"
            ]
        ]
    },
    {
        "id": "a30232f64ea837dc",
        "type": "function",
        "z": "3e8b06dc3730a647",
        "name": "Format naar sensor JSON",
        "func": "const resultToday = msg.payload[0];\nconst resultTomorrow = msg.payload[1];\nconst raw_today = resultToday.map(r => {\n    return {\n        start: new Date(r.period_start).toISOString(),\n        pv_estimate_total: parseFloat(r.pv_estimate_total),\n        pv_estimate_oost: parseFloat(r.pv_estimate_oost),\n        pv_estimate_zuid: parseFloat(r.pv_estimate_zuid)\n\n    };\n});\nconst raw_tomorrow = resultTomorrow.map(r => {\n    return {\n        start: new Date(r.period_start).toISOString(),\n        pv_estimate_total: parseFloat(r.pv_estimate_total),\n        pv_estimate_oost: parseFloat(r.pv_estimate_oost),\n        pv_estimate_zuid: parseFloat(r.pv_estimate_zuid)\n    };\n});\n\nmsg.method = \"POST\";\nmsg.url = \"http://192.168.1.60:8123/api/states/sensor.pv_forecast_solcast\";\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjYTNlZGQ5YTk2OGM0YjEyYjVjYWZmZmFiZjc1MTk3NyIsImlhdCI6MTc1MDk3NTYwMCwiZXhwIjoyMDY2MzM1NjAwfQ.uIEtvoLdf-WnXL_peVenQAYU-F6VKDkXs3BhtSuEM8s\",\n    \"Content-Type\": \"application/json\"\n};\n\nmsg.payload = JSON.stringify({\n    state: new Date().toISOString(),\n    attributes: {\n        raw_today,\n        raw_tomorrow,\n        friendly_name: \"PV Forecast\",\n        unit_of_measurement: \"kWh\",\n        icon: \"mdi:white-balance-sunny\"\n    }\n});\n\n//node.warn(raw_today);\n//node.warn(raw_tomorrow);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 760,
        "wires": [
            [
                "4d23ac577e98fefd"
            ]
        ]
    },
    {
        "id": "4d23ac577e98fefd",
        "type": "http request",
        "z": "3e8b06dc3730a647",
        "name": "Push naar HA sensor",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1280,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "f98e6ab99691d1ff",
        "type": "delay",
        "z": "3e8b06dc3730a647",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 360,
        "y": 700,
        "wires": [
            [
                "8e9fca39b6cd1e9e"
            ]
        ]
    },
    {
        "id": "6a98fe5b2ab37d90",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Elke dag 00:20",
        "props": [],
        "repeat": "",
        "crontab": "20 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 640,
        "wires": [
            [
                "f98e6ab99691d1ff",
                "ecd20bd21cfccdb8"
            ]
        ]
    },
    {
        "id": "456b6acac738fba8",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Elke dag 12:20",
        "props": [],
        "repeat": "",
        "crontab": "20 12 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 720,
        "wires": [
            [
                "f98e6ab99691d1ff",
                "ecd20bd21cfccdb8"
            ]
        ]
    },
    {
        "id": "3a3215f88964fb95",
        "type": "inject",
        "z": "3e8b06dc3730a647",
        "name": "Elke dag 07:00",
        "props": [],
        "repeat": "",
        "crontab": "00 07 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 680,
        "wires": [
            [
                "f98e6ab99691d1ff",
                "ecd20bd21cfccdb8"
            ]
        ]
    },
    {
        "id": "7e42a01b0584940c",
        "type": "delay",
        "z": "3e8b06dc3730a647",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 220,
        "wires": [
            [
                "26578c466a88f58e"
            ]
        ]
    },
    {
        "id": "5ba925d395d0464e",
        "type": "delay",
        "z": "3e8b06dc3730a647",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 340,
        "y": 420,
        "wires": [
            [
                "568551d12aaa1267"
            ]
        ]
    },
    {
        "id": "a93e511ba86c6c32",
        "type": "function",
        "z": "3e8b06dc3730a647",
        "name": "Format naar sensor JSON",
        "func": "const resultToday = msg.payload[0];\nconst resultTomorrow = msg.payload[1];\nconst raw_today = resultToday.map(r => {\n    return {\n        start: new Date(r.period_start).toISOString(),\n        value: parseFloat(r.pv_estimate)\n    };\n});\nconst raw_tomorrow = resultTomorrow.map(r => {\n    return {\n        start: new Date(r.period_start).toISOString(),\n        value: parseFloat(r.pv_estimate)\n    };\n});\n\nmsg.method = \"POST\";\nmsg.url = \"http://192.168.1.60:8123/api/states/sensor.pv_forecast_solcast\";\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjYTNlZGQ5YTk2OGM0YjEyYjVjYWZmZmFiZjc1MTk3NyIsImlhdCI6MTc1MDk3NTYwMCwiZXhwIjoyMDY2MzM1NjAwfQ.uIEtvoLdf-WnXL_peVenQAYU-F6VKDkXs3BhtSuEM8s\",\n    \"Content-Type\": \"application/json\"\n};\n\nmsg.payload = JSON.stringify({\n    state: new Date().toISOString(),\n    attributes: {\n        raw_today,\n        raw_tomorrow,\n        friendly_name: \"PV Forecast\",\n        unit_of_measurement: \"kWh\",\n        icon: \"mdi:white-balance-sunny\"\n    }\n});\n\n\n//node.warn(raw_today);\n//node.warn(raw_tomorrow);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "2be383ed721a9932",
        "type": "inject",
        "z": "c1eebc49aa0331b9",
        "name": "Elke dag 00:15",
        "props": [],
        "repeat": "",
        "crontab": "15 0 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 200,
        "y": 100,
        "wires": [
            [
                "740f4c95b12f486f"
            ]
        ]
    },
    {
        "id": "740f4c95b12f486f",
        "type": "http request",
        "z": "c1eebc49aa0331b9",
        "name": "Jeroen API vandaag ophalen",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://jeroen.nl/api/dynamische-energieprijzen/v2/?period=vandaag&type=json&key=ea3a6447b1e585241798875905bb610abbb62047097a333e7e71657121b75c29",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 460,
        "y": 100,
        "wires": [
            [
                "9e6f42e577c03b92"
            ]
        ]
    },
    {
        "id": "9e6f42e577c03b92",
        "type": "function",
        "z": "c1eebc49aa0331b9",
        "name": "Maak SQL statements",
        "func": "let inserts = [];\n\nfor (let i = 0; i < msg.payload.length; i++) {\n    const item = msg.payload[i];\n    const datum_nl = item.datum_nl;\n    const datum_utc = item.datum_utc;\n    const prijs = item.prijs_excl_belastingen.replace(\",\", \".\");\n\n    const sql = `\n        INSERT INTO stroomprijzen (datum_nl, datum_utc, prijs_excl_belastingen)\n        VALUES ('${datum_nl}', '${datum_utc}', ${prijs})\n        ON DUPLICATE KEY UPDATE\n          datum_nl = VALUES(datum_nl),\n          prijs_excl_belastingen = VALUES(prijs_excl_belastingen);`;\n\n    inserts.push({ topic: sql });\n}\n\nreturn [inserts];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 120,
        "wires": [
            [
                "d6d943b7f65ac54b"
            ]
        ]
    },
    {
        "id": "d6d943b7f65ac54b",
        "type": "mysql",
        "z": "c1eebc49aa0331b9",
        "mydb": "7866ece42093366f",
        "name": "Schrijf naar MariaDB",
        "x": 1080,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "e37fcb52e7f8f882",
        "type": "inject",
        "z": "c1eebc49aa0331b9",
        "name": "Elke dag 16:05",
        "props": [],
        "repeat": "",
        "crontab": "05 16 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 200,
        "y": 160,
        "wires": [
            [
                "814fe7aea5d723de"
            ]
        ]
    },
    {
        "id": "814fe7aea5d723de",
        "type": "http request",
        "z": "c1eebc49aa0331b9",
        "name": "Jeroen API morgen ophalen",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://jeroen.nl/api/dynamische-energieprijzen/v2/?period=morgen&type=json&key=ea3a6447b1e585241798875905bb610abbb62047097a333e7e71657121b75c29",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 460,
        "y": 160,
        "wires": [
            [
                "9e6f42e577c03b92"
            ]
        ]
    },
    {
        "id": "c485502e037d9a57",
        "type": "mysql",
        "z": "c1eebc49aa0331b9",
        "mydb": "7866ece42093366f",
        "name": "Query stroomprijzen vandaag",
        "x": 770,
        "y": 420,
        "wires": [
            [
                "51a9c7e8f018316c"
            ]
        ]
    },
    {
        "id": "cf38e98f1ec0fbaa",
        "type": "http request",
        "z": "c1eebc49aa0331b9",
        "name": "Push naar HA sensor",
        "method": "use",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1580,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "0162e764b4c2873a",
        "type": "debug",
        "z": "c1eebc49aa0331b9",
        "name": "output",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 500,
        "wires": []
    },
    {
        "id": "e3bf43604974dceb",
        "type": "mysql",
        "z": "c1eebc49aa0331b9",
        "mydb": "7866ece42093366f",
        "name": "Query stroomprijzen vandaag",
        "x": 770,
        "y": 480,
        "wires": [
            [
                "51a9c7e8f018316c"
            ]
        ]
    },
    {
        "id": "9a573d0322e57c40",
        "type": "function",
        "z": "c1eebc49aa0331b9",
        "name": "Format naar sensor JSON",
        "func": "const resultToday = msg.payload[0];\nconst resultTomorrow = msg.payload[1];\nconst raw_today = resultToday.map(r => {\n    return {\n        start: new Date(r.datum_utc).toISOString(),\n        value: parseFloat(r.prijs_excl_belastingen)\n    };\n});\nconst raw_tomorrow = resultTomorrow.map(r => {\n    return {\n        start: new Date(r.datum_utc).toISOString(),\n        value: parseFloat(r.prijs_excl_belastingen)\n    };\n});\n\nmsg.method = \"POST\";\nmsg.url = \"http://192.168.1.60:8123/api/states/sensor.stroomprijzen_jeroen_vandaag\";\nmsg.headers = {\n    \"Authorization\": \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjYTNlZGQ5YTk2OGM0YjEyYjVjYWZmZmFiZjc1MTk3NyIsImlhdCI6MTc1MDk3NTYwMCwiZXhwIjoyMDY2MzM1NjAwfQ.uIEtvoLdf-WnXL_peVenQAYU-F6VKDkXs3BhtSuEM8s\",\n    \"Content-Type\": \"application/json\"\n};\n\nmsg.payload = JSON.stringify({\n    state: new Date().toISOString(),\n    attributes: {\n        raw_today: raw_today,\n        raw_tomorrow: raw_tomorrow,\n        friendly_name: \"Stroomprijzen Jeroen Vandaag\",\n        unit_of_measurement: \"c/kWh\",\n        icon: \"mdi:flash\"\n    }\n});\n\n\n//node.warn(raw_today);\n//node.warn(raw_tomorrow);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 440,
        "wires": [
            [
                "cf38e98f1ec0fbaa"
            ]
        ]
    },
    {
        "id": "6e5f137f125f4171",
        "type": "function",
        "z": "c1eebc49aa0331b9",
        "name": "Query Vandaag en morgen",
        "func": "msg.topic = `\nSELECT \n  DATE_FORMAT(datum_utc, '%Y-%m-%dT%H:%i:%s.000Z') AS datum_utc, \n  prijs_excl_belastingen\nFROM stroomprijzen\nWHERE datum_utc >= CONVERT_TZ(DATE(CONVERT_TZ(NOW(), '+00:00', '+02:00')), '+02:00', '+00:00')\n  AND datum_utc <  CONVERT_TZ(DATE(CONVERT_TZ(NOW(), '+00:00', '+02:00')) + INTERVAL 2 DAY, '+02:00', '+00:00')\nORDER BY datum_utc ASC;;\n`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "ee43ca942395e66a",
        "type": "function",
        "z": "c1eebc49aa0331b9",
        "name": "Query vandaag",
        "func": "msg.topic = `\nSELECT \n  DATE_FORMAT(datum_utc, '%Y-%m-%dT%H:%i:%s.000Z') AS datum_utc, \n  prijs_excl_belastingen\nFROM stroomprijzen\nWHERE datum_utc >= CONVERT_TZ(CURDATE(), '+02:00', '+00:00')\n  AND datum_utc < CONVERT_TZ(CURDATE() + INTERVAL 1 DAY, '+02:00', '+00:00')\nORDER BY datum_utc ASC;\n`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 420,
        "wires": [
            [
                "c485502e037d9a57"
            ]
        ]
    },
    {
        "id": "15c60779f594896a",
        "type": "function",
        "z": "c1eebc49aa0331b9",
        "name": "Query mogen",
        "func": "msg.topic = `\nSELECT \n  DATE_FORMAT(datum_utc, '%Y-%m-%dT%H:%i:%s.000Z') AS datum_utc, \n  prijs_excl_belastingen\nFROM stroomprijzen\nWHERE datum_utc >= CONVERT_TZ(CURDATE() + INTERVAL 1 DAY, '+02:00', '+00:00')\n  AND datum_utc <  CONVERT_TZ(CURDATE() + INTERVAL 2 DAY, '+02:00', '+00:00')\nORDER BY datum_utc ASC;\n`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 480,
        "wires": [
            [
                "e3bf43604974dceb"
            ]
        ]
    },
    {
        "id": "51a9c7e8f018316c",
        "type": "join",
        "z": "c1eebc49aa0331b9",
        "name": "Combineer beide sites",
        "mode": "custom",
        "build": "array",
        "property": "payload",
        "propertyType": "msg",
        "key": "",
        "joiner": "",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 1050,
        "y": 440,
        "wires": [
            [
                "9a573d0322e57c40",
                "0162e764b4c2873a"
            ]
        ]
    },
    {
        "id": "ccafae1e1627f7f2",
        "type": "delay",
        "z": "c1eebc49aa0331b9",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 360,
        "y": 460,
        "wires": [
            [
                "ee43ca942395e66a",
                "15c60779f594896a"
            ]
        ]
    },
    {
        "id": "b5da7a98a7faa909",
        "type": "inject",
        "z": "c1eebc49aa0331b9",
        "name": "Elke dag 00:20",
        "props": [],
        "repeat": "",
        "crontab": "20 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 400,
        "wires": [
            [
                "ccafae1e1627f7f2"
            ]
        ]
    },
    {
        "id": "ed2c925b5b1de76a",
        "type": "inject",
        "z": "c1eebc49aa0331b9",
        "name": "Elke dag 16:10",
        "props": [],
        "repeat": "",
        "crontab": "10 16 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 500,
        "wires": [
            [
                "ccafae1e1627f7f2"
            ]
        ]
    },
    {
        "id": "75394d3adc3b28b6",
        "type": "inject",
        "z": "c1eebc49aa0331b9",
        "name": "Elke dag 07:00",
        "props": [],
        "repeat": "",
        "crontab": "00 07 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 460,
        "wires": [
            [
                "ccafae1e1627f7f2"
            ]
        ]
    },
    {
        "id": "4d4d4d4d4d4d4d4d",
        "type": "mysql",
        "z": "a28e37027e3020f1",
        "mydb": "7866ece42093366f",
        "name": "Voer uit in MariaDB",
        "x": 950,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "8a12b849f75fd6c6",
        "type": "inject",
        "z": "a28e37027e3020f1",
        "d": true,
        "name": "Dagelijks om 00:00",
        "props": [],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 200,
        "y": 60,
        "wires": [
            [
                "0f07a8950542578e"
            ]
        ]
    },
    {
        "id": "50c687f8246c99ed",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Genereer SQL queries",
        "func": "// Basisconfiguratie\nconst accu_ids = ['m1', 'm2', 'm3'];\nconst periodes = ['day', 'week', 'month', 'year'];\nconst now = new Date();\n\n//\t\tweek: pakt maandag van deze week\n//\t\tmonth: pakt 1e van de maand\n//\t\tyear: pakt 1 januari\n\nfunction getPeriodStart(type, date) {\n    const d = new Date(date);\n    if (type === 'day') {\n        d.setHours(0, 0, 0, 0);\n    } else if (type === 'week') {\n        const diff = d.getDate() - d.getDay();\n        d.setDate(diff);\n        d.setHours(0, 0, 0, 0);\n    } else if (type === 'month') {\n        d.setDate(1);\n        d.setHours(0, 0, 0, 0);\n    } else if (type === 'year') {\n        d.setMonth(0);\n        d.setDate(1);\n        d.setHours(0, 0, 0, 0);\n    }\n    return d.toISOString().slice(0, 10);\n}\n\nlet queries = [];\n\nfor (let id of accu_ids) {\n    for (let p of periodes) {\n        const laad = flow.get(`${id}_daily_charging_energy`) || 0;\n        const ontlaad = flow.get(`${id}_daily_discharging_energy`) || 0;\n        const start = getPeriodStart(p, now);\n        const id_upper = id.toUpperCase(); // voor de query\n        const query = `INSERT INTO battery_RTE_calculations (accu_id, periode_type, periode_start, charging_kwh, discharging_kwh) VALUES ('${id_upper}', '${p}', '${start}', ${laad}, ${ontlaad}) ON DUPLICATE KEY UPDATE charging_kwh = ${laad}, discharging_kwh = ${ontlaad};`;\n        queries.push(query);\n    }\n}\n\nmsg.payload = queries;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 220,
        "wires": [
            [
                "80a32eaa8a3b2541"
            ]
        ]
    },
    {
        "id": "80a32eaa8a3b2541",
        "type": "split",
        "z": "a28e37027e3020f1",
        "name": "Split per query",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 520,
        "y": 220,
        "wires": [
            [
                "55e6d053a5f7f251"
            ]
        ]
    },
    {
        "id": "55e6d053a5f7f251",
        "type": "change",
        "z": "a28e37027e3020f1",
        "name": "Query  topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 220,
        "wires": [
            [
                "9e5489370930208a",
                "4d4d4d4d4d4d4d4d"
            ]
        ]
    },
    {
        "id": "9e5489370930208a",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Node.warn",
        "func": "node.warn(msg.topic);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "0f07a8950542578e",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M1 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m1_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 510,
        "y": 60,
        "wires": [
            [
                "b5bb3ae643e85561"
            ]
        ]
    },
    {
        "id": "b5bb3ae643e85561",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M1 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m1_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 740,
        "y": 60,
        "wires": [
            [
                "fceb50087958f90b"
            ]
        ]
    },
    {
        "id": "fceb50087958f90b",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M2 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m2_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 970,
        "y": 60,
        "wires": [
            [
                "af4fde879f503a69"
            ]
        ]
    },
    {
        "id": "af4fde879f503a69",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M2 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m2_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 520,
        "y": 120,
        "wires": [
            [
                "b1519795d1633f01"
            ]
        ]
    },
    {
        "id": "b1519795d1633f01",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M3 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m3_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 120,
        "wires": [
            [
                "f9a13f439f1b429f"
            ]
        ]
    },
    {
        "id": "f9a13f439f1b429f",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M3 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m3_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 980,
        "y": 120,
        "wires": [
            [
                "50c687f8246c99ed"
            ]
        ]
    },
    {
        "id": "bb07b4db365d597d",
        "type": "mysql",
        "z": "a28e37027e3020f1",
        "mydb": "7866ece42093366f",
        "name": "Voer uit in MariaDB",
        "x": 1190,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "1dca2a3946cc435c",
        "type": "inject",
        "z": "a28e37027e3020f1",
        "name": "Dagelijks om 00:00",
        "props": [],
        "repeat": "",
        "crontab": "00 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 200,
        "y": 440,
        "wires": [
            [
                "8b934e4588167a6f"
            ]
        ]
    },
    {
        "id": "7f1bba1063694928",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Genereer SQL queries",
        "func": "const accu_ids = ['m1', 'm2', 'm3'];\nconst now = new Date();\n\n// Alleen dagperiode\nfunction getToday(date) {\n    const d = new Date(date);\n    d.setHours(0, 0, 0, 0);\n    return d.toISOString().slice(0, 10);\n}\n\nlet queries = [];\n\nfor (let id of accu_ids) {\n    const laad = flow.get(`${id}_daily_charging_energy`) || 0;\n    const ontlaad = flow.get(`${id}_daily_discharging_energy`) || 0;\n    const id_upper = id.toUpperCase();\n    const today = getToday(now);\n\n    const query = `INSERT INTO battery_RTE_calculations (accu_id, periode_type, periode_start, charging_kwh, discharging_kwh) VALUES ('${id_upper}', 'day', '${today}', ${laad}, ${ontlaad});`;\n\n    queries.push(query);\n}\n\nmsg.payload = queries;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 600,
        "wires": [
            [
                "e2541c3936283212"
            ]
        ]
    },
    {
        "id": "e2541c3936283212",
        "type": "split",
        "z": "a28e37027e3020f1",
        "name": "Split per query",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 520,
        "y": 600,
        "wires": [
            [
                "c6cd3e8dc99ea9ab"
            ]
        ]
    },
    {
        "id": "c6cd3e8dc99ea9ab",
        "type": "change",
        "z": "a28e37027e3020f1",
        "name": "Query  topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 600,
        "wires": [
            [
                "bb07b4db365d597d"
            ]
        ]
    },
    {
        "id": "1ca1a2375eebd176",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Node.warn",
        "func": "node.warn(msg.topic);",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "8b934e4588167a6f",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M1 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m1_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 510,
        "y": 440,
        "wires": [
            [
                "4007360fdef4584c"
            ]
        ]
    },
    {
        "id": "4007360fdef4584c",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M1 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m1_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 740,
        "y": 440,
        "wires": [
            [
                "da2b216df7991c16"
            ]
        ]
    },
    {
        "id": "da2b216df7991c16",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M2 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m2_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 970,
        "y": 440,
        "wires": [
            [
                "d011f914c06ac6c3"
            ]
        ]
    },
    {
        "id": "d011f914c06ac6c3",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M2 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m2_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 520,
        "y": 500,
        "wires": [
            [
                "51a89d42756b16a3"
            ]
        ]
    },
    {
        "id": "51a89d42756b16a3",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M3 Daily Charging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_daily_charging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m3_daily_charging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 500,
        "wires": [
            [
                "bbf1e35ad88280a1"
            ]
        ]
    },
    {
        "id": "bbf1e35ad88280a1",
        "type": "api-current-state",
        "z": "a28e37027e3020f1",
        "name": "M3 Daily Discharging",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_daily_discharging_energy",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "m3_daily_discharging_energy",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 980,
        "y": 500,
        "wires": [
            [
                "7f1bba1063694928"
            ]
        ]
    },
    {
        "id": "0cab6e40916e287d",
        "type": "inject",
        "z": "a28e37027e3020f1",
        "name": "Dagelijks om 00:01",
        "props": [],
        "repeat": "",
        "crontab": "01 00 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 200,
        "y": 700,
        "wires": [
            [
                "be2ac341d65c5c6c",
                "f7e57b8ea2c9890e",
                "f4c88c4e6c547748"
            ]
        ]
    },
    {
        "id": "be2ac341d65c5c6c",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Genereer SQL week query",
        "func": "const accu_ids = ['M1', 'M2', 'M3'];\n\n// Tijdzone-correctie forceren met UTC-midnight\nfunction getMonday(date) {\n    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    const day = d.getUTCDay(); // 0 (zondag) tot 6 (zaterdag)\n    const diff = (day + 6) % 7; // Zondag  6, Maandag  0, etc.\n    d.setUTCDate(d.getUTCDate() - diff);\n    return d;\n}\n\nconst now = new Date();\nconst startOfWeek = getMonday(now);\nconst endOfWeek = new Date(startOfWeek);\nendOfWeek.setUTCDate(startOfWeek.getUTCDate() + 6);\n\n// Maak ISO strings in UTC\nconst startStr = startOfWeek.toISOString().slice(0, 10);\nconst endStr = endOfWeek.toISOString().slice(0, 10);\n\nnode.warn(`Start van de week: ${startStr}`);\nnode.warn(`Einde van de week: ${endStr}`);\n\nlet queries = [];\n\nfor (let id of accu_ids) {\n    const query = `\nINSERT INTO battery_RTE_calculations (accu_id, periode_type, periode_start, charging_kwh, discharging_kwh)\nSELECT \n    '${id}', \n    'week', \n    '${startStr}', \n    SUM(charging_kwh), \n    SUM(discharging_kwh)\nFROM battery_RTE_calculations\nWHERE \n    periode_type = 'day'\n    AND accu_id = '${id}'\n    AND periode_start >= '${startStr}' \n    AND periode_start <= '${endStr}'\nON DUPLICATE KEY UPDATE \n    charging_kwh = VALUES(charging_kwh),\n    discharging_kwh = VALUES(discharging_kwh);`.trim();\n\n    queries.push(query);\n}\n\nmsg.payload = queries;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 700,
        "wires": [
            [
                "36720e940331c631"
            ]
        ]
    },
    {
        "id": "cf6f89cd8b7617e6",
        "type": "change",
        "z": "a28e37027e3020f1",
        "name": "Query  topic",
        "rules": [
            {
                "t": "set",
                "p": "topic",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1080,
        "y": 700,
        "wires": [
            [
                "1ca1a2375eebd176",
                "bb07b4db365d597d"
            ]
        ]
    },
    {
        "id": "1739bbe95ffaac0c",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Genereer SQL maand query",
        "func": "const accu_ids = ['M1', 'M2', 'M3'];\nconst now = new Date();\n\n// Maandberekening op basis van lokale tijd\nconst startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\nstartOfMonth.setHours(0, 0, 0, 0);\n\nconst endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\nendOfMonth.setHours(23, 59, 59, 999);\n\n// Gebruik lokale datumweergave i.p.v. UTC (toISOString)\nconst formatDate = (d) =>\n    d.getFullYear() + '-' +\n    String(d.getMonth() + 1).padStart(2, '0') + '-' +\n    String(d.getDate()).padStart(2, '0');\n\nconst startStr = formatDate(startOfMonth);\nconst endStr = formatDate(endOfMonth);\n\nlet queries = [];\n\nfor (let id of accu_ids) {\n    const query = `\nINSERT INTO battery_RTE_calculations (accu_id, periode_type, periode_start, charging_kwh, discharging_kwh)\nSELECT \n    '${id}', \n    'month', \n    '${startStr}', \n    SUM(charging_kwh), \n    SUM(discharging_kwh)\nFROM battery_RTE_calculations\nWHERE \n    periode_type = 'day'\n    AND accu_id = '${id}'\n    AND periode_start >= '${startStr}' \n    AND periode_start <= '${endStr}'\nON DUPLICATE KEY UPDATE \n    charging_kwh = VALUES(charging_kwh),\n    discharging_kwh = VALUES(discharging_kwh);`.trim();\n\n    queries.push(query);\n}\n\nmsg.payload = queries;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 760,
        "wires": [
            [
                "7a5c51bc7558e474"
            ]
        ]
    },
    {
        "id": "f7e57b8ea2c9890e",
        "type": "delay",
        "z": "a28e37027e3020f1",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 440,
        "y": 760,
        "wires": [
            [
                "1739bbe95ffaac0c"
            ]
        ]
    },
    {
        "id": "5527ab79363c89bd",
        "type": "function",
        "z": "a28e37027e3020f1",
        "name": "Genereer SQL jaar query",
        "func": "const accu_ids = ['M1', 'M2', 'M3'];\nconst now = new Date();\n\n// Jaarberekening (lokaal)\nconst startOfYear = new Date(now.getFullYear(), 0, 1); // 1 januari\nstartOfYear.setHours(0, 0, 0, 0);\n\nconst endOfYear = new Date(now.getFullYear(), 11, 31); // 31 december\nendOfYear.setHours(23, 59, 59, 999);\n\n// Formatter zonder toISOString\nconst formatDate = (d) =>\n    d.getFullYear() + '-' +\n    String(d.getMonth() + 1).padStart(2, '0') + '-' +\n    String(d.getDate()).padStart(2, '0');\n\nconst startStr = formatDate(startOfYear);\nconst endStr = formatDate(endOfYear);\n\nlet queries = [];\n\nfor (let id of accu_ids) {\n    const query = `\nINSERT INTO battery_RTE_calculations (accu_id, periode_type, periode_start, charging_kwh, discharging_kwh)\nSELECT \n    '${id}', \n    'year', \n    '${startStr}', \n    SUM(charging_kwh), \n    SUM(discharging_kwh)\nFROM battery_RTE_calculations\nWHERE \n    periode_type = 'day'\n    AND accu_id = '${id}'\n    AND periode_start >= '${startStr}' \n    AND periode_start <= '${endStr}'\nON DUPLICATE KEY UPDATE \n    charging_kwh = VALUES(charging_kwh),\n    discharging_kwh = VALUES(discharging_kwh);`.trim();\n\n    queries.push(query);\n}\n\nmsg.payload = queries;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 820,
        "wires": [
            [
                "6d95c02885d92c2c"
            ]
        ]
    },
    {
        "id": "f4c88c4e6c547748",
        "type": "delay",
        "z": "a28e37027e3020f1",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 440,
        "y": 820,
        "wires": [
            [
                "5527ab79363c89bd"
            ]
        ]
    },
    {
        "id": "6d95c02885d92c2c",
        "type": "split",
        "z": "a28e37027e3020f1",
        "name": "Split per query",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 860,
        "y": 820,
        "wires": [
            [
                "cf6f89cd8b7617e6"
            ]
        ]
    },
    {
        "id": "7a5c51bc7558e474",
        "type": "split",
        "z": "a28e37027e3020f1",
        "name": "Split per query",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 860,
        "y": 760,
        "wires": [
            [
                "cf6f89cd8b7617e6"
            ]
        ]
    },
    {
        "id": "36720e940331c631",
        "type": "split",
        "z": "a28e37027e3020f1",
        "name": "Split per query",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "property": "payload",
        "x": 860,
        "y": 700,
        "wires": [
            [
                "cf6f89cd8b7617e6"
            ]
        ]
    },
    {
        "id": "0c9ec42ef3dfc6ed",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M1 Power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_ac_power",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M1_power",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 110,
        "y": 260,
        "wires": [
            [
                "5ddabe32caa4ce54"
            ]
        ]
    },
    {
        "id": "5ddabe32caa4ce54",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M2 Power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_ac_power",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M2_power",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 280,
        "y": 260,
        "wires": [
            [
                "df556992d0665b5a"
            ]
        ]
    },
    {
        "id": "7197b79701c12027",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M1 SoC",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_battery_state_of_charge",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M1_SoC",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 100,
        "y": 340,
        "wires": [
            [
                "a207ee4903c83979"
            ]
        ]
    },
    {
        "id": "a207ee4903c83979",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M2 SoC",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_battery_state_of_charge",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M2_SoC",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 280,
        "y": 340,
        "wires": [
            [
                "1d93bd7e7dd036f7"
            ]
        ]
    },
    {
        "id": "9bad8f72fbf8f3a7",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "M1 watt",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1420,
        "y": 460,
        "wires": []
    },
    {
        "id": "1e72fc77d6bbf209",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "M2 watt",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1420,
        "y": 500,
        "wires": []
    },
    {
        "id": "278cefb00810de4d",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output (dis)charge power M2",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "number.marstek_m2_forcible_discharge_power",
            "number.marstek_m2_forcible_charge_power"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "number",
        "service": "set_value",
        "x": 1160,
        "y": 500,
        "wires": [
            [
                "1e72fc77d6bbf209"
            ]
        ]
    },
    {
        "id": "f198730a1a00a89e",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output (dis)charge power M1",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "number.marstek_m1_forcible_discharge_power",
            "number.marstek_m1_forcible_charge_power"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "number",
        "service": "set_value",
        "x": 1160,
        "y": 460,
        "wires": [
            [
                "9bad8f72fbf8f3a7"
            ]
        ]
    },
    {
        "id": "bcf966686dbfe1e1",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output charge/discharge/stop M1",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "select.marstek_m1_forcible_charge_discharge"
        ],
        "labelId": [],
        "data": "{\"option\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "select",
        "service": "select_option",
        "x": 1180,
        "y": 320,
        "wires": [
            [
                "36ad176ec74cba02"
            ]
        ]
    },
    {
        "id": "36ad176ec74cba02",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "Charge/discharge/stop M1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1480,
        "y": 320,
        "wires": []
    },
    {
        "id": "ee48928bc4959af0",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "Gewenste P1 vermogen",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.gewenste_p1_vermogen",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "Gewenste_P1_vermogen",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "93ee83fa6d4c6f15"
            ]
        ]
    },
    {
        "id": "93ee83fa6d4c6f15",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M1 control mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m1_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M1_rs485_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 500,
        "wires": [
            [
                "c206e3f00996ecbf"
            ]
        ]
    },
    {
        "id": "c206e3f00996ecbf",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M2 control mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m2_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M2_rs485_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 500,
        "wires": [
            [
                "a768670db7ef24e0"
            ]
        ]
    },
    {
        "id": "494b6679ec6769d3",
        "type": "mysql",
        "z": "fe8fcf9c18073d0e",
        "mydb": "7866ece42093366f",
        "name": "LogData in Databank",
        "x": 1460,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "0423ede035d6a94a",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "name": "Maak logstring",
        "func": "//node.warn(msg.logtitel);\nvar timestamp = new Date().toLocaleTimeString('nl-NL', { hour12: false });\n\nmsg.payload = timestamp + \" | \" + msg.logdata;\nlet query = \"INSERT INTO `marstek_logData` (`Id`, `Tijd`, `Logtitel`, `Logstring`) VALUES (NULL, NOW(), '\" + msg.logtitel + \"', '\" + msg.logdata + \"')\";\nmsg.topic = query;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 600,
        "wires": [
            [
                "494b6679ec6769d3"
            ]
        ]
    },
    {
        "id": "2f970ea30074d9e8",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M1 inverter state",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m1_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M1_inverter_state",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 580,
        "wires": [
            [
                "6ac3ee9f29072f5c"
            ]
        ]
    },
    {
        "id": "6ac3ee9f29072f5c",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M2 inverter state",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m2_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M2_inverter_state",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 580,
        "wires": [
            [
                "6050e8ba33566b26"
            ]
        ]
    },
    {
        "id": "6eec2d15a231fcd8",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output charge/discharge/stop M2",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "select.marstek_m2_forcible_charge_discharge"
        ],
        "labelId": [],
        "data": "{\"option\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "select",
        "service": "select_option",
        "x": 1180,
        "y": 360,
        "wires": [
            [
                "946a89221425acf1"
            ]
        ]
    },
    {
        "id": "946a89221425acf1",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "Charge/discharge/stop M2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1480,
        "y": 360,
        "wires": []
    },
    {
        "id": "df556992d0665b5a",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M3 Power",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_ac_power",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M3_power",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 480,
        "y": 260,
        "wires": [
            [
                "7197b79701c12027"
            ]
        ]
    },
    {
        "id": "1d93bd7e7dd036f7",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M3 SoC",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_battery_state_of_charge",
        "state_type": "num",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M3_SoC",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 440,
        "y": 340,
        "wires": [
            [
                "ee48928bc4959af0"
            ]
        ]
    },
    {
        "id": "a768670db7ef24e0",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M3 control mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m3_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M3_rs485_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 500,
        "wires": [
            [
                "2f970ea30074d9e8"
            ]
        ]
    },
    {
        "id": "6050e8ba33566b26",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "M3 inverter state",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m3_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "M3_inverter_state",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 580,
        "wires": [
            [
                "e1f180f65443f58a"
            ]
        ]
    },
    {
        "id": "8aaf1f48d7b54a9d",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output charge/discharge/stop M3",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "select.select_option",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "select.marstek_m3_forcible_charge_discharge"
        ],
        "labelId": [],
        "data": "{\"option\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "select",
        "service": "select_option",
        "x": 1180,
        "y": 400,
        "wires": [
            [
                "777f6953e79b9f5d"
            ]
        ]
    },
    {
        "id": "8cbfcfe6b9353035",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "name": "Output (dis)charge power M3",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "number.marstek_m3_forcible_discharge_power",
            "number.marstek_m3_forcible_charge_power"
        ],
        "labelId": [],
        "data": "{\"value\":\"{{ payload }}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "number",
        "service": "set_value",
        "x": 1160,
        "y": 540,
        "wires": [
            [
                "350d32edac2d8389"
            ]
        ]
    },
    {
        "id": "350d32edac2d8389",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "M3 watt",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1420,
        "y": 540,
        "wires": []
    },
    {
        "id": "777f6953e79b9f5d",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "Charge/discharge/stop M3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1480,
        "y": 400,
        "wires": []
    },
    {
        "id": "7e6573652cf8820f",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "name": "Bereken P1 update snelheid",
        "func": "// Huidige tijd in ms\nlet now = Date.now();\n\n// Haal vorige timestamp op\nlet previousTimestamp = flow.get(\"p1_prev_timestamp\") || now;\n\n// Bereken tijdsverschil in seconden\nlet deltaSeconds = Math.round((now - previousTimestamp) / 1000);\n\n// Sla nieuwe timestamp op voor de volgende keer\nflow.set(\"p1_prev_timestamp\", now);\n\n// Haal lijst van vorige tijdsverschillen op\nlet deltas = flow.get(\"p1_trigger_deltas\") || [];\n\n// Voeg nieuwe toe aan lijst\ndeltas.push(deltaSeconds);\n\n// Behoud alleen de laatste 20\nif (deltas.length > 20) {\n    deltas.shift(); // verwijder oudste\n}\n\n// Sla bijgewerkte lijst op\nflow.set(\"p1_trigger_deltas\", deltas);\nnode.warn(\"Laatste 20 triggerintervallen (seconden): \" + JSON.stringify(deltas));\n\n// Voeg data toe aan msg voor debug of verder gebruik\n//msg.delta_seconds = deltaSeconds;\n//msg.delta_list = deltas;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 40,
        "wires": [
            []
        ]
    },
    {
        "id": "a1",
        "type": "tcp in",
        "z": "fe8fcf9c18073d0e",
        "d": true,
        "g": "d8201df108b3cdbd",
        "name": "ESP-link TCP DSMR",
        "server": "client",
        "host": "192.168.1.30",
        "port": "23",
        "datamode": "stream",
        "datatype": "utf8",
        "newline": "",
        "topic": "",
        "trim": false,
        "base64": false,
        "tls": "",
        "x": 850,
        "y": 80,
        "wires": [
            [
                "a2"
            ]
        ]
    },
    {
        "id": "a2",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "d8201df108b3cdbd",
        "name": "Buffer DSMR telegrams",
        "func": "let buffer = flow.get('dsmr_buffer') || '';\nbuffer += msg.payload;\n\n// Zorg dat we pas bufferen vanaf een echte start van een telegram\nif (!buffer.startsWith('/')) {\n    const start = buffer.indexOf('/');\n    if (start >= 0) {\n        buffer = buffer.slice(start);\n    } else {\n        // Geen start gevonden, wachten op volgende input\n        return null;\n    }\n}\n\nlet telegrams = [];\n\nwhile (buffer.includes('!')) {\n    const start = buffer.indexOf('/');\n    const end = buffer.indexOf('!') + 1;\n\n    if (start >= 0 && end > start) {\n        const telegram = buffer.slice(start, end);\n        telegrams.push({ payload: telegram });\n        buffer = buffer.slice(end);\n    } else {\n        break;\n    }\n}\n\nflow.set('dsmr_buffer', buffer);\nreturn telegrams;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "0d5416494aa26bd2",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "g": "d8201df108b3cdbd",
        "name": "P1 ESP-LINK",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1660,
        "y": 100,
        "wires": []
    },
    {
        "id": "e1f180f65443f58a",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "name": "Berekeningen",
        "func": "\nvar P1_power = flow.get(\"P1_power\"); //verbruik is positief\nvar Gewenste_P1_vermogen = flow.get(\"Gewenste_P1_vermogen\");\nvar M1_power = flow.get(\"M1_power\"); //ontladen is positief, laden is negatief\nvar M2_power = flow.get(\"M2_power\"); //ontladen is positief, laden is negatief\nvar M3_power = flow.get(\"M3_power\"); //ontladen is positief, laden is negatief\n\nvar M1_power_soll = flow.get(\"M1_power_soll\"); // vorige consigne/toewijzing\nvar M2_power_soll = flow.get(\"M2_power_soll\"); // vorige consigne/toewijzing\nvar M3_power_soll = flow.get(\"M3_power_soll\"); // vorige consigne/toewijzing\n\nvar M1_SoC = flow.get(\"M1_SoC\");\nvar M2_SoC = flow.get(\"M2_SoC\");\nvar M3_SoC = flow.get(\"M3_SoC\");\n\nvar M1_boven_hysterese_geweest = flow.get(\"M1_boven_hysterese_geweest\");\nvar M2_boven_hysterese_geweest = flow.get(\"M2_boven_hysterese_geweest\");\nvar M3_boven_hysterese_geweest = flow.get(\"M3_boven_hysterese_geweest\");\n\nvar M1_rs485_mode = flow.get(\"M1_rs485_mode\");\nvar M2_rs485_mode = flow.get(\"M2_rs485_mode\");\nvar M3_rs485_mode = flow.get(\"M3_rs485_mode\");\n\nvar M1_laatste_volstand = flow.get(\"M1_laatste_volstand\"); // in milliseconden sinds 1970\nvar M2_laatste_volstand = flow.get(\"M2_laatste_volstand\"); // in milliseconden sinds 1970\nvar M3_laatste_volstand = flow.get(\"M3_laatste_volstand\"); // in milliseconden sinds 1970\n\nvar enkel_zon_en_batterij_laden = global.get(\"enkel_zon_en_batterij_laden\");\nvar mono_bedrijf = flow.get(\"mono_bedrijf\");\nvar M1_enkel_laden = false;\nvar M2_enkel_laden = false;\nvar M3_enkel_laden = false;\n\nvar Laden = true;\nvar VorigLaden = flow.get(\"Laden\");\nvar M1_fractie_laden = 0;\nvar M1_fractie_ontladen = 0;\nvar M2_fractie_laden = 0;\nvar M2_fractie_ontladen = 0;\nvar M3_fractie_laden = 0;\nvar M3_fractie_ontladen = 0;\nvar M1_status = \"stop\";\nvar M2_status = \"stop\";\nvar M3_status = \"stop\";\nvar hysterese_waarde = 15;\n\nconst minSoC = 11; //minimaal percentage dat de accus mogen ontladen\nconst maxWattPerAccu = 2500; //maximaal vermogen dat de accus mogen laden. Zie ook functie 'bepaalOplaadLimiet'\nconst totaal_accus = 3;  // of zet dit dynamisch via flow/ctx\n\nvar max_aantal_milliseconden_sinds_laatste_vol = 14 * 24 * 3600 * 1000; // 14 dagen\n//var nul_of_een = 0;\nvar logdata = \"\";\n\nfunction bepaalOplaadLimiet(soc) {\n    if (soc >= 98) return 200;\n    if (soc >= 95) return 500;\n    if (soc >= 85) return 1000;\n    return maxWattPerAccu;\n}\n\n//Onderstaande moet tussen 0 en 1 zijn. \n//Dient om onstabiliteit tegen te gaan door vorige waarden al dan niet gedeeltelijk mee te nemen in berekening volgende waarde\n//0 = vorige waarde wordt niet meegenomen, 1 = enkel vorige waarde wordt meegenomen\nvar afzwakking = 0.2;\n\n//Indien meer dan 2 weken niet meer op volstand geweest, dan dwingen volledig op te laden, maar nooit beide batterijen tegelijk\nif (Date.now() - M1_laatste_volstand > max_aantal_milliseconden_sinds_laatste_vol) {\n    M1_enkel_laden = true;\n}\nelse if (Date.now() - M2_laatste_volstand > max_aantal_milliseconden_sinds_laatste_vol) {\n    M2_enkel_laden = true;\n}\nelse if (Date.now() - M3_laatste_volstand > max_aantal_milliseconden_sinds_laatste_vol) {\n    M3_enkel_laden = true;\n}\n\nif (M1_SoC > hysterese_waarde) {\n    M1_boven_hysterese_geweest = true;\n}\nif (M2_SoC > hysterese_waarde) {\n    M2_boven_hysterese_geweest = true;\n}\nif (M3_SoC > hysterese_waarde) {\n    M3_boven_hysterese_geweest = true;\n}\n\nif (M1_rs485_mode !== \"enable\") {\n    M1_power = 0;\n}\nif (M2_rs485_mode !== \"enable\") {\n    M2_power = 0;\n}\nif (M3_rs485_mode !== \"enable\") {\n    M3_power = 0;\n}\n\n//TODO DEZE WAARDE NU WEL GEZET MAAR WORD NIETS MEE GEDAAN\nif (M1_SoC <= 11 || isNaN(M1_power_soll) || M1_rs485_mode !== \"enable\") {\n    //M1_power_soll = 0;\n    M1_boven_hysterese_geweest = false;\n}\nif (M2_SoC <= 11 || isNaN(M2_power_soll) || M2_rs485_mode !== \"enable\") {\n    //M2_power_soll = 0;\n    M2_boven_hysterese_geweest = false;\n}\nif (M3_SoC <= 11 || isNaN(M3_power_soll) || M3_rs485_mode !== \"enable\") {\n    //M3_power_soll = 0;\n    M3_boven_hysterese_geweest = false;\n}\n\nlogdata += \"1: \" +\n    P1_power + \"|\" +\n    M1_power + \"|\" +\n    M2_power + \"|\" +\n    M3_power + \"|\" +\n    M1_power_soll + \"|\" +\n    M2_power_soll + \"|\" +\n    M3_power_soll + \"|\" +\n    M1_enkel_laden + \"|\" +\n    M2_enkel_laden + \"|\" +\n    M3_enkel_laden + \"|\";\n\n//------------------------------Controleer of verschil niet te klein is----------------------------\n//Controleren of het verschil tussen actueel accu vermogen en gewenst vermogen minder is dan 50 watt. \n//Indien ja, ga hem meerekenen voor de afzwakking, om pendelen te voorkomen.\nvar teller = 0;\nif (Math.abs(M1_power - M1_power_soll) < 50 || M1_rs485_mode !== \"enable\") {\n    M1_power = M1_power_soll;\n    teller += 1;\n    logdata += \"2: M1-pow <- M1_pow_soll | \";\n}\nif (Math.abs(M2_power - M2_power_soll) < 50 || M2_rs485_mode !== \"enable\") {\n    M2_power = M2_power_soll;\n    teller += 1;\n    logdata += \"3: M2-pow <- M2_pow_soll | \";\n}\nif (Math.abs(M3_power - M3_power_soll) < 50 || M3_rs485_mode !== \"enable\") {\n    M3_power = M3_power_soll;\n    teller += 1;\n    logdata += \"3.5: M3-pow <- M3_pow_soll | \";\n}\nif (teller === totaal_accus) {\n    afzwakking = afzwakking + 0.2 * (1 - afzwakking); //afzwakking 20% verhogen\n}\n//node.warn(afzwakking);\n\nlogdata += \"2: \" +\n    P1_power + \"|\" +\n    M1_power + \"|\" +\n    M1_power_soll + \"|\" +\n    M2_power + \"|\" +\n    M2_power_soll +\n    M3_power + \"|\" +\n    M3_power_soll +\n    \"|afzwakking: \" + afzwakking.toFixed(2) + \" | \";\n\n\n//----------------------Saldo berekenen van wat nu de P1 vermogen is en accu vermogen---------------\n//1) Delta berekenen, het verschil tussen P1 vermogen en Gewenste_P1_vermogen, wat een handmatig sturing, default staat die op 0.\n//2) SomHuidig is de optelsom van Accu vermogen uit de vorige cycli. \n//3) Saldo is dan het totale accu vermogen + de Delta (vaak P1 vermogen)\n\n//Voorbeeld: \n//  Teruglevering, ochtend met veel PV vermogen en accus die moeten laden\n//  Delta:-280 SomHuidig:-2936 Saldo:-3216\n//  Teruglevering, cycli erna, eerst meer gaan ontladen omdat delta ervoor negatief was.\n//  Delta:100 SomHuidig:-3115.2 Saldo:-3015.2\nvar Delta = P1_power - Gewenste_P1_vermogen;    //verbruik is positief\nvar SomHuidig = M1_power + M2_power + M3_power; //ontladen is positief\n//var Saldo = SomHuidig + Delta;\nvar Saldo = Math.round((SomHuidig + Delta) * 10) / 10; //afronden op 1 decimaal achter de komma\n\nlogdata += \"5: \" + Saldo + \" | \";\n//node.warn(\"Delta:\" + Delta + \" SomHuidig:\" + SomHuidig + \" Saldo:\" + Saldo);\n\n//---------------------Kijken of er op basis van Saldo moet worden geladen/ontladen---------------\nif (Saldo > 0) {\n    // er wordt stroom afgenomen van het net\n    Laden = false;\n}\n\n// volgende voorkomt swingen tussen laden en ontladen, dus n cyclus verplicht op 0\nif (Laden != VorigLaden) {\n    Saldo = 0;\n    M1_power = 0;\n    M2_power = 0;\n    M3_power = 0;\n}\n\n//------------------------------Kijken of er mono_bedrijf van toepassing--------------------------\nSaldo = Math.abs(Saldo); //Maakt van -50 nu 50. En van 50 ook 50. \nif (Saldo > 1750) {\n    mono_bedrijf = false;\n}\nelse if (Saldo < 1000 && M1_rs485_mode === \"enable\" && M2_rs485_mode === \"enable\" && M3_rs485_mode === \"enable\") {\n    mono_bedrijf = true; //mag enkel true zijn als ALLE DRIE op modbus regeling zitten, anders zou het kunnen dat geen enkele gaat regelen\n}\nlogdata += \"3: Laden: \" + Laden + \"|Saldo: \" + Saldo + \"|monobedrijf: \" + mono_bedrijf + \" | \";\n\n//------------------------------Check op LADEN/ONTLADEN FLOW-------------------------------------\nif (Laden) {\n\n    // Stap 1: Filter actieve accus en sorteer op laadvolgorde (M1  M2  M3)\n    let acculijst = [\n        { id: \"M1\", limiet: 0, power: M1_power, soll: 0 },\n        { id: \"M2\", limiet: 0, power: M2_power, soll: 0 },\n        { id: \"M3\", limiet: 0, power: M3_power, soll: 0 },\n    ];\n\n    acculijst[0].limiet = (M1_SoC < 100 && M1_rs485_mode === \"enable\") ? bepaalOplaadLimiet(M1_SoC) : 0;\n    acculijst[1].limiet = (M2_SoC < 100 && M2_rs485_mode === \"enable\") ? bepaalOplaadLimiet(M2_SoC) : 0;\n    acculijst[2].limiet = (M3_SoC < 100 && M3_rs485_mode === \"enable\") ? bepaalOplaadLimiet(M3_SoC) : 0;\n\n    // Stap 2: Verdeel het totaal vermogen sequentieel over de lijst\n    let resterend = Math.max(0, Saldo);\n\n    for (let accu of acculijst) {\n        if (resterend <= 0 || accu.limiet <= 0) continue;\n\n        let doelvermogen = Math.min(resterend, accu.limiet);\n        let gewogen = -1 * afzwakking * accu.power + (1 - afzwakking) * doelvermogen;\n        accu.soll = -Math.round(gewogen * 10) / 10;\n        resterend -= doelvermogen;\n    }\n\n    // Stap 3: Resultaten opslaan\n    M1_power_soll = acculijst[0].soll;\n    M2_power_soll = acculijst[1].soll;\n    M3_power_soll = acculijst[2].soll;\n\n    // Eventueel logging\n    logdata += `LAADVERDELING: M1=${M1_power_soll}W | M2=${M2_power_soll}W | M3=${M3_power_soll}W | `;\n}\nelse if (Saldo > 0) { //ontladen logica\n    //Accu die aan het ontladen was  krijgt voorkeur.\n    //Bij onvoldoende vermogen uit 1 accu, tweede/derde accu komt erbij.   \n    //Andere accus  krijgen soll = 0, dus rust.\n    let resterend = Saldo;\n\n    let acculijst = [\n        { id: \"M1\", soc: M1_SoC, rs485: M1_rs485_mode, enkel_laden: M1_enkel_laden, power: M1_power, soll: 0, prev_soll: M1_power_soll },\n        { id: \"M2\", soc: M2_SoC, rs485: M2_rs485_mode, enkel_laden: M2_enkel_laden, power: M2_power, soll: 0, prev_soll: M2_power_soll },\n        { id: \"M3\", soc: M3_SoC, rs485: M3_rs485_mode, enkel_laden: M3_enkel_laden, power: M3_power, soll: 0, prev_soll: M3_power_soll }\n    ];\n\n    // Filter alleen geschikte accus\n    acculijst = acculijst.filter(a => a.soc > minSoC && a.rs485 === \"enable\" && !a.enkel_laden);\n\n    if (acculijst.length === 0) {\n        logdata += \"ONTLADEN GESTOPT: geen geschikte accus boven SoC-grens | \";\n    }\n    else {\n        // Nieuwe logica: Geef voorrang aan laatst actieve accu, anders hoogste SoC\n        let vorige_accu = \"\";\n        if (M1_power_soll > 0) vorige_accu = \"M1\";\n        else if (M2_power_soll > 0) vorige_accu = \"M2\";\n        else if (M3_power_soll > 0) vorige_accu = \"M3\";\n\n        acculijst.sort((a, b) => {\n            if (a.id === vorige_accu && b.id !== vorige_accu) return -1;\n            if (b.id === vorige_accu && a.id !== vorige_accu) return 1;\n            return b.soc - a.soc; // als gelijke status, dan hoogste SoC\n        });\n        // Eerst prioriteit aan accu's die al aan het ontladen waren (prev_soll > 0), daarna hoogste SoC\n        //acculijst.sort((a, b) => {\n        //    if (b.prev_soll > 0 && a.prev_soll <= 0) return 1;\n        //    if (a.prev_soll > 0 && b.prev_soll <= 0) return -1;\n        //    return b.soc - a.soc;\n        //});\n\n        // Toewijzen op volgorde\n        for (let accu of acculijst) {\n            if (resterend <= 0) break;\n\n            let toewijsbaar = Math.min(resterend, maxWattPerAccu);\n            let gewogen = afzwakking * accu.power + (1 - afzwakking) * toewijsbaar;\n            accu.soll = Math.round(gewogen * 10) / 10;\n            resterend -= toewijsbaar;\n        }\n\n        // Resultaten wegschrijven\n        acculijst.forEach(accu => {\n            if (accu.id === \"M1\") M1_power_soll = accu.soll;\n            if (accu.id === \"M2\") M2_power_soll = accu.soll;\n            if (accu.id === \"M3\") M3_power_soll = accu.soll;\n        });\n\n        // Accus zonder opdracht krijgen 0\n        if (!acculijst.find(a => a.id === \"M1\")) M1_power_soll = 0;\n        if (!acculijst.find(a => a.id === \"M2\")) M2_power_soll = 0;\n        if (!acculijst.find(a => a.id === \"M3\")) M3_power_soll = 0;\n\n        logdata += `ONTLAADVERDELING: M1=${M1_power_soll}W | M2=${M2_power_soll}W | M3=${M3_power_soll}W | `;\n    }\n}\nelse {\n    logdata += \"ONTLADEN OVERGESLAGEN: wegens geen netafname | \";\n}\n\n//--------------------------------ZETTEN VAN CHARGE/DISCHARGE PER ACCU--------------------\nif (M1_power_soll < 0) {\n    M1_status = \"charge\";\n}\nelse if (M1_power_soll > 0) {\n    M1_status = \"discharge\"\n}\nif (M2_power_soll < 0) {\n    M2_status = \"charge\";\n}\nelse if (M2_power_soll > 0) {\n    M2_status = \"discharge\"\n}\nif (M3_power_soll < 0) {\n    M3_status = \"charge\";\n}\nelse if (M3_power_soll > 0) {\n    M3_status = \"discharge\"\n}\nlogdata += \"4: status: \" + M1_status + \"|\" + M2_status + \" | \" + M3_status + \" | \";\n\n// waardes opslaan voor volgende cyclus\nflow.set(\"M1_power_soll\", M1_power_soll);\nflow.set(\"M2_power_soll\", M2_power_soll);\nflow.set(\"M3_power_soll\", M3_power_soll);\nflow.set(\"M1_boven_hysterese_geweest\", M1_boven_hysterese_geweest);\nflow.set(\"M2_boven_hysterese_geweest\", M2_boven_hysterese_geweest);\nflow.set(\"M3_boven_hysterese_geweest\", M3_boven_hysterese_geweest);\nflow.set(\"mono_bedrijf\", mono_bedrijf);\nflow.set(\"Laden\", Laden);\n\nlet msg1 = { payload: M1_status };\nlet msg2 = { payload: M2_status };\nlet msg3 = { payload: M3_status };\nlet msg4 = { payload: Math.abs(M1_power_soll) };\nlet msg5 = { payload: Math.abs(M2_power_soll) };\nlet msg6 = { payload: Math.abs(M3_power_soll) };\nlet msg7 = {\n    logdata: logdata,\n    logtitel: \"Batterijen\"\n};\n\n//node.warn(logdata);\nreturn [msg1, msg2, msg3, msg4, msg5, msg6, msg7];\n",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\nflow.set(\"M1_power_soll\", 0);\nflow.set(\"M2_power_soll\", 0);\nflow.set(\"M1_boven_hysterese_geweest\",false);\nflow.set(\"M2_boven_hysterese_geweest\",false);\nflow.set(\"mono_bedrijf\", true);\nflow.set(\"Laden\",false);",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 460,
        "wires": [
            [
                "bcf966686dbfe1e1"
            ],
            [
                "6eec2d15a231fcd8"
            ],
            [
                "8aaf1f48d7b54a9d"
            ],
            [
                "f198730a1a00a89e"
            ],
            [
                "278cefb00810de4d"
            ],
            [
                "8cbfcfe6b9353035"
            ],
            [
                "0423ede035d6a94a"
            ]
        ]
    },
    {
        "id": "e6436fc8b03ab6a2",
        "type": "api-current-state",
        "z": "fe8fcf9c18073d0e",
        "name": "Marstek mode",
        "server": "b9d10367867e38e6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "marsteks_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 120,
        "y": 180,
        "wires": [
            [
                "174f6a90e5efc060"
            ]
        ]
    },
    {
        "id": "174f6a90e5efc060",
        "type": "switch",
        "z": "fe8fcf9c18073d0e",
        "name": "Check for Full control mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 380,
        "y": 180,
        "wires": [
            [
                "0c9ec42ef3dfc6ed"
            ]
        ]
    },
    {
        "id": "7c94d0e18cca4669",
        "type": "api-call-service",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "Set M1 volstand",
        "server": "b9d10367867e38e6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_datetime",
        "service": "set_datetime",
        "mergecontext": "",
        "x": 1280,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "0ddff1329702ece1",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "Opmaak query",
        "func": "\nmsg.topic = \"SELECT * FROM `marstek_volstanden` WHERE Item LIKE 'Laatste volstand';\"\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 900,
        "wires": [
            [
                "bf356045a9208b67"
            ]
        ]
    },
    {
        "id": "3d59163f019584e3",
        "type": "inject",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "elke 5 min volstanden updaten",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "on",
        "payload": "",
        "payloadType": "str",
        "x": 990,
        "y": 900,
        "wires": [
            [
                "0ddff1329702ece1"
            ]
        ]
    },
    {
        "id": "bf356045a9208b67",
        "type": "mysql",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "mydb": "7866ece42093366f",
        "name": "Laatste vol-standen",
        "x": 1420,
        "y": 900,
        "wires": [
            [
                "99c2efc98f33e8db"
            ]
        ]
    },
    {
        "id": "99c2efc98f33e8db",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "Laatste volstanden invullen",
        "func": "var M1_laatste_volstand_database = 0;\nvar M2_laatste_volstand_database = 0;\nvar M3_laatste_volstand_database = 0;\n\nvar M1_laatste_volstand_vorige_flow = flow.get(\"M1_laatste_volstand\");\nvar M2_laatste_volstand_vorige_flow = flow.get(\"M2_laatste_volstand\");\nvar M3_laatste_volstand_vorige_flow = flow.get(\"M2_laatste_volstand\");\n\nmsg.payload.forEach(entry => {\n    const tijd = Date.parse(entry.Tijdstip);\n    if (entry.Toestel === \"Marstek 1\") {\n        M1_laatste_volstand_database = tijd;\n    } \n    else if (entry.Toestel === \"Marstek 2\") {\n        M2_laatste_volstand_database = tijd;\n    }\n    else if (entry.Toestel === \"Marstek 3\") {\n        M3_laatste_volstand_database = tijd;\n    }    \n});\n\n//Datetime Iso string opknippen om naar HA te sturen. Anders foutmelding. \nfunction formatDateTime(timestamp, entity_id) {\n    const dateObj = new Date(timestamp);\n\n    const date = dateObj.toLocaleDateString('nl-NL', {\n        timeZone: 'Europe/Amsterdam',\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit'\n    }).split('-').reverse().join('-'); // van dd-mm-jjjj naar jjjj-mm-dd\n\n    const time = dateObj.toLocaleTimeString('nl-NL', {\n        timeZone: 'Europe/Amsterdam',\n        hour12: false,\n        hour: '2-digit',\n        minute: '2-digit',\n        second: '2-digit'\n    });\n\n    return {\n        payload: {\n            action: \"input_datetime.set_datetime\",\n            data: {\n                entity_id: entity_id,\n                date: date,\n                time: time\n            }\n        }\n    };\n}\n\nlet returnValue1 = null;\nlet returnValue2 = null;\nlet returnValue3 = null;\n\nif (M1_laatste_volstand_vorige_flow != M1_laatste_volstand_database)\n    flow.set(\"M1_laatste_volstand\", M1_laatste_volstand_database);\n    returnValue1 = formatDateTime(M1_laatste_volstand_database, \"input_datetime.marstek_m1_laatste_volstand\");\nif (M1_laatste_volstand_vorige_flow != M2_laatste_volstand_database)\n    flow.set(\"M2_laatste_volstand\", M2_laatste_volstand_database);\n    returnValue2 = formatDateTime(M2_laatste_volstand_database, \"input_datetime.marstek_m2_laatste_volstand\");\nif (M1_laatste_volstand_vorige_flow != M3_laatste_volstand_database)\n    flow.set(\"M3_laatste_volstand\", M3_laatste_volstand_database);\n    returnValue3 = formatDateTime(M3_laatste_volstand_database, \"input_datetime.marstek_m3_laatste_volstand\");\n\nnode.warn(\"returnValue1:\" + JSON.stringify(returnValue1));\nnode.warn(\"returnValue2:\" + JSON.stringify(returnValue2));\nnode.warn(\"returnValue3:\" + JSON.stringify(returnValue3));\nreturn [returnValue1, returnValue2, returnValue3];",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 980,
        "wires": [
            [
                "7c94d0e18cca4669"
            ],
            [
                "7c94d0e18cca4669"
            ],
            [
                "7c94d0e18cca4669"
            ]
        ]
    },
    {
        "id": "01bb68a49e2ec749",
        "type": "server-state-changed",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "M1 SOC",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.marstek_m1_battery_state_of_charge"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 880,
        "y": 720,
        "wires": [
            [
                "af103877d19a6639"
            ]
        ]
    },
    {
        "id": "af103877d19a6639",
        "type": "switch",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "Soc >= 100",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "100",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1070,
        "y": 760,
        "wires": [
            [
                "4737ee25acea25a8"
            ]
        ]
    },
    {
        "id": "4737ee25acea25a8",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "Query maken",
        "func": "var SQL = \"\"\n\nif (msg.topic.includes(\"m1\"))\n    SQL = \"UPDATE `marstek_volstanden` SET `Tijdstip`= NOW() WHERE `Toestel` = 'Marstek 1' AND `Item` = 'Laatste volstand'\";\nelse if (msg.topic.includes(\"m2\")) \n    SQL = \"UPDATE `marstek_volstanden` SET `Tijdstip`= NOW() WHERE `Toestel` = 'Marstek 2' AND `Item` = 'Laatste volstand'\";\nelse if (msg.topic.includes(\"m3\")) \n    SQL = \"UPDATE `marstek_volstanden` SET `Tijdstip`= NOW() WHERE `Toestel` = 'Marstek 3' AND `Item` = 'Laatste volstand'\";\n\nmsg.topic = SQL;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1260,
        "y": 760,
        "wires": [
            [
                "6adf021365c04dd0"
            ]
        ]
    },
    {
        "id": "6adf021365c04dd0",
        "type": "mysql",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "mydb": "7866ece42093366f",
        "name": "LogData in Databank",
        "x": 1480,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "5b00966a1554593d",
        "type": "server-state-changed",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "M2 SOC",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.marstek_m2_battery_state_of_charge"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 880,
        "y": 760,
        "wires": [
            [
                "af103877d19a6639"
            ]
        ]
    },
    {
        "id": "f48f6a2dd2f9c8e0",
        "type": "server-state-changed",
        "z": "fe8fcf9c18073d0e",
        "g": "af80d4df5496b0f7",
        "name": "M3 SOC",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.marstek_m3_battery_state_of_charge"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 880,
        "y": 800,
        "wires": [
            [
                "af103877d19a6639"
            ]
        ]
    },
    {
        "id": "7a205b598d342a51",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "257a562828a46071",
        "name": "Parse DSMR telegram eens per 10 sec",
        "func": "// Parse DSMR telegram\nlet lines = msg.payload.split('\\n');\nlet data = {};\n\nfor (let line of lines) {\n    // Verbruik dagtotaal\n    //if (line.startsWith('1-0:1.8.0')) {\n    //    let m = line.match(/\\((\\d+\\.\\d+)\\*kWh\\)/);\n    //    if (m) data.verbruik_totaal = parseFloat(m[1]);\n    //}\n\n    // Teruglevering dagtotaal\n    //if (line.startsWith('1-0:2.8.0')) {\n    //    let m = line.match(/\\((\\d+\\.\\d+)\\*kWh\\)/);\n    //    if (m) data.terug_totaal = parseFloat(m[1]);\n    //}\n\n    // Huidig verbruik\n    if (line.startsWith('1-0:1.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.verbruik_actueel = parseFloat(m[1]);\n    }\n\n    // Huidige teruglevering\n    if (line.startsWith('1-0:2.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.terug_actueel = parseFloat(m[1]);\n    }\n}\n\n// Netto vermogen berekenen\nif (typeof data.verbruik_actueel === 'number' && typeof data.terug_actueel === 'number') {\n    data.P1_netto_vermogen = parseFloat((data.verbruik_actueel - data.terug_actueel).toFixed(3));\n}\n\nlet huidig = data.P1_netto_vermogen;\nlet vorige = flow.get('vorige_P1_netto_vermogen');\n\n//node.warn(`Huidig: ${huidig}, Vorige: ${vorige}`);\n//  Alleen doorgaan als huidig een geldig getal is\n\nif (typeof huidig === 'number' && (vorige === undefined || huidig !== vorige)) {\n    flow.set('vorige_P1_netto_vermogen', huidig); //gebruikt voor deze node flow om volgende keer te gebruiken. \n    msg.payload = huidig*1000;  //Maal 1000 voor juiste waarde verderop\n    flow.set('P1_power', huidig * 1000);  //Maal 1000 voor juiste waarde verderop\n    return msg;\n}\n\n//  Geen nieuwe waarde of identiek aan vorige\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "384d1cc527257f47",
        "type": "tcp in",
        "z": "fe8fcf9c18073d0e",
        "d": true,
        "g": "257a562828a46071",
        "name": "ESP-link TCP DSMR",
        "server": "client",
        "host": "192.168.1.30",
        "port": "23",
        "datamode": "stream",
        "datatype": "utf8",
        "newline": "",
        "topic": "",
        "trim": false,
        "base64": false,
        "tls": "",
        "x": 850,
        "y": 180,
        "wires": [
            [
                "890a96920af85269"
            ]
        ]
    },
    {
        "id": "890a96920af85269",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "257a562828a46071",
        "name": "Buffer DSMR telegrams",
        "func": "let buffer = flow.get('dsmr_buffer') || '';\nbuffer += msg.payload;\n\n// Zorg dat we pas bufferen vanaf een echte start van een telegram\nif (!buffer.startsWith('/')) {\n    const start = buffer.indexOf('/');\n    if (start >= 0) {\n        buffer = buffer.slice(start);\n    } else {\n        // Geen start gevonden, wachten op volgende input\n        return null;\n    }\n}\n\nlet telegrams = [];\n\nwhile (buffer.includes('!')) {\n    const start = buffer.indexOf('/');\n    const end = buffer.indexOf('!') + 1;\n\n    if (start >= 0 && end > start) {\n        const telegram = buffer.slice(start, end);\n        telegrams.push({ payload: telegram });\n        buffer = buffer.slice(end);\n    } else {\n        break;\n    }\n}\n\nflow.set('dsmr_buffer', buffer);\nreturn telegrams;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 180,
        "wires": [
            [
                "7a205b598d342a51"
            ]
        ]
    },
    {
        "id": "497c690c39721f88",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "d8201df108b3cdbd",
        "name": "Parse DSMR telegram eens per 3 cycli",
        "func": "// Haal teller op, standaard 1 (dus 1 = eerste tel)\nlet teller = flow.get('P1_meter_update_teller') || 1;\n\n//  Stoppen als teller < 3 (nog niet tijd om door te geven)\nif (teller < 3) {\n    flow.set('P1_meter_update_teller', teller + 1);\n    return null;\n}\n\n//  teller === 3  doorgaan en daarna resetten naar 1\n\n// Parse DSMR telegram\nlet lines = msg.payload.split('\\n');\nlet data = {};\n\nfor (let line of lines) {\n    if (line.startsWith('1-0:1.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.verbruik_actueel = parseFloat(m[1]);\n    }\n\n    if (line.startsWith('1-0:2.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.terug_actueel = parseFloat(m[1]);\n    }\n}\n\nnode.warn(\"verbruik_actueel: \" + data.verbruik_actueel);\nnode.warn(\"terug_actueel: \" + data.terug_actueel);\n\n// Netto vermogen berekenen\nif (typeof data.verbruik_actueel === 'number' && typeof data.terug_actueel === 'number') {\n    data.P1_netto_vermogen = parseFloat((data.verbruik_actueel - data.terug_actueel).toFixed(3));\n    node.warn(\"P1_netto_vermogen: \" + data.P1_netto_vermogen);\n}\n\nif (typeof data.P1_netto_vermogen === 'number') {\n    flow.set('P1_meter_update_teller', 1); // reset naar 1 voor nieuwe cyclus\n    msg.payload = data.P1_netto_vermogen * 1000;\n    flow.set('P1_power', data.P1_netto_vermogen);\n    return msg;\n}\n\n//  Geen verschil = geen update\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "266f4d8b23593df9",
        "type": "server-state-changed",
        "z": "fe8fcf9c18073d0e",
        "name": "P1 power",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_vermogen_totaal"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "P1_power",
                "propertyType": "flow",
                "value": "$number($entity().state) * 1000",
                "valueType": "jsonata"
            }
        ],
        "x": 100,
        "y": 100,
        "wires": [
            [
                "144efd8127a8a89a"
            ]
        ]
    },
    {
        "id": "768cecd02ec94b82",
        "type": "debug",
        "z": "fe8fcf9c18073d0e",
        "name": "P1 DSMR/HA",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 100,
        "wires": []
    },
    {
        "id": "144efd8127a8a89a",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "name": "Update naar eens per 3 cycli",
        "func": "// Haal teller op, standaard 1 (dus 1 = eerste tel)\nlet teller = flow.get('P1_meter_update_teller') || 1;\n\n//  Stoppen als teller < 3 (nog niet tijd om door te geven)\nif (teller < 3) {\n    flow.set('P1_meter_update_teller', teller + 1);\n    return null;\n}\n\n//  teller === 3  doorgaan en daarna resetten naar 1\nlet verbruik = msg.payload;\n\nif (typeof verbruik === 'number') {\n    flow.set('P1_meter_update_teller', 1); // reset naar 1 voor nieuwe cyclus\n    msg.payload = verbruik;\n    flow.set('P1_power', verbruik);\n    return msg;\n}\n\n//  Geen verschil = geen update\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "e6436fc8b03ab6a2"
            ]
        ]
    },
    {
        "id": "6a0832297f4cbc08",
        "type": "function",
        "z": "fe8fcf9c18073d0e",
        "g": "d8201df108b3cdbd",
        "name": "Parse DSMR telegram zonder vertraging",
        "func": "// Parse DSMR telegram\nlet lines = msg.payload.split('\\n');\nlet data = {};\n\nfor (let line of lines) {\n    // Verbruik dagtotaal\n    //if (line.startsWith('1-0:1.8.0')) {\n    //    let m = line.match(/\\((\\d+\\.\\d+)\\*kWh\\)/);\n    //    if (m) data.verbruik_totaal = parseFloat(m[1]);\n    //}\n\n    // Teruglevering dagtotaal\n    //if (line.startsWith('1-0:2.8.0')) {\n    //    let m = line.match(/\\((\\d+\\.\\d+)\\*kWh\\)/);\n    //    if (m) data.terug_totaal = parseFloat(m[1]);\n    //}\n\n    // Huidig verbruik\n    if (line.startsWith('1-0:1.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.verbruik_actueel = parseFloat(m[1]);\n    }\n\n    // Huidige teruglevering\n    if (line.startsWith('1-0:2.7.0')) {\n        let m = line.match(/\\((\\d+\\.\\d+)\\*kW\\)/);\n        if (m) data.terug_actueel = parseFloat(m[1]);\n    }\n}\n\n// Netto vermogen berekenen\nif (typeof data.verbruik_actueel === 'number' && typeof data.terug_actueel === 'number') {\n    data.P1_netto_vermogen = parseFloat((data.verbruik_actueel - data.terug_actueel).toFixed(3));\n}\n\nlet huidig = data.P1_netto_vermogen;\nlet vorige = flow.get('vorige_P1_netto_vermogen');\n\n//node.warn(`Huidig: ${huidig}, Vorige: ${vorige}`);\n//  Alleen doorgaan als huidig een geldig getal is\n\nif (typeof huidig === 'number' && (vorige === undefined || huidig !== vorige)) {\n    flow.set('vorige_P1_netto_vermogen', huidig); //gebruikt voor deze node flow om volgende keer te gebruiken. \n    msg.payload = huidig*1000;  //Maal 1000 voor juiste waarde verderop\n    flow.set('P1_power', huidig * 1000);  //Maal 1000 voor juiste waarde verderop\n    return msg;\n}\n\n//  Geen nieuwe waarde of identiek aan vorige\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "07ea8cce564a2bc8",
        "type": "server-state-changed",
        "z": "fe8fcf9c18073d0e",
        "d": true,
        "name": "P1 power",
        "server": "b9d10367867e38e6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_vermogen"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "num",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "$number($entity().state) * 1000",
                "valueType": "jsonata"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "P1_power",
                "propertyType": "flow",
                "value": "$number($entity().state) * 1000",
                "valueType": "jsonata"
            }
        ],
        "x": 100,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "4696df45d28898ad",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-contrib-dutch-weather": "2.0.12",
            "node-red-dashboard": "3.6.6",
            "node-red-contrib-modbus": "5.45.2",
            "node-red-node-mysql": "2.0.0",
            "node-red-contrib-telegrambot": "17.0.3",
            "node-red-contrib-time-range-switch": "1.2.0",
            "node-red-contrib-eztimer": "1.2.7",
            "node-red-contrib-bigtimer": "2.8.6",
            "node-red-contrib-moment": "5.0.0",
            "node-red-node-smooth": "0.1.2"
        }
    }
]