modbus:
  - name: modbus_hub
    type: tcp
    host: 192.168.1.201
    port: 502
    delay: 0
    message_wait_milliseconds: 30
    timeout: 10
    sensors:

    #--------OMCCI / Open Modbus Dataset--------
      # Charge Point Status (R)
      - name: "Bender_ChargePointState"
        slave: 1
        address: 104
        input_type: holding
        data_type: uint16
        scan_interval: 10
      # Vehicle State / Control Pilot State (R) - IEC 61851-1
      - name: "Bender_Vehicle_State"
        slave: 1
        address: 122
        input_type: holding
        data_type: uint16
        scan_interval: 10
      # Safe Current (R/W) - 131
      - name: "Bender_SafeCurrent"
        slave: 1
        address: 131
        input_type: holding
        data_type: uint16
        unit_of_measurement: "A"
        scan_interval: 30
      # Power per phase (R) - 32-bit registers
      - name: "Bender_Power_L1"
        slave: 1
        address: 206
        input_type: holding
        data_type: uint32
        unit_of_measurement: "W"
        device_class: power
        scan_interval: 10
      - name: "Bender_Power_L2"
        slave: 1
        address: 208
        input_type: holding
        data_type: uint32
        unit_of_measurement: "W"
        device_class: power
        scan_interval: 10
      - name: "Bender_Power_L3"
        slave: 1
        address: 210
        input_type: holding
        data_type: uint32
        unit_of_measurement: "W"
        device_class: power
        scan_interval: 10
      # Current per phase (R) - 32-bit, in mA
      - name: "Bender_Current_L1"
        slave: 1
        address: 212
        input_type: holding
        data_type: uint32
        unit_of_measurement: "mA"
        device_class: current
        scan_interval: 10
      - name: "Bender_Current_L2"
        slave: 1
        address: 214
        input_type: holding
        data_type: uint32
        unit_of_measurement: "mA"
        device_class: current
        scan_interval: 10
      - name: "Bender_Current_L3"
        slave: 1
        address: 216
        input_type: holding
        data_type: uint32
        unit_of_measurement: "mA"
        device_class: current
        scan_interval: 10
      # Lifetime Energy - Total energy ever charged (R) - 32-bit
      - name: "Bender_Lifetime_Energy"
        slave: 1
        address: 218
        input_type: holding
        data_type: uint32
        unit_of_measurement: "Wh"
        device_class: energy
        state_class: total_increasing
        scan_interval: 60
      - name: "Bender_TotalPower"
        slave: 1
        address: 220
        input_type: holding
        data_type: uint32
        unit_of_measurement: "W"
        device_class: power
        scan_interval: 10
      # HEMS Limit (R/W)
      - name: "Bender_HEMS_Limit"
        slave: 1
        address: 1000
        input_type: holding
        data_type: uint16
        unit_of_measurement: "A"
        scan_interval: 30
      # Session Energy - Charged energy current session (R) - 32-bit
      - name: "Bender_Session_Energy"
        slave: 1
        address: 716
        input_type: holding
        data_type: uint32
        unit_of_measurement: "Wh"
        device_class: energy
        scan_interval: 30
      # Session Duration - Charge duration in seconds (R) - 32-bit
      - name: "Bender_Session_Duration"
        slave: 1
        address: 718
        input_type: holding
        data_type: uint32
        unit_of_measurement: "s"
        device_class: duration
        scan_interval: 30
      # EV Battery State / SOC (R)
      - name: "Bender_EV_Battery_SOC"
        slave: 1
        address: 730
        input_type: holding
        data_type: uint16
        unit_of_measurement: "%"
        device_class: battery
        scan_interval: 60
      # Error Codes (R) - Bitmask for active errors (32-bit: registers 105-106)
      - name: "Bender_Error_Code"
        slave: 1
        address: 105
        input_type: holding
        data_type: uint32
        swap: word
        scan_interval: 10
      # Error Events (R) - Bitmask for historical events (32-bit: registers 158-159)
      - name: "Bender_Error_Events"
        slave: 1
        address: 158
        input_type: holding
        data_type: uint32
        swap: word
        scan_interval: 60


###########################################################################################################
# INPUT NUMBER
###########################################################################################################
input_number:

  bender_strategy_required_kwh:
    name: Benodigde energie
    min: 0
    max: 100
    step: 1
    unit_of_measurement: "kWh"
    icon: mdi:battery-charging
    mode: box

  bender_strategy_max_current:
    name: Max laadstroom
    min: 6
    max: 16
    step: 1
    initial: 16
    unit_of_measurement: "A"
    icon: mdi:current-ac
    mode: slider

  bender_strategy_pv_min_surplus:
    name: Min. overschot voor laden
    min: 1000
    max: 11000
    step: 100
    initial: 4140
    unit_of_measurement: "W"
    icon: mdi:solar-power
    mode: slider


  # Load Balancer Settings
  bender_loadbalancer_margin:
    name: Load Balancer Veiligheidsmarge
    min: 0
    max: 5000
    step: 100
    initial: 1000
    unit_of_measurement: "W"
    icon: mdi:shield-alert
    mode: slider

  bender_house_max_power:
    name: Huisaansluiting Max Vermogen
    min: 5000
    max: 25000
    step: 250
    initial: 17250
    unit_of_measurement: "W"
    icon: mdi:home-lightning-bolt
    mode: box

###########################################################################################################
# INPUT SELECT
###########################################################################################################
input_select:
  bender_charging_strategy:
    name: Laadpaal Strategie
    options:
      - Uit
      - Direct
      - Manual
      - ChargePV
      - Dynamic
    icon: mdi:ev-station

###########################################################################################################
# INPUT DATETIME
###########################################################################################################
input_datetime:
  bender_strategy_departure_time:
    name: Vertrektijd
    has_date: true
    has_time: true
    icon: mdi:clock-end

  bender_strategy_dynamic_start:
    name: Geplande laadstart
    has_date: true
    has_time: true
    icon: mdi:clock-start

###########################################################################################################
# INPUT TEXT
###########################################################################################################
input_text:
  bender_strategy_active_status:
    name: Strategie status
    icon: mdi:information
    max: 255

###########################################################################################################
# INPUT BOOLEAN
###########################################################################################################
input_boolean:
  bender_strategy_dynamic_must_charge:
    name: Dynamic moet nu laden (deadline)
    icon: mdi:alert-circle

  bender_loadbalancer_enabled:
    name: Load Balancer Actief
    icon: mdi:scale-balance

###########################################################################################################
# TEMPLATE SENSORS
###########################################################################################################
template:
  - sensor:
      - name: "Bender_Charge_Point_Status"
        state: >
          {% set state = states('sensor.bender_chargepointstate') | int(-1) %}
          {% if state == 0 %}Available
          {% elif state == 1 %}Occupied
          {% elif state == 2 %}Reserved
          {% elif state == 3 %}Unavailable
          {% elif state == 4 %}Faulted
          {% elif state == 5 %}Preparing
          {% elif state == 6 %}Charging
          {% elif state == 7 %}SuspendedEVSE
          {% elif state == 8 %}SuspendedEV
          {% elif state == 9 %}Finishing
          {% else %}Unknown
          {% endif %}

      # Vehicle State (Control Pilot) - IEC 61851-1 translation
      - name: "Bender Vehicle Status"
        unique_id: "bender_vehicle_status"
        icon: mdi:car-electric
        state: >
          {% set state = states('sensor.bender_vehicle_state') | int(-1) %}
          {% if state == 1 %}A - Niet aangesloten
          {% elif state == 2 %}B - Aangesloten, niet (meer) aan het laden
          {% elif state == 3 %}C - Laden actief
          {% elif state == 4 %}D - Laden met ventilatie
          {% elif state == 5 %}E - Fout
          {% else %}Onbekend
          {% endif %}
        attributes:
          state_code: "{{ states('sensor.bender_vehicle_state') | int(-1) }}"
          state_letter: >
            {% set state = states('sensor.bender_vehicle_state') | int(-1) %}
            {% if state == 1 %}A
            {% elif state == 2 %}B
            {% elif state == 3 %}C
            {% elif state == 4 %}D
            {% elif state == 5 %}E
            {% else %}?
            {% endif %}

      # Session Energy in kWh
      - name: "Bender Session Energy kWh"
        unique_id: "bender_session_energy_kwh"
        icon: mdi:lightning-bolt
        unit_of_measurement: "kWh"
        device_class: energy
        state: >
          {% set wh = states('sensor.bender_session_energy') | float(0) %}
          {{ (wh / 1000) | round(2) }}

      # Session Duration in readable format (H:MM)
      - name: "Bender Session Duration"
        unique_id: "bender_session_duration_formatted"
        icon: mdi:timer-outline
        state: >
          {% set secs = states('sensor.bender_session_duration') | int(0) %}
          {% set hours = (secs // 3600) %}
          {% set minutes = ((secs % 3600) // 60) %}
          {{ hours }}:{{ '%02d' | format(minutes) }}

      # EV Battery SOC - Filters 65535 (unavailable) value
      - name: "Bender EV SOC"
        unique_id: "bender_ev_soc"
        icon: mdi:car-battery
        unit_of_measurement: "%"
        device_class: battery
        state: >
          {% set raw = states('sensor.bender_ev_battery_soc') | int(65535) %}
          {% if raw == 65535 or raw > 100 %}
            unknown
          {% else %}
            {{ raw }}
          {% endif %}

      # Error Code Translation - Converts bitmask to readable error messages
      - name: "Bender Error Status"
        unique_id: "bender_error_status"
        icon: mdi:alert-circle
        state: >
          {% set code = states('sensor.bender_error_code') | int(0) %}
          {% if code == 0 %}
            Geen fouten
          {% else %}
            {% set errors = [] %}
            {% if code | bitwise_and(0x0001) %}{% set errors = errors + ['Reststroom gedetecteerd'] %}{% endif %}
            {% if code | bitwise_and(0x0002) %}{% set errors = errors + ['Voertuig meldt fout'] %}{% endif %}
            {% if code | bitwise_and(0x0004) %}{% set errors = errors + ['Diode check mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x0008) %}{% set errors = errors + ['MCB Type 2 uitgevallen'] %}{% endif %}
            {% if code | bitwise_and(0x0010) %}{% set errors = errors + ['MCB Schuko uitgevallen'] %}{% endif %}
            {% if code | bitwise_and(0x0020) %}{% set errors = errors + ['Aardlekschakelaar geactiveerd'] %}{% endif %}
            {% if code | bitwise_and(0x0040) %}{% set errors = errors + ['Contactor vastgelast'] %}{% endif %}
            {% if code | bitwise_and(0x0080) %}{% set errors = errors + ['Backend verbinding verbroken'] %}{% endif %}
            {% if code | bitwise_and(0x0100) %}{% set errors = errors + ['Stekker vergrendeling mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x0200) %}{% set errors = errors + ['Vergrendeling zonder stekker fout'] %}{% endif %}
            {% if code | bitwise_and(0x0400) %}{% set errors = errors + ['Actuator vastzittend'] %}{% endif %}
            {% if code | bitwise_and(0x0800) %}{% set errors = errors + ['Actuator detectie mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x1000) %}{% set errors = errors + ['Firmware update bezig'] %}{% endif %}
            {% if code | bitwise_and(0x2000) %}{% set errors = errors + ['Laadpaal gekanteld'] %}{% endif %}
            {% if code | bitwise_and(0x4000) %}{% set errors = errors + ['CP/PR bedrading fout'] %}{% endif %}
            {% if code | bitwise_and(0x8000) %}{% set errors = errors + ['Overbelasting - laden gestopt'] %}{% endif %}
            {{ errors | join(', ') if errors else 'Onbekende fout (' ~ code ~ ')' }}
          {% endif %}
        attributes:
          error_code: "{{ states('sensor.bender_error_code') | int(0) }}"
          has_error: "{{ states('sensor.bender_error_code') | int(0) > 0 }}"

      # Error Events Translation - Converts bitmask to readable event messages
      - name: "Bender Event Log"
        unique_id: "bender_event_log"
        icon: mdi:history
        state: >
          {% set code = states('sensor.bender_error_events') | int(0) %}
          {% if code == 0 %}
            Geen events
          {% else %}
            {% set events = [] %}
            {% if code | bitwise_and(0x0004) %}{% set events = events + ['Reboot uitgevoerd'] %}{% endif %}
            {% if code | bitwise_and(0x0008) %}{% set events = events + ['Autorisatie mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x0010) %}{% set events = events + ['Autorisatie mislukt (zonder notificatie)'] %}{% endif %}
            {% if code | bitwise_and(0x0040) %}{% set events = events + ['Firmware update mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x0100) %}{% set events = events + ['Firmware package manager fout'] %}{% endif %}
            {% if code | bitwise_and(0x0200) %}{% set events = events + ['Onverwachte reset (stroomuitval?)'] %}{% endif %}
            {% if code | bitwise_and(0x0400) %}{% set events = events + ['Transactie gestopt na reset'] %}{% endif %}
            {% if code | bitwise_and(0x0800) %}{% set events = events + ['Slave losgekoppeld van master'] %}{% endif %}
            {% if code | bitwise_and(0x1000) %}{% set events = events + ['Diagnostiek mislukt'] %}{% endif %}
            {% if code | bitwise_and(0x2000) %}{% set events = events + ['RCMB fout'] %}{% endif %}
            {% if code | bitwise_and(0x8000) %}{% set events = events + ['ISO 15118 communicatie mislukt'] %}{% endif %}
            {{ events | join(', ') if events else 'Onbekend event (' ~ code ~ ')' }}
          {% endif %}
        attributes:
          event_code: "{{ states('sensor.bender_error_events') | int(0) }}"
          has_events: "{{ states('sensor.bender_error_events') | int(0) > 0 }}"

      # Available PV surplus power (negative P1 = exporting = available)
      - name: "Bender PV Available Power"
        unique_id: "bender_pv_available_power"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set p1_power = states('sensor.p1_meter_power') | float(0) %}
          {% if p1_power < 0 %}
            {{ (p1_power * -1) | round(0) }}
          {% else %}
            0
          {% endif %}

      # -------------------------------------------------------------------------
      # LOAD BALANCER SENSORS
      # -------------------------------------------------------------------------

      # Calculated "House Only" consumption (P1 Total - Charger Total)
      - name: "Bender House Consumption Excl Charger"
        unique_id: "bender_house_consumption_excl_charger"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set p1_l1 = (states('sensor.dsmr_reading_phase_currently_delivered_l1') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l1') | float(0)) * 1000 %}
          {% set p1_l2 = (states('sensor.dsmr_reading_phase_currently_delivered_l2') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l2') | float(0)) * 1000 %}
          {% set p1_l3 = (states('sensor.dsmr_reading_phase_currently_delivered_l3') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l3') | float(0)) * 1000 %}
          {% set p1_total = p1_l1 + p1_l2 + p1_l3 %}
          {% set charger_power = states('sensor.bender_charging_power_total') | float(0) %}
          {{ (p1_total - charger_power) | round(0) }}

      # House Consumption per phase (excl Charger)
      - name: "Bender House Consumption L1"
        unique_id: "bender_house_consumption_l1"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set p1_l1 = (states('sensor.dsmr_reading_phase_currently_delivered_l1') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l1') | float(0)) * 1000 %}
          {% set ch_l1_ma = states('sensor.bender_current_l1') | float(0) %}
          {% set ch_l1_w = (ch_l1_ma / 1000) * states('sensor.dsmr_reading_phase_voltage_l1') | float(230) %}
          {{ (p1_l1 - ch_l1_w) | round(0) }}

      - name: "Bender House Consumption L2"
        unique_id: "bender_house_consumption_l2"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set p1_l2 = (states('sensor.dsmr_reading_phase_currently_delivered_l2') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l2') | float(0)) * 1000 %}
          {% set ch_l2_ma = states('sensor.bender_current_l2') | float(0) %}
          {% set ch_l2_w = (ch_l2_ma / 1000) * states('sensor.dsmr_reading_phase_voltage_l2') | float(230) %}
          {{ (p1_l2 - ch_l2_w) | round(0) }}

      - name: "Bender House Consumption L3"
        unique_id: "bender_house_consumption_l3"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set p1_l3 = (states('sensor.dsmr_reading_phase_currently_delivered_l3') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l3') | float(0)) * 1000 %}
          {% set ch_l3_ma = states('sensor.bender_current_l3') | float(0) %}
          {% set ch_l3_w = (ch_l3_ma / 1000) * states('sensor.dsmr_reading_phase_voltage_l3') | float(230) %}
          {{ (p1_l3 - ch_l3_w) | round(0) }}

      # Available Current per phase (Bottleneck Calculation)
      # Calculates available amps for each phase: (Max - Margin - (Grid - Charger))
      # Returns the minimum available amps across all 3 phases (capped at 16A)
      - name: "Bender Loadbalancer Available Current"
        unique_id: "bender_loadbalancer_available_current"
        unit_of_measurement: "A"
        device_class: current
        state: >
          {% if is_state('input_boolean.bender_loadbalancer_enabled', 'on') %}
            {# --- Configuration --- #}
            {% set max_power = states('input_number.bender_house_max_power') | float(17250) %}
            {% set margin_power = states('input_number.bender_loadbalancer_margin') | float(1000) %}
            
            {# Convert Power Config to Amps per phase (Assuming 3-phase and 230V) #}
            {# 17250W / 3 / 230V = 25A #}
            {% set max_amps = (max_power / 3) / 230 %}
            {% set margin_amps = (margin_power / 3) / 230 %}
            {% set limit_amps = max_amps - margin_amps %}
            
            {# --- Phase 1 --- #}
            {% set v_l1 = states('sensor.dsmr_reading_phase_voltage_l1') | float(230) %}
            {% set grid_l1_w = (states('sensor.dsmr_reading_phase_currently_delivered_l1') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l1') | float(0)) * 1000 %}
            {% set grid_l1_a = grid_l1_w / v_l1 %}
            {% set ch_l1_ma = states('sensor.bender_current_l1') | float(0) %}
            {% set ch_l1_a = ch_l1_ma / 1000 %}
            {# Available = Limit - (Grid load without charger) = Limit - (Grid - Charger) #}
            {% set avail_l1 = limit_amps - grid_l1_a + ch_l1_a %}
            
            {# --- Phase 2 --- #}
            {% set v_l2 = states('sensor.dsmr_reading_phase_voltage_l2') | float(230) %}
            {% set grid_l2_w = (states('sensor.dsmr_reading_phase_currently_delivered_l2') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l2') | float(0)) * 1000 %}
            {% set grid_l2_a = grid_l2_w / v_l2 %}
            {% set ch_l2_ma = states('sensor.bender_current_l2') | float(0) %}
            {% set ch_l2_a = ch_l2_ma / 1000 %}
            {% set avail_l2 = limit_amps - grid_l2_a + ch_l2_a %}
            
            {# --- Phase 3 --- #}
            {% set v_l3 = states('sensor.dsmr_reading_phase_voltage_l3') | float(230) %}
            {% set grid_l3_w = (states('sensor.dsmr_reading_phase_currently_delivered_l3') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l3') | float(0)) * 1000 %}
            {% set grid_l3_a = grid_l3_w / v_l3 %}
            {% set ch_l3_ma = states('sensor.bender_current_l3') | float(0) %}
            {% set ch_l3_a = ch_l3_ma / 1000 %}
            {% set avail_l3 = limit_amps - grid_l3_a + ch_l3_a %}
            
            {# --- Result --- #}
            {# Find the phase with the least headroom (bottleneck) #}
            {% set bottleneck = [avail_l1, avail_l2, avail_l3] | min %}
            
            {# Apply absolute cap of 16A (Charging Strategy Max fallback) and ensure non-negative #}
            {{ [ [bottleneck, 16] | min, 0 ] | max | round(1) }}
          {% else %}
            16.0
          {% endif %}

      # Raw Available Current per phase (calculated values before bottleneck)
      - name: "Bender LB Available Current L1"
        unique_id: "bender_lb_available_current_l1"
        unit_of_measurement: "A"
        device_class: current
        state: >
          {% if is_state('input_boolean.bender_loadbalancer_enabled', 'on') %}
            {% set max_power = states('input_number.bender_house_max_power') | float(17250) %}
            {% set margin_power = states('input_number.bender_loadbalancer_margin') | float(1000) %}
            {% set limit_amps = (max_power / 3 / 230) - (margin_power / 3 / 230) %}
            {% set grid_l1_w = (states('sensor.dsmr_reading_phase_currently_delivered_l1') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l1') | float(0)) * 1000 %}
            {% set grid_l1_a = grid_l1_w / states('sensor.dsmr_reading_phase_voltage_l1') | float(230) %}
            {% set ch_l1_a = states('sensor.bender_current_l1') | float(0) / 1000 %}
            {{ (limit_amps - grid_l1_a + ch_l1_a) | round(1) }}
          {% else %}
            16.0
          {% endif %}

      - name: "Bender LB Available Current L2"
        unique_id: "bender_lb_available_current_l2"
        unit_of_measurement: "A"
        device_class: current
        state: >
          {% if is_state('input_boolean.bender_loadbalancer_enabled', 'on') %}
            {% set max_power = states('input_number.bender_house_max_power') | float(17250) %}
            {% set margin_power = states('input_number.bender_loadbalancer_margin') | float(1000) %}
            {% set limit_amps = (max_power / 3 / 230) - (margin_power / 3 / 230) %}
            {% set grid_l2_w = (states('sensor.dsmr_reading_phase_currently_delivered_l2') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l2') | float(0)) * 1000 %}
            {% set grid_l2_a = grid_l2_w / states('sensor.dsmr_reading_phase_voltage_l2') | float(230) %}
            {% set ch_l2_a = states('sensor.bender_current_l2') | float(0) / 1000 %}
            {{ (limit_amps - grid_l2_a + ch_l2_a) | round(1) }}
          {% else %}
            16.0
          {% endif %}

      - name: "Bender LB Available Current L3"
        unique_id: "bender_lb_available_current_l3"
        unit_of_measurement: "A"
        device_class: current
        state: >
          {% if is_state('input_boolean.bender_loadbalancer_enabled', 'on') %}
            {% set max_power = states('input_number.bender_house_max_power') | float(17250) %}
            {% set margin_power = states('input_number.bender_loadbalancer_margin') | float(1000) %}
            {% set limit_amps = (max_power / 3 / 230) - (margin_power / 3 / 230) %}
            {% set grid_l3_w = (states('sensor.dsmr_reading_phase_currently_delivered_l3') | float(0) - states('sensor.dsmr_reading_phase_currently_returned_l3') | float(0)) * 1000 %}
            {% set grid_l3_a = grid_l3_w / states('sensor.dsmr_reading_phase_voltage_l3') | float(230) %}
            {% set ch_l3_a = states('sensor.bender_current_l3') | float(0) / 1000 %}
            {{ (limit_amps - grid_l3_a + ch_l3_a) | round(1) }}
          {% else %}
            16.0
          {% endif %}

      # DSMR Data Freshness - Shows how old the P1 meter data is
      - name: "Bender DSMR Data Leeftijd"
        unique_id: "bender_dsmr_data_leeftijd"
        unit_of_measurement: "s"
        icon: mdi:clock-alert
        state: >
          {% set last = states.sensor.dsmr_reading_phase_currently_delivered_l1.last_updated %}
          {% if last is defined and last is not none %}
            {{ (now() - last).total_seconds() | round(0) }}
          {% else %}
            unknown
          {% endif %}
        attributes:
          last_update: >
            {% set last = states.sensor.dsmr_reading_phase_currently_delivered_l1.last_updated %}
            {% if last is defined and last is not none %}
              {{ last.strftime('%H:%M:%S') }}
            {% else %}
              unknown
            {% endif %}
          stale: >
            {% set last = states.sensor.dsmr_reading_phase_currently_delivered_l1.last_updated %}
            {% if last is defined and last is not none %}
              {{ (now() - last).total_seconds() > 30 }}
            {% else %}
              true
            {% endif %}

      # Total Power available for Charger (Visual Only)
      # Based on the bottleneck current * 3 phases * 230V
      - name: "Bender Loadbalancer Available Power"
        unique_id: "bender_loadbalancer_available_power"
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set available_current = states('sensor.bender_loadbalancer_available_current') | float(0) %}
          {{ (available_current * 3 * 230) | round(0) }}

      # Hours needed to charge the required kWh at max current
      - name: "Bender Dynamic Hours Needed"
        unique_id: "bender_dynamic_hours_needed"
        unit_of_measurement: "h"
        icon: mdi:clock-outline
        state: >
          {% set required_kwh = states('input_number.bender_strategy_required_kwh') | float(0) %}
          {% set max_current = states('input_number.bender_strategy_max_current') | float(16) %}
          {% set voltage = 230 %}
          {% set charging_power_kw = (max_current * 3 * voltage) / 1000 %}
          {% if charging_power_kw > 0 %}
            {{ (required_kwh / charging_power_kw) | round(1) }}
          {% else %}
            0
          {% endif %}

      # Time remaining until departure
      - name: "Bender Dynamic Hours Until Departure"
        unique_id: "bender_dynamic_hours_until_departure"
        unit_of_measurement: "h"
        icon: mdi:clock-end
        state: >
          {% set departure = states('input_datetime.bender_strategy_departure_time') %}
          {% if departure not in ['unknown', 'unavailable', ''] %}
            {% set departure_ts = as_timestamp(departure) %}
            {% set now_ts = as_timestamp(now()) %}
            {% set hours_remaining = (departure_ts - now_ts) / 3600 %}
            {{ [hours_remaining, 0] | max | round(1) }}
          {% else %}
            0
          {% endif %}

      # Latest start time to meet departure deadline
      - name: "Bender Dynamic Latest Start"
        unique_id: "bender_dynamic_latest_start"
        icon: mdi:clock-alert
        state: >
          {% set hours_needed = states('sensor.bender_dynamic_hours_needed') | float(0) %}
          {% set departure = states('input_datetime.bender_strategy_departure_time') %}
          {% if departure not in ['unknown', 'unavailable', ''] and hours_needed > 0 %}
            {% set departure_ts = as_timestamp(departure) %}
            {% set start_ts = departure_ts - (hours_needed * 3600) %}
            {{ start_ts | timestamp_custom('%Y-%m-%d %H:%M', true) }}
          {% else %}
            unknown
          {% endif %}

      # Active strategy display
      - name: "Bender Strategy Active"
        unique_id: "bender_strategy_active"
        icon: mdi:ev-station
        state: >
          {{ states('input_select.bender_charging_strategy') }}

      # Total current charging power
      - name: "Bender Charging Power Total"
        unique_id: "bender_charging_power_total"
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set l1 = states('sensor.bender_power_l1') | float(0) %}
          {% set l2 = states('sensor.bender_power_l2') | float(0) %}
          {% set l3 = states('sensor.bender_power_l3') | float(0) %}
          {{ (l1 + l2 + l3) | round(0) }}

  # Binary sensor for actual charging status based on real power reading
  - binary_sensor:
      - name: "Bender Charging Active"
        unique_id: "bender_charging_active"
        icon: mdi:ev-station
        device_class: power
        state: >
          {{ states('sensor.bender_totalpower') | float(0) > 0 }}

###########################################################################################################
# SCRIPTS
###########################################################################################################
script:
  set_bender_safe_current:
    alias: "Set Bender Safe Current"
    sequence:
      - service: modbus.write_register
        data:
          hub: modbus_hub
          slave: 1
          address: 131
          value: "{{ current | int }}"

  set_bender_hems_limit:
    alias: "Set Bender HEMS Limit"
    icon: mdi:home-lightning-bolt
    fields:
      current:
        description: "HEMS Limit in Ampère (0-32A)"
        example: "16"
    sequence:
      - service: modbus.write_register
        data:
          hub: modbus_hub
          slave: 1
          address: 1000
          value: "{{ current | int }}"

  bender_start_charging:
    alias: "Bender Start Laden (Max)"
    icon: mdi:play-circle
    sequence:
      - variables:
          max_config: "{{ states('input_number.bender_strategy_max_current') | int(16) }}"
          lb_enabled: "{{ is_state('input_boolean.bender_loadbalancer_enabled', 'on') }}"
          lb_limit: "{{ states('sensor.bender_loadbalancer_available_current') | float(16) }}"
          
          # Calculate final current:
          # If LB enabled: min(max_config, lb_limit, 16)
          # If LB disabled: min(max_config, 16)
          final_current: >
            {% set limit = 16 %}
            {% if lb_enabled %}
              {% set val = [max_config, lb_limit, limit] | min | int %}
            {% else %}
              {% set val = [max_config, limit] | min | int %}
            {% endif %}
            {{ 0 if val < 6 else val }}

      - service: script.set_bender_hems_limit
        data:
          current: "{{ final_current }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.bender_strategy_active_status
        data:
          value: "Laden op {{ final_current }}A (LB: {{ 'Aan' if lb_enabled else 'Uit' }})"

  bender_stop_charging:
    alias: "Bender Stop Laden"
    icon: mdi:stop-circle
    sequence:
      - service: script.set_bender_hems_limit
        data:
          current: 0
      - service: input_text.set_value
        target:
          entity_id: input_text.bender_strategy_active_status
        data:
          value: "Laden gestopt"

  bender_set_charging_current:
    alias: "Bender Stel Laadstroom In"
    icon: mdi:current-ac
    fields:
      current:
        description: "Laadstroom per fase in Ampère"
        example: 10
    sequence:
      - variables:
          requested_current: "{{ current | int }}"
          lb_enabled: "{{ is_state('input_boolean.bender_loadbalancer_enabled', 'on') }}"
          lb_limit: "{{ states('sensor.bender_loadbalancer_available_current') | float(16) }}"
          
          # Calculate safe current:
          # If LB enabled: min(requested, lb_limit, 16)
          # If LB disabled: min(requested, 16)
          safe_current: >
            {% set limit = 16 %}
            {% if lb_enabled %}
              {{ [requested_current, lb_limit, limit] | min | int }}
            {% else %}
              {{ [requested_current, limit] | min | int }}
            {% endif %}

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ safe_current >= 6 }}"
            sequence:
              - service: script.set_bender_hems_limit
                data:
                  current: "{{ safe_current }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.bender_strategy_active_status
                data:
                  value: "Laden op {{ safe_current }}A (LB: {{ 'Aan' if lb_enabled else 'Uit' }})"
        default:
          - service: script.bender_stop_charging